<!DOCTYPE html>
<html lang="hi" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>मल्टी-रिटेलर बिलिंग</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style id="dynamic-print-style"></style>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #fff;
            --text-color: #2c3e50;
            --border-color: #ccc;
            --input-bg: #fff;
            --primary-color: #3498db;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --input-bg: #2c2c2c;
            --primary-color: #4a90e2;
            --shadow-color: rgba(255,255,255,0.1);
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        [dir="rtl"] label, [dir="rtl"] h4, [dir="rtl"] p, [dir="rtl"] h5 { text-align: right; }
        [dir="rtl"] .bill-summary-row { justify-content: flex-end; }
        [dir="rtl"] .bill-summary-row span:first-child { margin-left: 10px; }
        [dir="rtl"] .bill-summary-row span:last-child { margin-left: 0; margin-right: auto; }
        [dir="rtl"] .forgot-password { text-align: left; }
        .container { max-width: 1100px; margin: 20px auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
        .form-container { max-width: 500px; }
        .hidden { display: none; }
        h1, h2, h3, h4 { color: var(--text-color); text-align: center; margin-top: 0; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        h4, h5 { text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; text-align: left; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color); }
        button { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .action-button { width: auto; padding: 5px 10px; font-size: 14px; margin-right: 5px; }
        .action-button.edit { background-color: #f39c12; }
        .action-button.delete { background-color: #e74c3c; }
        .action-button.view { background-color: #27ae60; }
        .action-button.print { background-color: #9b59b6; }
        .app-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-link.active { border-bottom-color: var(--primary-color); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .main-layout { display: grid; gap: 30px; grid-template-columns: 1fr 1.5fr; }
        .customer-details-grid { display: grid; gap: 20px; grid-template-columns: 1fr 1fr; }
        @media (max-width: 768px) { .main-layout, .profile-layout, .customer-details-grid { grid-template-columns: 1fr; } }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .data-table th, .data-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--container-bg); margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; font-family: 'Segoe UI', sans-serif; border-radius: 8px; }
        body.dark-mode .modal-content { border-color: #555; }
        .bill-summary-row { display: flex; justify-content: space-between; font-size: 1.1em; padding: 5px 0; }
        .bill-summary-row.grand-total { font-weight: bold; font-size: 1.3em; border-top: 2px solid var(--text-color); margin-top: 10px; padding-top: 10px;}
        .search-container { position: relative; }
        .search-results { position: absolute; width: 100%; border: 1px solid var(--border-color); background-color: var(--container-bg); z-index: 99; max-height: 200px; overflow-y: auto; }
        .search-item { padding: 10px; cursor: pointer; } .search-item:hover { background-color: rgba(0,0,0,0.1); }
        body.dark-mode .search-item:hover { background-color: rgba(255,255,255,0.1); }
        .history-item { border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .history-item-actions button { width: auto; font-size: 12px; padding: 6px 10px; margin-top: 5px; margin-right: 10px; }
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: flex-end; margin-left: 20px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .backup-container { padding: 20px; text-align: center; border: 2px dashed var(--border-color); border-radius: 8px; }
        .backup-container button { width: auto; max-width: 250px; }
        .report-section { border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .report-section button { width: auto; font-size: 14px; padding: 8px 15px; margin-right: 10px; }
        .forgot-password { text-align: right; margin-top: -10px; margin-bottom: 15px; }
        .forgot-password a { color: var(--primary-color); text-decoration: none; font-size: 0.9em; }
        .purchase-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: flex-end;}
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .dashboard-card { background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px var(--shadow-color); text-align: center; }
        .dashboard-card h5 { border: none; font-size: 1.1em; }
        .dashboard-card p { font-size: 1.8em; font-weight: bold; margin: 10px 0 0 0; }
        .dashboard-card .profit { color: #27ae60; }
        .dashboard-card .loss { color: #e74c3c; }
        #image-to-crop { display: block; max-width: 100%; }
        /* प्रिंट प्रीव्यू मोडल स्टाइल्स */
        #print-preview-content { border: 1px solid var(--border-color); padding: 10px; margin-top: 15px; overflow: auto; resize: vertical; min-height: 200px; max-height: 50vh; background-color: var(--bg-color); }
        .print-options { display: flex; justify-content: center; gap: 20px; margin: 15px 0; align-items: center; }
        .print-options label { margin: 0; display: flex; align-items: center; gap: 5px; }
        .preview-a4 { width: 100%; height: auto; }
        .preview-80mm { width: 80mm; margin: 0 auto; }
        .preview-58mm { width: 58mm; margin: 0 auto; }
        .chart-container { background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px var(--shadow-color); }
        
        .dashboard-top-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .dashboard-top-charts .chart-container {
            height: 280px;
            display: flex;
            flex-direction: column;
        }
        .dashboard-top-charts .chart-container canvas {
            flex-grow: 1;
            min-height: 0;
            max-height: 100%;
        }
        .dashboard-grid, .top-products-container {
            margin-top: 30px;
        }

        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .radio-group label { font-weight: normal; }
        #purchase-tab, #purchase-tab input, #purchase-tab select, #purchase-tab textarea { font-family: 'Segoe UI', sans-serif; }
        .profile-image-upload { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin-top: 10px; }
        .profile-image-upload img { max-width: 150px; max-height: 80px; border: 1px solid var(--border-color); padding: 5px; }
        #item-details-calculator, #purchase-item-calculator { border: 1px solid var(--border-color); padding: 15px; margin-top: 15px; border-radius: 5px; }
        .item-calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-calc-grid label { margin-bottom: 5px; }
        .item-calc-grid input { margin-bottom: 5px; }

        /* Profile Sidebar Styles */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
        }
        .sidebar {
            position: fixed;
            top: 0;
            right: -450px; /* Start off-screen */
            width: 400px;
            max-width: 90%;
            height: 100%;
            background-color: var(--container-bg);
            box-shadow: -2px 0 8px rgba(0,0,0,0.15);
            z-index: 1002;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
            padding: 20px;
            padding-top: 50px; /* Space for close button */
            box-sizing: border-box;
        }
        .sidebar.open {
            right: 0; /* Slide in */
        }
        .close-sidebar-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2.5rem;
            font-weight: bold;
            line-height: 1;
            color: var(--text-color);
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            width: auto;
            margin: 0;
        }
        .cashflow-in { color: #27ae60; font-weight: bold; }
        .cashflow-out { color: #e74c3c; font-weight: bold; }
        #sell-inventory-list-container { max-height: 400px; overflow-y: auto; margin-top: 20px; }

        @media print {
             body > *:not(.printable-area-for-print) { display: none !important; }
            .printable-area-for-print { display: block !important; position: absolute; left: 0; top: 0; margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div class="printable-area-for-print"></div>
    <!-- सभी पेज -->
    <div id="welcome-page" class="container form-container">
        <div style="text-align: center;">
            <img src="logo.png" alt="App Logo" style="max-width: 150px; margin-bottom: 20px;">
        </div>
        <h2 style="border:none;">Welcome Billing App</h2>
        <div style="text-align:center;">
            <button id="goToLoginBtn" data-lang-key="login">लॉगिन करें</button>
            <button id="goToSignUpBtn" data-lang-key="createAccount">नया अकाउंट बनाएं</button>
        </div>
    </div>
    <div id="signup-page" class="container form-container hidden"><button class="back-btn" id="signupBackBtn" data-lang-key="back">← वापस</button><h2 data-lang-key="createAccount">नया अकाउंट बनाएं</h2><form id="signupForm"><label data-lang-key="shopNameLabel">दुकान का नाम:</label><input type="text" id="signupShopName" required><label data-lang-key="emailLabel">ईमेल:</label><input type="email" id="signupEmail" required><label data-lang-key="mobileLabel">मोबाइल:</label><input type="tel" id="signupPhone" required><label data-lang-key="passwordLabel">पासवर्ड:</label><input type="password" id="signupPassword" required><button type="submit" data-lang-key="signUp">साइन अप</button></form></div>
    <div id="login-page" class="container form-container hidden"><button class="back-btn" id="loginBackBtn" data-lang-key="back">← वापस</button><h2 data-lang-key="login">लॉगिन करें</h2><form id="loginForm"><label data-lang-key="emailOrMobileLabel">ईमेल या मोबाइल:</label><input type="text" id="loginIdentifier" required><label data-lang-key="passwordLabel">पासवर्ड:</label><input type="password" id="loginPassword" required><div class="forgot-password"><a href="#" id="forgotPasswordLink" data-lang-key="forgotPassword">पासवर्ड भूल गए?</a></div><button type="submit" data-lang-key="login">लॉगिन करें</button></form></div>
    
    <div id="reset-password-page" class="container form-container hidden">
        <button class="back-btn" id="resetBackBtn" data-lang-key="back">← वापस</button>
        <h2 data-lang-key="resetPasswordTitle">पासवर्ड रीसेट करें</h2>
        <form id="resetPasswordForm">
            <p data-lang-key="enterRegisteredEmail" style="text-align:left; border:none; margin-bottom:10px; font-size:0.9em;">अपना पंजीकृत ईमेल दर्ज करें।</p>
            <label data-lang-key="emailLabel">ईमेल:</label>
            <input type="email" id="resetEmail" required>
            <button type="button" id="verifyEmailBtn" data-lang-key="verifyEmail">ईमेल सत्यापित करें</button>
            <div id="newPasswordSection" class="hidden" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top:20px;">
                <p data-lang-key="enterRegisteredMobile" style="text-align:left; border:none; margin-bottom:10px; font-size:0.9em;">पहचान सत्यापित करने के लिए अपना पंजीकृत मोबाइल नंबर दर्ज करें।</p>
                <label data-lang-key="mobileLabel">मोबाइल:</label>
                <input type="tel" id="resetPhone" required>
                <label data-lang-key="newPassword">नया पासवर्ड:</label>
                <input type="password" id="resetNewPassword" required>
                <label data-lang-key="confirmPassword">पासवर्ड की पुष्टि करें:</label>
                <input type="password" id="resetConfirmPassword" required>
                <button type="submit" id="resetPasswordBtn" data-lang-key="resetPasswordBtnText">पासवर्ड रीसेट करें</button>
            </div>
        </form>
    </div>

    <!-- मुख्य एप्लीकेशन -->
    <div id="main-app" class="container hidden">
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
            <select id="language-select" style="width: auto; padding: 5px; margin-right: 15px;">
                <option value="hi">हिंदी</option>
                <option value="en">English</option>
                <option value="ur">اردو</option>
            </select>
            <button id="headerSettingsBtn" title="Settings" style="width: auto; margin-left: 20px; background: transparent; border: none; cursor: pointer; padding: 5px; line-height: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="var(--text-color)"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </div>
        <h2 id="retailerShopName"></h2>
        <hr>
        <div class="app-tabs" id="appTabsContainer">
            <span class="tab-link active" data-tab="dashboard" data-lang-key="dashboardTab">डैशबोर्ड</span>
            <span class="tab-link" data-tab="sell" data-lang-key="sellTab">बिक्री</span>
            <span class="tab-link" data-tab="purchase" data-lang-key="purchaseTab">खरीद</span>
            <span class="tab-link" data-tab="inventory" data-lang-key="inventoryTab">इन्वेंटरी</span>
            <span class="tab-link" data-tab="cashflow" data-lang-key="cashFlowTab">कैश फ्लो</span>
            <span class="tab-link" data-tab="expenses" data-lang-key="expensesTab">खर्चे</span>
            <span class="tab-link" data-tab="suppliers" data-lang-key="suppliersTab">आपूर्तिकर्ता</span>
            <span class="tab-link" data-tab="customers" data-lang-key="customersTab">ग्राहक</span>
            <span class="tab-link" data-tab="reports" data-lang-key="reportsTab">रिपोर्ट्स</span>
            <span class="tab-link" data-tab="profile" data-lang-key="profileTab">प्रोफ़ाइल</span>
            <span class="tab-link" data-tab="backup" data-lang-key="backupRestoreTab">बैकअप/रिस्टोर</span>
        </div>
        
        <!-- डैशबोर्ड टैब -->
        <div id="dashboard-tab" class="tab-content active">
             <div class="dashboard-top-charts">
                 <div class="chart-container">
                    <h4 data-lang-key="salesReportTitle">बिक्री</h4>
                     <canvas id="salesChart"></canvas>
                 </div>
                 <div class="chart-container">
                    <h4 data-lang-key="purchaseReportTitle">खरीद</h4>
                     <canvas id="purchaseChart"></canvas>
                 </div>
                 <div class="chart-container">
                     <h4 data-lang-key="profitAndLoss">लाभ और हानि</h4>
                     <canvas id="profitLossChart"></canvas>
                 </div>
            </div>
             <div class="dashboard-grid">
                <div class="dashboard-card"><h5 data-lang-key="totalSales">कुल बिक्री</h5><p style="color: #27ae60;" id="totalSalesDisplay">₹0.00</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalPurchases">कुल खरीद</h5><p style="color: #e74c3c;" id="totalPurchasesDisplay">₹0.00</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalExpenses">कुल खर्च</h5><p class="loss" id="totalExpensesDisplay">₹0.00</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalBillsGenerated">कुल बिल</h5><p id="totalBillsDisplay">0</p></div>
            </div>
             <div class="chart-container top-products-container">
                <h4 data-lang-key="topSellingProducts">सबसे ज्यादा बिकने वाले उत्पाद</h4>
                <table class="data-table"><thead><tr><th data-lang-key="productColumn">उत्पाद</th><th data-lang-key="quantitySold">बिकी हुई मात्रा</th></tr></thead><tbody id="topSellingTableBody"></tbody></table>
            </div>
        </div>
        
        <!-- सेल टैब (UPDATED) -->
        <div id="sell-tab" class="tab-content">
             <div class="main-layout">
                <div>
                    <h4 data-lang-key="customerDetails">ग्राहक का विवरण</h4>
                    <form id="customerDetailsForm">
                        <div class="customer-details-grid">
                            <div class="search-container"><label data-lang-key="customerName">ग्राहक का नाम:</label><input type="text" id="billingCustomerName" autocomplete="off"><div id="customerSearchResultsContainer" class="search-results hidden"></div></div>
                            <div><label data-lang-key="customerPhone">ग्राहक का फ़ोन:</label><input type="tel" id="billingCustomerPhone" required></div>
                        </div>
                        <label data-lang-key="customerAddress">ग्राहक का पता:</label><textarea id="billingCustomerAddress" rows="1"></textarea>
                    </form>
                    <hr style="margin:20px 0;">
                    <h4 data-lang-key="addItem">आइटम जोड़ें</h4>
                     <div class="radio-group">
                        <label><input type="radio" name="itemType" value="product" checked> <span data-lang-key="product">उत्पाद</span></label>
                        <label><input type="radio" name="itemType" value="service"> <span data-lang-key="service">सर्विस</span></label>
                    </div>
                    <div id="product-fields">
                         <div class="search-container"><label data-lang-key="addProductLabel">उत्पाद खोजें:</label><input type="text" id="productSearchInput" autocomplete="off"><div id="searchResultsContainer" class="search-results hidden"></div></div>
                         <div id="item-details-calculator" class="hidden">
                             <h5 id="calculatorProductName"></h5>
                             <div class="item-calc-grid">
                                <div><label data-lang-key="quantity">मात्रा:</label><input type="number" id="calcQuantity" value="1" min="0.01" step="0.01"></div>
                                <div><label data-lang-key="unitLabel">इकाई:</label><input type="text" id="calcUnit" readonly></div>
                                <div><label data-lang-key="basePrice">बेस प्राइस (₹):</label><input type="number" id="calcBasePrice" min="0" step="0.01"></div>
                                <div><label data-lang-key="gstPercent">GST (%):</label><input type="number" id="calcGstPercent" min="0" step="0.01" value="0"></div>
                             </div>
                             <div><label data-lang-key="totalPrice">कुल मूल्य/इकाई (₹):</label><input type="number" id="calcTotalPrice" min="0" step="0.01"></div>
                             <p><strong><span data-lang-key="lineTotal">कुल:</span> ₹<span id="calcLineTotal">0.00</span></strong></p>
                             <button type="button" id="addItemToBillBtn" data-lang-key="addToBill">बिल में जोड़ें</button>
                         </div>
                    </div>
                     <div id="service-fields" class="hidden">
                         <label data-lang-key="serviceDescription">सर्विस विवरण:</label><input type="text" id="serviceDescriptionInput">
                         <label data-lang-key="serviceCharge">सर्विस चार्ज (₹):</label><input type="number" id="serviceChargeInput" min="0">
                         <div class="radio-group" style="margin-bottom: 10px;">
                            <label><input type="radio" name="serviceGstType" value="without_gst" checked> <span data-lang-key="withoutGst">बिना GST</span></label>
                            <label><input type="radio" name="serviceGstType" value="with_gst"> <span data-lang-key="withGst">GST सहित</span></label>
                         </div>
                         <div id="service-gst-field-container" class="hidden" style="margin-bottom: 15px;">
                            <label data-lang-key="gstPercent">GST (%):</label>
                            <input type="number" id="serviceGstPercent" min="0" step="0.01" value="0">
                         </div>
                        <button type="button" id="addServiceToBillBtn" data-lang-key="addToBill">बिल में जोड़ें</button>
                    </div>

                    <div id="sell-inventory-list-container">
                        <h4 data-lang-key="fullInventoryList">पूरी इन्वेंटरी सूची</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th data-lang-key="productColumn">उत्पाद</th>
                                    <th data-lang-key="inStock">स्टॉक में</th>
                                    <th data-lang-key="priceColumn">मूल्य</th>
                                    <th data-lang-key="actionColumn">एक्शन</th>
                                </tr>
                            </thead>
                            <tbody id="sellInventoryTableBody"></tbody>
                        </table>
                    </div>

                </div>
                <div>
                    <h4 data-lang-key="currentBill">वर्तमान बिल</h4>
                    <table class="data-table"><thead><tr><th data-lang-key="productColumn">उत्पाद/सर्विस</th><th data-lang-key="quantityColumn">मात्रा</th><th data-lang-key="priceColumn">मूल्य</th><th data-lang-key="totalColumn">कुल</th></tr></thead><tbody id="currentBillBody"></tbody></table>
                    <div style="text-align:right; margin-top:15px;" id="billSummary">
                        <div class="bill-summary-row"><span data-lang-key="subTotal">उप-योग (Subtotal):</span><span>₹<span id="subTotalDisplay">0.00</span></span></div>
                        <div class="bill-summary-row"><span data-lang-key="totalGst">कुल GST:</span><span>+ ₹<span id="totalGstDisplay">0.00</span></span></div>
                        <div class="bill-summary-row" style="align-items:center;"><label for="discountInput" style="margin:0; text-align:right; margin-right:10px;" data-lang-key="discount">डिस्काउंट:</label><div style="display:flex; width: 60%;"><input type="number" id="discountInput" style="width: 70%; margin:0;" value="0"><select id="discountType" style="width: 30%; margin:0; padding:10px 5px;"><option value="percent">%</option><option value="fixed">₹</option></select></div></div>
                        <div class="bill-summary-row grand-total"><span data-lang-key="grandTotal">कुल देय:</span><span>₹<span id="grandTotalDisplay">0.00</span></span></div>
                    </div>
                    <button id="generateBillBtn" style="margin-top: 20px;" data-lang-key="generateBill">बिल बनाएं</button>
                </div>
            </div>
        </div>
        
        <!-- खरीद टैब -->
        <div id="purchase-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="purchaseEntryTitle">नई खरीद प्रविष्टि</h4>
                    <form id="addPurchaseItemForm">
                         <h5 data-lang-key="supplierDetails" style="border:none;">आपूर्तिकर्ता विवरण</h5>
                         <div class="customer-details-grid">
                            <div class="search-container">
                                <label data-lang-key="supplierName">आपूर्तिकर्ता का नाम:</label>
                                <input type="text" id="purchaseSupplierName" required autocomplete="off">
                                <div id="supplierPurchaseSearchResultsContainer" class="search-results hidden"></div>
                            </div>
                            <div>
                                <label data-lang-key="supplierPhone">आपूर्तिकर्ता का फ़ोन:</label>
                                <input type="tel" id="purchaseSupplierPhone" required>
                            </div>
                        </div>
                        <label data-lang-key="supplierAddressLabel">आपूर्तिकर्ता का पता:</label>
                        <textarea id="purchaseSupplierAddress" rows="1"></textarea>

                        <div class="purchase-form-grid">
                            <div>
                                <label data-lang-key="purchaseBillNo">खरीद बिल नंबर:</label>
                                <input type="text" id="purchaseBillNo">
                            </div>
                            <div>
                                <label data-lang-key="purchaseBillDate">बिल की तारीख:</label>
                                <input type="date" id="purchaseBillDate">
                            </div>
                        </div>

                        <hr style="margin:20px 0;">
                        <h5 data-lang-key="addProductToPurchase" style="border:none;">खरीद में उत्पाद जोड़ें</h5>
                        
                        <div class="purchase-form-grid">
                           <div>
                                <label data-lang-key="productName">उत्पाद का नाम</label>
                                <input type="text" id="purchaseProductName" required>
                           </div>
                           <div>
                                <label data-lang-key="hsnSac">HSN/SAC:</label>
                                <input type="text" id="purchaseHsnSac">
                           </div>
                        </div>
                        
                        <div id="purchase-item-calculator">
                            <h5 data-lang-key="purchasePriceDetails" style="border:none; margin-top:0;">खरीद मूल्य विवरण</h5>
                            <div class="radio-group" style="margin-bottom:10px;">
                                <label><input type="radio" name="gstType" value="without_gst" checked> <span data-lang-key="withoutGst">बिना GST</span></label>
                                <label><input type="radio" name="gstType" value="with_gst"> <span data-lang-key="withGst">GST सहित</span></label>
                            </div>
                            <div class="item-calc-grid">
                                <div>
                                    <label data-lang-key="basePrice">बेस प्राइस/यूनिट (₹)</label>
                                    <input type="number" id="purchaseBasePrice" required min="0.01" step="0.01">
                                </div>
                                <div id="gst-field-container" class="hidden">
                                    <label data-lang-key="gstPercent">GST (%)</label>
                                    <input type="number" id="purchaseGstPercent" min="0" step="0.01" value="0">
                                </div>
                            </div>
                            <div>
                                <label data-lang-key="totalPurchasePrice">कुल खरीद मूल्य/यूनिट (₹)</label>
                                <input type="number" id="purchaseTotalPrice" required min="0.01" step="0.01">
                            </div>

                            <hr style="margin:15px 0;">
                            <h5 data-lang-key="sellingPriceDetails" style="border:none;">बिक्री मूल्य विवरण</h5>
                            
                            <div class="purchase-form-grid" style="align-items: flex-end;">
                                <div>
                                    <label data-lang-key="profitMargin">लाभ मार्जिन</label>
                                    <input type="number" id="purchaseProfitMarginValue" value="0" min="0" step="0.01">
                                </div>
                                <div>
                                    <select id="purchaseProfitMarginType" style="margin-bottom: 0;">
                                        <option value="percent">%</option>
                                        <option value="fixed">₹</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label data-lang-key="sellingPriceLabel">बिक्री मूल्य/यूनिट (₹)</label>
                                <input type="number" id="purchaseSellingPrice" required min="0.01" step="0.01" readonly>
                            </div>
                        </div>

                        <div class="purchase-form-grid" style="margin-top:15px;">
                            <div>
                                <label data-lang-key="quantity">मात्रा</label>
                                <input type="number" id="purchaseQuantity" required min="0.01" step="0.01">
                            </div>
                            <div>
                                <label data-lang-key="unitLabel">इकाई</label>
                                <select id="purchaseUnit">
                                    <option>Pcs</option><option>Kg</option><option>Gm</option>
                                    <option>Ltr</option><option>Mtr</option>
                                </select>
                            </div>
                        </div>
                         <button type="submit" data-lang-key="addToPurchaseAndInventory" style="margin-top: 10px;">खरीद रिकॉर्ड करें और स्टॉक में जोड़ें</button>
                    </form>
                </div>
                <div>
                     <h4 data-lang-key="recentPurchases">हाल की खरीद</h4>
                     <p data-lang-key="selectSupplierToViewHistory" style="text-align:center; font-style:italic;">आपूर्तिकर्ता की सभी खरीद देखने के लिए 'आपूर्तिकर्ता' टैब पर जाएं।</p>
                     <div id="tabPurchaseHistoryContainer" style="max-height: 450px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- इन्वेंटरी टैब (UPDATED) -->
        <div id="inventory-tab" class="tab-content">
            <div id="inventoryToPrint">
                <h4 data-lang-key="currentStock">वर्तमान स्टॉक</h4>
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="productColumn">उत्पाद</th>
                                <th data-lang-key="purchasePrice">खरीद मूल्य</th>
                                <th data-lang-key="gst">GST</th>
                                <th data-lang-key="priceLabel">बिक्री मूल्य</th>
                                <th data-lang-key="margin">मार्जिन</th>
                                <th data-lang-key="inStock">स्टॉक में</th>
                                <th data-lang-key="actionColumn">एक्शन</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                    </table>
                </div>
                <div style="display:flex; gap:15px; margin-top:20px;" class="no-print">
                    <button id="printStockBtn" data-lang-key="printStock">स्टॉक प्रिंट करें</button>
                    <button id="saveStockPdfBtn" data-lang-key="saveAsPdf">PDF के रूप में सहेजें</button>
                </div>
            </div>
        </div>

        <!-- कैश फ्लो टैब (NEW) -->
        <div id="cashflow-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addCashFlowTitle">नई कैश एंट्री</h4>
                    <form id="addCashFlowForm">
                        <label data-lang-key="transactionType">लेन-देन का प्रकार:</label>
                        <select id="cashFlowType">
                            <option value="in" data-lang-key="cashIn">कैश-इन</option>
                            <option value="out" data-lang-key="cashOut">कैश-आउट</option>
                        </select>
                        <label data-lang-key="amountColumn">राशि (₹):</label>
                        <input type="number" id="cashFlowAmount" min="0.01" step="0.01" required>
                        <label data-lang-key="associatedParty">संबंधित पार्टी:</label>
                        <select id="cashFlowParty">
                            <option value="none">कोई नहीं</option>
                        </select>
                        <label data-lang-key="dateColumn">तारीख:</label>
                        <input type="date" id="cashFlowDate" required>
                        <label data-lang-key="notes">नोट्स:</label>
                        <textarea id="cashFlowNotes" rows="2"></textarea>
                        <button type="submit" data-lang-key="addEntry">एंट्री जोड़ें</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="cashFlowSummary">कैश फ्लो सारांश</h4>
                    <div class="dashboard-grid" style="margin-top:0;">
                        <div class="dashboard-card"><h5 data-lang-key="totalCashIn">कुल कैश-इन</h5><p class="cashflow-in" id="totalCashInDisplay">₹0.00</p></div>
                        <div class="dashboard-card"><h5 data-lang-key="totalCashOut">कुल कैश-आउट</h5><p class="cashflow-out" id="totalCashOutDisplay">₹0.00</p></div>
                        <div class="dashboard-card"><h5 data-lang-key="netBalance">नेट बैलेंस</h5><p id="netBalanceDisplay">₹0.00</p></div>
                    </div>
                    <h4 data-lang-key="cashFlowHistory" style="margin-top:20px;">कैश फ्लो इतिहास</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="dateColumn">तारीख</th>
                                <th data-lang-key="descriptionColumn">विवरण</th>
                                <th data-lang-key="amountColumn">राशि</th>
                            </tr>
                        </thead>
                        <tbody id="cashFlowTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- खर्च टैब -->
        <div id="expenses-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addExpenseTitle">नया खर्च जोड़ें</h4>
                    <form id="addExpenseForm">
                        <label data-lang-key="expenseDescription">खर्च का विवरण:</label>
                        <input type="text" id="expenseDescription" required>
                        <label data-lang-key="expenseAmount">राशि (₹):</label>
                        <input type="number" id="expenseAmount" min="0.01" step="0.01" required>
                         <label data-lang-key="expenseDate">खर्च की तारीख:</label>
                        <input type="date" id="expenseDate" required>
                        <button type="submit" data-lang-key="addExpenseBtn">खर्च जोड़ें</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="expenseListTitle">खर्चों की सूची</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="descriptionColumn">विवरण</th>
                                <th data-lang-key="amountColumn">राशि</th>
                                <th data-lang-key="dateColumn">तारीख</th>
                                <th data-lang-key="actionColumn">एक्शन</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="suppliers-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addSupplier">नया आपूर्तिकर्ता जोड़ें</h4>
                    <form id="addSupplierForm">
                        <label data-lang-key="supplierName">आपूर्तिकर्ता का नाम:</label>
                        <input type="text" id="supplierName" required>
                        <label data-lang-key="supplierPhone">आपूर्तिकर्ता का फ़ोन:</label>
                        <input type="tel" id="supplierPhone" required>
                        <label data-lang-key="supplierAddress">आपूर्तिकर्ता का पता:</label>
                        <textarea id="supplierAddress" rows="2"></textarea>
                        <label data-lang-key="gstinLabel">GST नंबर:</label>
                        <input type="text" id="supplierGstin">
                        <button type="submit" id="supplierSubmitBtn" data-lang-key="addSupplierBtn">आपूर्तिकर्ता जोड़ें</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="supplierList">आपूर्तिकर्ताओं की सूची</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="nameColumn">नाम</th>
                                <th data-lang-key="phoneColumn">फ़ोन</th>
                                <th data-lang-key="actionColumn">एक्शन</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="customers-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addCustomer">नया ग्राहक जोड़ें</h4>
                    <form id="addCustomerForm">
                        <label data-lang-key="customerName">ग्राहक का नाम:</label>
                        <input type="text" id="addCustomerName" required>
                        <label data-lang-key="customerPhone">ग्राहक का फ़ोन:</label>
                        <input type="tel" id="addCustomerPhone" required>
                        <label data-lang-key="customerAddress">ग्राहक का पता:</label>
                        <textarea id="addCustomerAddress" rows="2"></textarea>
                        <label data-lang-key="gstinLabel">GST नंबर:</label>
                        <input type="text" id="addCustomerGstin">
                        <button type="submit" id="customerSubmitBtn" data-lang-key="addCustomerBtn">ग्राहक जोड़ें</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="customerList">ग्राहकों की सूची</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="nameColumn">नाम</th>
                                <th data-lang-key="phoneColumn">फ़ोन</th>
                                <th data-lang-key="actionColumn">एक्शन</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="reports-tab" class="tab-content">
            <h4 data-lang-key="downloadReportsTitle">रिपोर्ट्स डाउनलोड करें</h4>
            <div class="report-section">
                <h5 data-lang-key="salesReportTitle">बिक्री रिपोर्ट</h5>
                <p data-lang-key="salesReportDesc" style="border:none; margin-bottom:15px; text-align:left;">एक तिथि सीमा के भीतर सभी बिलों की विस्तृत सूची डाउनलोड करें।</p>
                <div style="display: flex; flex-wrap:wrap; gap: 15px; align-items: center; margin-bottom: 15px;">
                     <label data-lang-key="fromDate" style="width:auto; margin-bottom:0;">से:</label>
                     <input type="date" id="salesReportFromDate" style="width:150px; margin-bottom:0;">
                     <label data-lang-key="toDate" style="width:auto; margin-bottom:0;">तक:</label>
                     <input type="date" id="salesReportToDate" style="width:150px; margin-bottom:0;">
                </div>
                <button id="downloadSalesPdfBtn" data-lang-key="downloadAsPdf">PDF में डाउनलोड करें</button>
                <button id="downloadSalesCsvBtn" data-lang-key="downloadAsCsv">CSV में डाउनलोड करें</button>
            </div>
             <div class="report-section">
                <h5 data-lang-key="purchaseReportTitle">खरीद रिपोर्ट</h5>
                <p data-lang-key="purchaseReportDesc" style="border:none; margin-bottom:15px; text-align:left;">एक तिथि सीमा के भीतर सभी खरीद की विस्तृत सूची डाउनलोड करें।</p>
                <div style="display: flex; flex-wrap:wrap; gap: 15px; align-items: center; margin-bottom: 15px;">
                     <label data-lang-key="fromDate" style="width:auto; margin-bottom:0;">से:</label>
                     <input type="date" id="purchaseReportFromDate" style="width:150px; margin-bottom:0;">
                     <label data-lang-key="toDate" style="width:auto; margin-bottom:0;">तक:</label>
                     <input type="date" id="purchaseReportToDate" style="width:150px; margin-bottom:0;">
                </div>
                <button id="downloadPurchasePdfBtn" data-lang-key="downloadAsPdf">PDF में डाउनलोड करें</button>
                <button id="downloadPurchaseCsvBtn" data-lang-key="downloadAsCsv">CSV में डाउनलोड करें</button>
            </div>
             <div class="report-section">
                <h5 data-lang-key="stockReportTitle">स्टॉक रिपोर्ट</h5>
                <p data-lang-key="stockReportDesc" style="border:none; margin-bottom:15px; text-align:left;">वर्तमान में उपलब्ध सभी उत्पादों की सूची डाउनलोड करें।</p>
                <button id="downloadStockReportPdfBtn" data-lang-key="downloadAsPdf">PDF में डाउनलोड करें</button>
                 <button id="downloadStockReportCsvBtn" data-lang-key="downloadAsCsv">CSV में डाउनलोड करें</button>
            </div>
             <div class="report-section">
                <h5 data-lang-key="customerListTitle">ग्राहक सूची रिपोर्ट</h5>
                <p data-lang-key="customerListDesc" style="border:none; margin-bottom:15px; text-align:left;">अपने सभी पंजीकृत ग्राहकों की सूची डाउनलोड करें।</p>
                <button id="downloadCustomersPdfBtn" data-lang-key="downloadAsPdf">PDF में डाउनलोड करें</button>
                 <button id="downloadCustomersCsvBtn" data-lang-key="downloadAsCsv">CSV में डाउनलोड करें</button>
            </div>
        </div>

        <div id="backup-tab" class="tab-content">
            <h4 data-lang-key="backupRestoreTitle">बैकअप और रिस्टोर</h4>
            <div class="backup-container">
                <p data-lang-key="backupInstructions">अपने सभी डेटा (उत्पाद, ग्राहक, बिल आदि) को एक फ़ाइल के रूप में डाउनलोड करने के लिए 'बैकअप बनाएं' पर क्लिक करें। इस फ़ाइल को सुरक्षित रखें। डेटा वापस पाने के लिए 'बैकअप से रिस्टोर करें' का उपयोग करें।</p>
                <button id="createBackupBtn" data-lang-key="createBackup">बैकअप बनाएं</button>
                <button id="restoreBackupBtn" style="background-color: #27ae60;" data-lang-key="restoreBackup">बैकअप से रिस्टोर करें</button>
                <input type="file" id="restoreFileInput" class="hidden" accept=".json">
            </div>
        </div>

        <!-- Profile Sidebar -->
        <div id="sidebar-overlay" class="hidden"></div>
        <div id="profile-sidebar" class="sidebar">
            <button id="closeProfileSidebarBtn" class="close-sidebar-btn">×</button>
            <div class="profile-layout" style="grid-template-columns: 1fr; gap: 30px;">
                <div>
                    <h4 data-lang-key="shopDetails">दुकान का विवरण</h4>
                    <label data-lang-key="shopNameLabel">दुकान का नाम:</label><input type="text" id="profileShopName">
                    <label data-lang-key="shopAddressLabel">दुकान का पता:</label><textarea id="profileAddress" rows="3"></textarea>
                    <label data-lang-key="phoneNumLabel">फ़ोन नंबर:</label><input type="tel" id="profilePhone">
                    <label data-lang-key="emailIdLabel">ईमेल आईडी:</label><input type="email" id="profileEmail" readonly>
                    <label data-lang-key="gstinLabel">जीएसटी नंबर:</label><input type="text" id="profileGstin">
                </div>
                <div>
                    <h4 data-lang-key="paymentAndLogo">भुगतान और लोगो</h4>
                    <label>UPI ID:</label><input type="text" id="profileUpiId" placeholder="yourname@bank" data-lang-key="upiPlaceholder">
                    <div class="profile-image-upload">
                        <label data-lang-key="shopLogoLabel">दुकान का लोगो:</label>
                        <input type="file" class="image-upload-input" id="logoUpload" data-target="logo" accept="image/jpeg,image/png">
                        <img id="logoPreview" src="" alt="Logo Preview">
                    </div>
                     <div class="profile-image-upload">
                        <label data-lang-key="signature">हस्ताक्षर:</label>
                        <input type="file" class="image-upload-input" id="signatureUpload" data-target="signature" accept="image/jpeg,image/png">
                        <img id="signaturePreview" src="" alt="Signature Preview">
                    </div>
                     <div class="profile-image-upload">
                        <label data-lang-key="stamp">स्टाम्प:</label>
                        <input type="file" class="image-upload-input" id="stampUpload" data-target="stamp" accept="image/jpeg,image/png">
                        <img id="stampPreview" src="" alt="Stamp Preview">
                    </div>
                </div>
            </div>
            <div>
                <h4 data-lang-key="settingsTitle">सेटिंग्स</h4>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                    <label for="theme-toggle-sidebar" style="margin-bottom: 0;" data-lang-key="darkModeLabel">डार्क मोड</label>
                    <div class="theme-switch-wrapper" style="margin-left: 0;">
                        <label class="theme-switch" for="theme-toggle-sidebar">
                            <input type="checkbox" id="theme-toggle-sidebar">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <button id="saveProfileBtn" style="margin-top:20px;" data-lang-key="saveProfile">प्रोफ़ाइल सेव करें</button>
            <button id="logoutBtnSidebar" style="margin-top:10px; background-color: #e74c3c;" data-lang-key="logout">लॉगआउट</button>
        </div>
    </div>
    
    <!-- बिल मोडल -->
    <div id="bill-modal" class="modal"><div class="modal-content"><div class="printable-area" id="bill-to-print-container"></div>
        <div id="ad-placeholder-in-modal" style="text-align:center; margin: 15px 0;"></div>
    <div class="modal-buttons no-print" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        <button id="sendWhatsAppBtn" title="WhatsApp पर भेजें" style="background-color:#25D366; padding: 8px; line-height: 1; width:auto;">
            <svg fill="white" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.523.074-.797.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.203 5.076 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
        </button>
        <button id="shareBillImageBtn" style="background-color:#f39c12; width:auto;" data-lang-key="shareAsImage">इमेज शेयर करें</button>
        <button id="printBillBtn" style="background-color:#27ae60; width:auto;" data-lang-key="printBill">बिल प्रिंट करें</button>
        <button id="closeBillModalBtn" style="background-color:#e74c3c; width:auto;" data-lang-key="close">बंद करें</button>
    </div></div></div>
    <div id="history-modal" class="modal"><div class="modal-content" style="max-width:600px;"><h3 id="history-modal-title">इतिहास</h3><div id="historyContainer" style="max-height: 400px; overflow-y: auto;"></div><button id="closeHistoryModalBtn" style="margin-top:20px; background-color:#e74c3c;" data-lang-key="close">बंद करें</button></div></div>
    
    <!-- प्रिंट प्रीव्यू मोडल -->
    <div id="print-preview-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h4 data-lang-key="printPreviewTitle">प्रिंट प्रीव्यू</h4>
            <div class="print-options">
                <strong data-lang-key="paperSize">पेपर साइज:</strong>
                <label><input type="radio" name="paper-size" value="a4" checked> A4</label>
                <label><input type="radio" name="paper-size" value="80mm"> 80mm</label>
                <label><input type="radio" name="paper-size" value="58mm"> 58mm</label>
            </div>
            <div id="print-preview-content" class="preview-a4"></div>
            <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                <button id="execute-print-btn" data-lang-key="printNow" style="width: auto;">अभी प्रिंट करें</button>
                <button id="close-print-preview-btn" style="background-color:#e74c3c; width: auto;" data-lang-key="cancel">रद्द करें</button>
            </div>
        </div>
    </div>

    <!-- लोगो क्रॉप मोडल -->
    <div id="cropper-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h4 data-lang-key="cropImageTitle">लोगो क्रॉप करें</h4>
            <div>
                <img id="image-to-crop" src="" style="max-width: 100%;">
            </div>
            <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                <button id="crop-and-save-btn" data-lang-key="cropBtn" style="width: auto;">क्रॉप करें और सेव करें</button>
                <button id="close-cropper-modal-btn" style="background-color:#e74c3c; width: auto;" data-lang-key="cancel">रद्द करें</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 20px; font-family: 'Segoe UI', sans-serif; color: var(--text-color);">
        Powered by Upendra K Chaudhary
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- अनुवाद ऑब्जेक्ट ---
    const translations = {
        'hi': {
            welcomeTitle: "Welcome Billing App", login: "लॉगिन करें", createAccount: "नया अकाउंट बनाएं", back: "← वापस",
            shopNameLabel: "दुकान का नाम:", emailLabel: "ईमेल:", mobileLabel: "मोबाइल:", passwordLabel: "पासवर्ड:",
            signUp: "साइन अप", emailOrMobileLabel: "ईमेल या मोबाइल:", logout: "लॉगआउट", 
            dashboardTab: "डैशबोर्ड", 
            sellTab: "बिक्री", purchaseTab: "खरीद", inventoryTab: "इन्वेंटरी", expensesTab: "खर्चे", 
            customersTab: "ग्राहक", suppliersTab: "आपूर्तिकर्ता", profileTab: "प्रोफ़ाइल", backupRestoreTab: "बैकअप/रिस्टोर",
            reportsTab: "रिपोर्ट्स", customerDetails: "ग्राहक का विवरण", customerName: "ग्राहक का नाम:", customerPhone: "ग्राहक का फ़ोन:", customerAddress: "ग्राहक का पता:",
            addItem: "आइटम जोड़ें", addProductLabel: "उत्पाद खोजें:", quantity: "मात्रा:", addToBill: "बिल में जोड़ें",
            currentBill: "वर्तमान बिल", productColumn: "उत्पाद", quantityColumn: "मात्रा", priceColumn: "मूल्य", totalColumn: "कुल",
            rateColumn: "दर", subTotal: "उप-योग (Subtotal):", discount: "डिस्काउंट:", gst: "GST", grandTotal: "कुल देय:",
            generateBill: "बिल बनाएं", addProduct: "नया उत्पाद जोड़ें / अपडेट करें", productName: "उत्पाद का नाम:", priceLabel: "बिक्री मूल्य",
            unitLabel: "इकाई:", stockQuantity: "स्टॉक मात्रा:", addToStock: "स्टॉक में जोड़ें", currentStock: "वर्तमान स्टॉक",
            inStock: "स्टॉक में", printStock: "स्टॉक प्रिंट करें", saveAsPdf: "PDF के रूप में सहेजें", customerList: "ग्राहकों की सूची",
            nameColumn: "नाम", phoneColumn: "फ़ोन", actionColumn: "एक्शन", historyBtn: "इतिहास", shopDetails: "दुकान का विवरण",
            shopAddressLabel: "दुकान का पता:", phoneNumLabel: "फ़ोन नंबर:", emailIdLabel: "ईमेल आईडी:",
            paymentAndLogo: "भुगतान और लोगो", upiPlaceholder: "yourname@bank", shopLogoLabel: "दुकान का लोगो:",
            saveProfile: "प्रोफ़ाइल सेव करें", sendOnWhatsApp: "WhatsApp पर भेजें", printBill: "बिल प्रिंट करें",
            shareAsImage: "इमेज शेयर करें", newBill: "नया बिल", purchaseHistoryOf: "का खरीद इतिहास", salesHistoryOf: "का बिक्री इतिहास", close: "बंद करें",
            invalidCredentials: "गलत क्रेडेंशियल।", emailExists: "यह ईमेल आईडी पहले से पंजीकृत है।", signupSuccess: "साइन अप सफल!",
            fillAllFields: "कृपया सभी फ़ील्ड में सही जानकारी दर्ज करें।", productAddedSuccess: "उत्पाद सफलतापूर्वक जोड़ा गया!",
            productUpdatedSuccess: "उत्पाद सफलतापूर्वक अपडेट किया गया!", quantityUpdatedSuccess: "उत्पाद की मात्रा अपडेट कर दी गई है!",
            selectProductFromList: "कृपया सूची से एक उत्पाद चुनें।", stockUnavailable: "स्टॉक में केवल {quantity} {unit} उपलब्ध है!",
            addItemsToBill: "बिल बनाने के लिए आइटम जोड़ें।", customerInfoRequired: "बिल बनाने के लिए ग्राहक का नाम और फ़ोन नंबर आवश्यक है।",
            profileSaved: "प्रोफ़ाइल सेव हो गया!", noBillToShare: "शेयर करने के लिए कोई बिल नहीं है।", preparing: "तैयार हो रहा है...",
            imageCreationFailed: "इमेज बनाने में त्रुटि हुई।", imageDownloaded: "बिल की इमेज डाउनलोड हो गई है। कृपया इसे मैन्युअल रूप से साझा करें।",
            noPurchaseHistory: "इस आपूर्तिकर्ता के लिए कोई खरीद इतिहास नहीं मिला।", noSalesHistory: "इस ग्राहक के लिए कोई बिक्री इतिहास नहीं मिला।",
            billNo: "बिल नं:", date: "तारीख:", total: "कुल:", viewBill: "बिल देखें",
            stockReport: "स्टॉक रिपोर्ट", customer: "ग्राहक:", name: "नाम:", mobile: "मोबाइल:", subTotalBill: "उप-योग:", discountBill: "डिस्काउंट:",
            grandTotalBill: "कुल देय:", scanToPay: "भुगतान के लिए स्कैन करें", visitAgain: "Visit Again!", thanksForShopping: "खरीदारी के लिए धन्यवाद!",
            editBtn: "संपादित करें", deleteBtn: "हटाएं", updateBtn: "अपडेट करें", deleteConfirm: "क्या आप वाकई इस आइटम को हटाना चाहते हैं?",
            backupRestoreTitle: "बैकअप और रिस्टोर", backupInstructions: "अपने सभी डेटा (उत्पाद, ग्राहक, बिल आदि) को एक फ़ाइल के रूप में डाउनलोड करने के लिए 'बैकअप बनाएं' पर क्लिक करें। इस फ़ाइल को सुरक्षित रखें। डेटा वापस पाने के लिए 'बैकअप से रिस्टोर करें' का उपयोग करें।",
            createBackup: "बैकअप बनाएं", restoreBackup: "बैकअप से रिस्टोर करें", restoreConfirm: "क्या आप वाकई रिस्टोर करना चाहते हैं? यह सभी मौजूदा डेटा को ओवरराइट कर देगा।",
            backupSuccess: "बैकअप फ़ाइल सफलतापूर्वक बन गई है।", restoreSuccess: "डेटा सफलतापूर्वक रिस्टोर हो गया है।", invalidBackupFile: "अमान्य बैकअप फ़ाइल।",
            totalRevenue: "कुल राजस्व", totalBillsGenerated: "कुल बिल", currentStockValue: "वर्तमान स्टॉक मूल्य",
            topSellingProducts: "सबसे ज्यादा बिकने वाले उत्पाद", quantitySold: "बिकी हुई मात्रा",
            totalProfit: "कुल लाभ", totalExpenses: "कुल खर्च", netProfitLoss: "शुद्ध लाभ/हानि",
            downloadReportsTitle: "रिपोर्ट्स डाउनलोड करें", salesReportTitle: "बिक्री रिपोर्ट", stockReportTitle: "स्टॉक रिपोर्ट", customerListTitle: "ग्राहक सूची रिपोर्ट",
            salesReportDesc: "एक तिथि सीमा के भीतर सभी बिलों की विस्तृत सूची डाउनलोड करें।", stockReportDesc: "वर्तमान में उपलब्ध सभी उत्पादों की सूची डाउनलोड करें।",
            customerListDesc: "अपने सभी पंजीकृत ग्राहकों की सूची डाउनलोड करें।", fromDate: "से:", toDate: "तक:", downloadAsPdf: "PDF में डाउनलोड करें",
            downloadAsCsv: "CSV में डाउनलोड करें", allBills: "सभी बिल", billDate: "बिल की तारीख", noDataFound: "चयनित सीमा के लिए कोई डेटा नहीं मिला।",
            forgotPassword: "पासवर्ड भूल गए?", resetPasswordTitle: "पासवर्ड रीसेट करें", verifyEmail: "ईमेल सत्यापित करें",
            enterRegisteredEmail: "अपना पंजीकृत ईमेल दर्ज करें।", enterRegisteredMobile: "पहचान सत्यापित करने के लिए अपना पंजीकृत मोबाइल नंबर दर्ज करें।",
            newPassword: "नया पासवर्ड", confirmPassword: "पासवर्ड की पुष्टि करें", resetPasswordBtnText: "पासवर्ड रीसेट करें",
            emailNotFound: "यह ईमेल पंजीकृत नहीं है।", verificationFailed: "मोबाइल नंबर मेल नहीं खाता।", passwordsDoNotMatch: "पासवर्ड मेल नहीं खाते।",
            passwordResetSuccess: "पासवर्ड सफलतापूर्वक रीसेट हो गया! अब आप लॉगिन कर सकते हैं।",
            addSupplier: "नया आपूर्तिकर्ता जोड़ें", supplierName: "आपूर्तिकर्ता का नाम:", supplierPhone: "आपूर्तिकर्ता का फ़ोन:",
            supplierAddress: "आपूर्तिकर्ता का पता:", addSupplierBtn: "आपूर्तिकर्ता जोड़ें", supplierList: "आपूर्तिकर्ताओं की सूची",
            viewPurchasesBtn: "खरीद देखें", confirmDeleteSupplier: "क्या आप वाकई इस आपूर्तिकर्ता को हटाना चाहते हैं?",
            purchaseEntryTitle: "नई खरीद प्रविष्टि", addProductToPurchase: "खरीद में उत्पाद जोड़ें", purchasePrice: "खरीद मूल्य",
            addToPurchaseAndInventory: "खरीद रिकॉर्ड करें और स्टॉक में जोड़ें", purchaseHistoryTitle: "आपूर्तिकर्ता का खरीद इतिहास", purchaseDate: "खरीद की तारीख",
            purchaseItems: "खरीदे गए आइटम", noPurchaseEntries: "इस आपूर्तिकर्ता के लिए कोई खरीद प्रविष्टि नहीं है।",
            gstinLabel: "GST नंबर:", gstinBill: "जीएसटी नंबर:",
            addCustomer: "नया ग्राहक जोड़ें", addCustomerBtn: "ग्राहक जोड़ें", customerAddedSuccess: "ग्राहक सफलतापूर्वक जोड़ा गया!",
            cropImageTitle: "लोगो क्रॉप करें", cropBtn: "क्रॉप करें और सेव करें", cancel: "रद्द करें",
            supplierDetails: "आपूर्तिकर्ता विवरण", basePrice: "बेस प्राइस/यूनिट (₹)", gstPercent: "GST (%):", recentPurchases: "हाल की खरीद",
            selectSupplierToViewHistory: "आपूर्तिकर्ता की सभी खरीद देखने के लिए 'आपूर्तिकर्ता' टैब पर जाएं।",
            addExpenseTitle: "नया खर्च जोड़ें", expenseDescription: "खर्च का विवरण:", expenseAmount: "राशि (₹):",
            expenseDate: "खर्च की तारीख:", addExpenseBtn: "खर्च जोड़ें", expenseListTitle: "खर्चों की सूची",
            descriptionColumn: "विवरण", amountColumn: "राशि", dateColumn: "तारीख", expenseAddedSuccess: "खर्च सफलतापूर्वक जोड़ा गया।",
            printPreviewTitle: "प्रिंट प्रीव्यू", paperSize: "पेपर साइज:", printNow: "अभी प्रिंट करें",
            totalSales: "कुल बिक्री", totalPurchases: "कुल खरीद", salesPurchaseChartTitle: "बिक्री और खरीद", profitAndLoss: "लाभ और हानि",
            product: "उत्पाद", service: "सर्विस", serviceDescription: "सर्विस विवरण:", serviceCharge: "सर्विस चार्ज (₹):",
            withoutGst: "बिना GST", withGst: "GST सहित", printPurchaseNote: "खरीद नोट प्रिंट करें",
            signature: "हस्ताक्षर:", stamp: "स्टाम्प:", authorizedSignatory: "अधिकृत हस्ताक्षरकर्ता",
            purchaseReportTitle: "खरीद रिपोर्ट", purchaseReportDesc: "एक तिथि सीमा के भीतर सभी खरीद की विस्तृत सूची डाउनलोड करें।", supplierAddressLabel: "आपूर्तिकर्ता का पता:",
            purchaseId: "खरीद आईडी", totalPrice: "कुल मूल्य/इकाई (₹):", lineTotal: "कुल:", sellingPriceLabel: "बिक्री मूल्य/यूनिट (₹)", totalGst: "कुल GST:", purchaseBillNo: "खरीद बिल नंबर:",
            settingsTitle: "सेटिंग्स", darkModeLabel: "डार्क मोड", purchaseBillDate: "बिल की तारीख:", hsnSac: "HSN/SAC:",
            purchasePriceDetails: "खरीद मूल्य विवरण", totalPurchasePrice: "कुल खरीद मूल्य/यूनिट (₹)", sellingPriceDetails: "बिक्री मूल्य विवरण", profitMargin: "मार्जिन",
            margin: "मार्जिन", fullInventoryList: "पूरी इन्वेंटरी सूची",
            cashFlowTab: "कैश फ्लो", addCashFlowTitle: "नई कैश एंट्री", transactionType: "लेन-देन का प्रकार", cashIn: "कैश-इन", cashOut: "कैश-आउट",
            associatedParty: "संबंधित पार्टी", notes: "नोट्स", addEntry: "एंट्री जोड़ें", cashFlowSummary: "कैश फ्लो सारांश",
            totalCashIn: "कुल कैश-इन", totalCashOut: "कुल कैश-आउट", netBalance: "नेट बैलेंस", cashFlowHistory: "कैश फ्लो इतिहास"
        },
        'en': {
            welcomeTitle: "Welcome Billing App", login: "Login", createAccount: "Create New Account", back: "← Back",
            shopNameLabel: "Shop Name:", emailLabel: "Email:", mobileLabel: "Mobile:", passwordLabel: "Password:",
            signUp: "Sign Up", emailOrMobileLabel: "Email or Mobile:", logout: "Logout",
            dashboardTab: "Dashboard",
            sellTab: "Sell", purchaseTab: "Purchase", inventoryTab: "Inventory", expensesTab: "Expenses",
            customersTab: "Customers", suppliersTab: "Suppliers", profileTab: "Profile", backupRestoreTab: "Backup/Restore",
            reportsTab: "Reports", customerDetails: "Customer Details", customerName: "Customer Name:", customerPhone: "Customer Phone:", customerAddress: "Customer Address:",
            addItem: "Add Item", addProductLabel: "Search Product:", quantity: "Quantity:", addToBill: "Add to Bill",
            currentBill: "Current Bill", productColumn: "Product", quantityColumn: "Quantity", priceColumn: "Price", totalColumn: "Total",
            rateColumn: "Rate", subTotal: "Subtotal:", discount: "Discount:", gst: "GST", grandTotal: "Grand Total:",
            generateBill: "Generate Bill", addProduct: "Add / Update Product", productName: "Product Name:", priceLabel: "Selling Price",
            unitLabel: "Unit:", stockQuantity: "Stock Quantity:", addToStock: "Add to Stock", currentStock: "Current Stock",
            inStock: "In Stock", printStock: "Print Stock", saveAsPdf: "Save as PDF", customerList: "Customer List",
            nameColumn: "Name", phoneColumn: "Phone", actionColumn: "Action", historyBtn: "History", shopDetails: "Shop Details",
            shopAddressLabel: "Shop Address:", phoneNumLabel: "Phone Number:", emailIdLabel: "Email ID:",
            paymentAndLogo: "Payment & Logo", upiPlaceholder: "yourname@bank", shopLogoLabel: "Shop Logo:",
            saveProfile: "Save Profile", sendOnWhatsApp: "Send on WhatsApp", printBill: "Print Bill",
            shareAsImage: "Share as Image", newBill: "New Bill", purchaseHistoryOf: "'s Purchase History", salesHistoryOf: "'s Sales History", close: "Close",
            invalidCredentials: "Invalid credentials.", emailExists: "This email ID is already registered.", signupSuccess: "Sign up successful!",
            fillAllFields: "Please enter correct information in all fields.", productAddedSuccess: "Product added successfully!",
            productUpdatedSuccess: "Product updated successfully!", quantityUpdatedSuccess: "Product quantity has been updated!",
            selectProductFromList: "Please select a product from the list.", stockUnavailable: "Only {quantity} {unit} available in stock!",
            addItemsToBill: "Add items to create a bill.", customerInfoRequired: "Customer name and phone number are required to generate a bill.",
            profileSaved: "Profile saved!", noBillToShare: "No bill to share.", preparing: "Preparing...",
            imageCreationFailed: "Error creating image.", imageDownloaded: "Bill image has been downloaded. Please share it manually.",
            noPurchaseHistory: "No purchase history found for this supplier.", noSalesHistory: "No sales history found for this customer.",
            billNo: "Bill No:", date: "Date:", total: "Total:", viewBill: "View Bill",
            stockReport: "Stock Report", customer: "Customer:", name: "Name:", mobile: "Mobile:", subTotalBill: "Subtotal:", discountBill: "Discount:",
            grandTotalBill: "Grand Total:", scanToPay: "Scan to Pay", visitAgain: "Visit Again!", thanksForShopping: "Thanks for shopping!",
            editBtn: "Edit", deleteBtn: "Delete", updateBtn: "Update", deleteConfirm: "Are you sure you want to delete this item?",
            backupRestoreTitle: "Backup & Restore", backupInstructions: "Click 'Create Backup' to download all your data. Use 'Restore from Backup' to recover your data.",
            createBackup: "Create Backup", restoreBackup: "Restore from Backup", restoreConfirm: "Are you sure you want to restore? This will overwrite all current data.",
            backupSuccess: "Backup file created successfully.", restoreSuccess: "Data restored successfully.", invalidBackupFile: "Invalid backup file.",
            totalRevenue: "Total Revenue", totalBillsGenerated: "Total Bills", currentStockValue: "Current Stock Value",
            topSellingProducts: "Top Selling Products", quantitySold: "Quantity Sold",
            totalProfit: "Total Profit", totalExpenses: "Total Expenses", netProfitLoss: "Net Profit/Loss",
            downloadReportsTitle: "Download Reports", salesReportTitle: "Sales Report", stockReportTitle: "Stock Report", customerListTitle: "Customer List Report",
            salesReportDesc: "Download a detailed list of all bills within a date range.", stockReportDesc: "Download a list of all products currently in stock.",
            customerListDesc: "Download a list of all your registered customers.", fromDate: "From:", toDate: "To:", downloadAsPdf: "Download as PDF",
            downloadAsCsv: "Download as CSV", allBills: "All Bills", billDate: "Bill Date", noDataFound: "No data found for the selected range.",
            forgotPassword: "Forgot Password?", resetPasswordTitle: "Reset Password", verifyEmail: "Verify Email",
            enterRegisteredEmail: "Enter your registered email.", enterRegisteredMobile: "Enter your registered mobile number to verify.",
            newPassword: "New Password", confirmPassword: "Confirm Password", resetPasswordBtnText: "Reset Password",
            emailNotFound: "This email is not registered.", verificationFailed: "Mobile number does not match.", passwordsDoNotMatch: "Passwords do not match.",
            passwordResetSuccess: "Password reset successfully! You can now log in.",
            addSupplier: "Add New Supplier", supplierName: "Supplier Name:", supplierPhone: "Supplier Phone:",
            supplierAddress: "Supplier Address:", addSupplierBtn: "Add Supplier", supplierList: "Supplier List",
            viewPurchasesBtn: "View Purchases", confirmDeleteSupplier: "Are you sure you want to delete this supplier?",
            purchaseEntryTitle: "New Purchase Entry", addProductToPurchase: "Add Product to Purchase", purchasePrice: "Purchase Price",
            addToPurchaseAndInventory: "Record Purchase & Add to Stock", purchaseHistoryTitle: "Purchase History of Supplier", purchaseDate: "Purchase Date",
            purchaseItems: "Purchased Items", noPurchaseEntries: "No purchase entries for this supplier.",
            gstinLabel: "GST Number:", gstinBill: "GSTIN:",
            addCustomer: "Add New Customer", addCustomerBtn: "Add Customer", customerAddedSuccess: "Customer added successfully!",
            cropImageTitle: "Crop Logo", cropBtn: "Crop & Save", cancel: "Cancel",
            supplierDetails: "Supplier Details", basePrice: "Base Price/Unit (₹)", gstPercent: "GST (%):", recentPurchases: "Recent Purchases",
            selectSupplierToViewHistory: "Go to the 'Suppliers' tab to see all purchases for a supplier.",
            addExpenseTitle: "Add New Expense", expenseDescription: "Expense Description:", expenseAmount: "Amount (₹):",
            expenseDate: "Expense Date:", addExpenseBtn: "Add Expense", expenseListTitle: "Expense List",
            descriptionColumn: "Description", amountColumn: "Amount", dateColumn: "Date", expenseAddedSuccess: "Expense added successfully.",
            printPreviewTitle: "Print Preview", paperSize: "Paper Size:", printNow: "Print Now",
            totalSales: "Total Sales", totalPurchases: "Total Purchases", salesPurchaseChartTitle: "Sales & Purchases", profitAndLoss: "Profit & Loss",
            product: "Product", service: "Service", serviceDescription: "Service Description:", serviceCharge: "Service Charge (₹):",
            withoutGst: "Without GST", withGst: "With GST", printPurchaseNote: "Print Purchase Note",
            signature: "Signature:", stamp: "Stamp:", authorizedSignatory: "Authorized Signatory",
            purchaseReportTitle: "Purchase Report", purchaseReportDesc: "Download a detailed list of all purchases within a date range.", supplierAddressLabel: "Supplier Address:",
            purchaseId: "Purchase ID", totalPrice: "Total Price/Unit (₹):", lineTotal: "Total:", sellingPriceLabel: "Selling Price/Unit (₹)", totalGst: "Total GST:", purchaseBillNo: "Purchase Bill No:",
            settingsTitle: "Settings", darkModeLabel: "Dark Mode", purchaseBillDate: "Bill Date:", hsnSac: "HSN/SAC:",
            purchasePriceDetails: "Purchase Price Details", totalPurchasePrice: "Total Purchase Price/Unit (₹)", sellingPriceDetails: "Selling Price Details", profitMargin: "Margin",
            margin: "Margin", fullInventoryList: "Full Inventory List",
            cashFlowTab: "Cash Flow", addCashFlowTitle: "New Cash Entry", transactionType: "Transaction Type", cashIn: "Cash-In", cashOut: "Cash-Out",
            associatedParty: "Associated Party", notes: "Notes", addEntry: "Add Entry", cashFlowSummary: "Cash Flow Summary",
            totalCashIn: "Total Cash-In", totalCashOut: "Total Cash-Out", netBalance: "Net Balance", cashFlowHistory: "Cash Flow History"
        },
        'ur': {
            welcomeTitle: "Welcome Billing App", login: "لاگ ان کریں", createAccount: "نیا اکاؤنٹ بنائیں", back: "← واپس",
            shopNameLabel: "دکان کا نام:", emailLabel: "ای میل:", mobileLabel: "موبائل:", passwordLabel: "پاس ورڈ:",
            signUp: "سائن اپ", emailOrMobileLabel: "ای میل یا موبائل:", logout: "لاگ آوٹ",
            dashboardTab: "ڈیش بورڈ",
            sellTab: "فروخت", purchaseTab: "خرید", inventoryTab: "انوینٹری", expensesTab: "اخراجات",
            customersTab: "صارفین", suppliersTab: "سپلائرز", profileTab: "پروفائل", backupRestoreTab: "بیک اپ/ریسٹور",
            reportsTab: "رپورٹس", customerDetails: "صارف کی تفصیلات", customerName: "صارف کا نام:", customerPhone: "صارف کا فون:", customerAddress: "صارف کا پتہ:",
            addItem: "آئٹم شامل کریں", addProductLabel: "پروڈکٹ تلاش کریں:", quantity: "مقدار:", addToBill: "بل میں شامل کریں",
            currentBill: "موجودہ بل", productColumn: "پروڈکٹ", quantityColumn: "مقدار", priceColumn: "قیمت", totalColumn: "کل",
            rateColumn: "شرح", subTotal: "ذیلی کل:", discount: "رعایت:", gst: "جی ایس ٹی", grandTotal: "کل قابل ادائیگی:",
            generateBill: "بل بنائیں", addProduct: "نیا پروڈکٹ شامل کریں / اپ ڈیٹ کریں", productName: "پروڈکٹ کا نام:", priceLabel: "فروخت کی قیمت",
            unitLabel: "یونٹ:", stockQuantity: "اسٹاک کی مقدار:", addToStock: "اسٹاک میں شامل کریں", currentStock: "موجودہ اسٹاک",
            inStock: "اسٹاک میں", printStock: "اسٹاک پرنٹ کریں", saveAsPdf: "پی ڈی ایف کے طور پر محفوظ کریں", customerList: "صارفین کی فہرست",
            nameColumn: "نام", phoneColumn: "فون", actionColumn: "عمل", historyBtn: "تاریخ", shopDetails: "دکان کی تفصیلات",
            shopAddressLabel: "دکان کا پتہ:", phoneNumLabel: "فون نمبر:", emailIdLabel: "ای میل آئی ڈی:",
            paymentAndLogo: "ادائیگی اور لوگو", upiPlaceholder: "yourname@bank", shopLogoLabel: "دکان کا لوگو:",
            saveProfile: "پروفائل محفوظ کریں", sendOnWhatsApp: "WhatsApp پر بھیجیں", printBill: "بل پرنٹ کریں",
            shareAsImage: "تصویر شیئر کریں", newBill: "نیا بل", purchaseHistoryOf: " کی خریداری کی تاریخ", salesHistoryOf: "کی فروخت کی تاریخ", close: "بند کریں",
            invalidCredentials: "غلط اسناد۔", emailExists: "یہ ای میل آئی ڈی پہلے سے رجسٹرڈ ہے۔", signupSuccess: "کامیابی سے سائن اپ!",
            fillAllFields: "براہ کرم تمام خانوں میں صحیح معلومات درج کریں۔", productAddedSuccess: "پروڈکٹ کامیابی سے شامل کیا گیا!",
            productUpdatedSuccess: "پروڈکٹ کامیابی سے اپ ڈیٹ ہو گیا!", quantityUpdatedSuccess: "مصنوعات کی مقدار کو اپ ڈیٹ کر دیا گیا ہے!",
            selectProductFromList: "براہ کرم فہرست سے ایک پروڈکٹ منتخب کریں۔", stockUnavailable: "اسٹاک میں صرف {quantity} {unit} دستیاب ہے!",
            addItemsToBill: "بل بنانے کے लिए آئٹمز شامل کریں۔", customerInfoRequired: "بل بنانے کے لیے صارف کا نام اور फ़ोन नंबर आवश्यक ہے।",
            profileSaved: "پروفائل محفوظ ہوگیا!", noBillToShare: "شیئر کرنے کے لیے کوئی بل نہیں ہے۔", preparing: "تیار ہو رہا ہے...",
            imageCreationFailed: "تصویر بنانے میں خرابی۔", imageDownloaded: "بل کی تصویر ڈاؤن لوڈ ہو گئی ہے۔ براہ کرم اسے دستی طور پر شیئر کریں۔",
            noPurchaseHistory: "اس سپلائر کے لیے خریداری کی کوئی تاریخ نہیں ملی۔", noSalesHistory: "اس گاہک کے لیے فروخت کی کوئی تاریخ نہیں ملی۔",
            billNo: "بل نمبر:", date: "تاریخ:", total: "کل:", viewBill: "بل دیکھیں",
            stockReport: "اسٹاک رپورٹ", customer: "صارف:", name: "نام:", mobile: "موبائل:", subTotalBill: "ذیلی کل:", discountBill: "رعایت:",
            grandTotalBill: "کل قابل ادائیگی:", scanToPay: "ادائیگی کے لیے اسکین کریں", visitAgain: "دوبارہ تشریف لائیں!", thanksForShopping: "خریداری کے لئے شکریہ!",
            editBtn: "ترمیم", deleteBtn: "حذف کریں", updateBtn: "اپ ڈیٹ", deleteConfirm: "کیا آپ واقعی اس آئٹم کو حذف کرنا چاہتے ہیں؟",
            backupRestoreTitle: "بیک اپ اور ریسٹور", backupInstructions: "اپنے تمام ڈیٹا کو ڈاؤن لوڈ करने کے लिए 'بیک اپ بنائیں' پر کلک کریں۔ اپنا ڈیٹا بازیافت کرنے کے لیے 'بیک اپ سے بحال کریں' کا استعمال کریں۔",
            createBackup: "بیک اپ بنائیں", restoreBackup: "بیک اپ سے بحال کریں", restoreConfirm: "کیا آپ واقعی بحال کرنا چاہتے ہیں؟ یہ تمام موجودہ ڈیٹا کو اوور رائٹ کر دے گا۔",
            backupSuccess: "بیک اپ فائل کامیابی سے بن گئی۔", restoreSuccess: "ڈیٹا کامیابی سے بحال ہو گیا۔", invalidBackupFile: "غلط بیک اپ فائل۔",
            totalRevenue: "کل آمدنی", totalBillsGenerated: "کل بل", currentStockValue: "موجودہ اسٹاک کی قیمت",
            topSellingProducts: "سب سے زیادہ فروخت ہونے والی مصنوعات", quantitySold: "فروخت شدہ مقدار",
            totalProfit: "کل منافع", totalExpenses: "کل اخراجات", netProfitLoss: "خالص منافع/نقصان",
            downloadReportsTitle: "رپورٹس ڈاؤن لوڈ کریں", salesReportTitle: "سیلز رپورٹ", stockReportTitle: "اسٹاک رپورٹ", customerListTitle: "کسٹمر لسٹ رپورٹ",
            salesReportDesc: "تاریخ کی حد کے اندر تمام بلوں کی تفصیلی فہرست ڈاؤن لوڈ کریں۔", stockReportDesc: "اسٹاک میں موجود تمام مصنوعات کی فہرست ڈاؤن لوڈ کریں۔",
            customerListDesc: "اپنے تمام رجسٹرڈ صارفین کی فہرست ڈاؤن لوڈ کریں۔", fromDate: "سے:", toDate: "تک:", downloadAsPdf: "پی ڈی ایف میں ڈاؤن لوڈ کریں",
            downloadAsCsv: "سی ایس وی میں ڈاؤن لوڈ کریں", allBills: "تمام بل", billDate: "بل کی تاریخ", noDataFound: "منتخب کردہ حد کے لیے کوئی ڈیٹا نہیں ملا۔",
            forgotPassword: "پاس ورڈ بھول گئے؟", resetPasswordTitle: "پاس ورڈ ری سیٹ کریں", verifyEmail: "ای میل کی توثیق کریں",
            enterRegisteredEmail: "اپنا رجسٹرڈ ای میل درج کریں۔", enterRegisteredMobile: "شناخت کی توثیق کے لیے اپنا رجسٹرڈ موبائل نمبر درج کریں۔",
            newPassword: "نیا پاس ورڈ", confirmPassword: "پاس ورڈ کی تصدیق کریں", resetPasswordBtnText: "پاس ورڈ ری سیٹ کریں",
            emailNotFound: "یہ ای میل رجسٹرڈ نہیں ہے۔", verificationFailed: "موبائل نمبر مماثل نہیں ہے۔", passwordsDoNotMatch: "پاس ورڈز مماثل نہیں ہیں۔",
            passwordResetSuccess: "پاس ورڈ کامیابی سے دوبارہ ترتیب دیا گیا! اب آپ لاگ ان کر سکتے ہیں۔",
            addSupplier: "نیا سپلائر شامل کریں", supplierName: "سپلائر کا نام:", supplierPhone: "سپلائر کا فون:",
            supplierAddress: "سپلائر کا پتہ:", addSupplierBtn: "سپلائر شامل کریں", supplierList: "سپلائرز کی فہرست",
            viewPurchasesBtn: "خریداری دیکھیں", confirmDeleteSupplier: "کیا آپ واقعی اس سپلائر کو حذف کرنا چاہتے ہیں؟",
            purchaseEntryTitle: "نئی خریداری کا اندراج", addProductToPurchase: "خریداری میں پروڈکٹ شامل کریں", purchasePrice: "خریداری کی قیمت",
            addToPurchaseAndInventory: "خریداری ریکارڈ کریں اور اسٹاک میں شامل کریں", purchaseHistoryTitle: "سپلائر کی خریداری کی تاریخ", purchaseDate: "خریداری کی تاریخ",
            purchaseItems: "خریدے گئے آئٹمز", noPurchaseEntries: "اس سپلائر کے لیے کوئی خریداری اندراج نہیں ہے۔",
            gstinLabel: "جی ایس ٹی نمبر:", gstinBill: "جی ایس ٹی آئی این:",
            addCustomer: "نیا گاہک شامل کریں", addCustomerBtn: "گاہک شامل کریں", customerAddedSuccess: "گاہک کامیابی سے شامل ہو گیا!",
            cropImageTitle: "لوگو کو کٹاؤ", cropBtn: "کراپ کریں اور محفوظ کریں", cancel: "منسوخ کریں",
            supplierDetails: "سپلائر کی تفصیلات", basePrice: "بنیادی قیمت/یونٹ (₹)", gstPercent: "جی ایس ٹی (٪):", recentPurchases: "حالیہ خریداری",
            selectSupplierToViewHistory: "کسی سپلائر کی تمام خریداری دیکھنے کے لیے 'سپلائرز' ٹیب پر جائیں۔",
            addExpenseTitle: "نیا خرچ شامل کریں", expenseDescription: "خرچ کی تفصیل:", expenseAmount: "رقم (₹):",
            expenseDate: "خرچ کی تاریخ:", addExpenseBtn: "خرچ شامل کریں", expenseListTitle: "اخراجات کی فہرست",
            descriptionColumn: "تفصیل", amountColumn: "رقم", dateColumn: "تاریخ", expenseAddedSuccess: "خرچ کامیابی سے شامل ہو گیا۔",
            printPreviewTitle: "پرنٹ کا پیش منظر", paperSize: "کاغذ کا سائز:", printNow: "ابھی پرنٹ کریں",
            totalSales: "کل فروخت", totalPurchases: "کل خرید", salesPurchaseChartTitle: "فروخت اور خرید", profitAndLoss: "منافع اور نقصان",
            product: "پروڈکٹ", service: "سروس", serviceDescription: "سروس کی تفصیل:", serviceCharge: "سروس چارج (₹):",
            withoutGst: "بغیر جی ایس ٹی", withGst: "جی ایس ٹی کے ساتھ", printPurchaseNote: "خریداری کا نوٹ پرنٹ کریں",
            signature: "دستخط:", stamp: "مہر:", authorizedSignatory: "مجاز دستخط کنندہ",
            purchaseReportTitle: "خریداری کی رپورٹ", purchaseReportDesc: "تاریخ کی حد کے اندر تمام خریداریوں کی تفصیلی فہرست ڈاؤن لوڈ کریں۔", supplierAddressLabel: "سپلائر کا پتہ:",
            purchaseId: "خریداری کی شناخت", totalPrice: "کل قیمت/یونٹ (₹):", lineTotal: "کل:", sellingPriceLabel: "فروخت کی قیمت/یونٹ (₹)", totalGst: "کل جی ایس ٹی:", purchaseBillNo: "خریداری بل نمبر:",
            settingsTitle: "ترتیبات", darkModeLabel: "ڈارک موڈ", purchaseBillDate: "بل کی تاریخ:", hsnSac: "HSN/SAC:",
            purchasePriceDetails: "خریداری کی قیمت کی تفصیلات", totalPurchasePrice: "کل خریداری کی قیمت/یونٹ (₹)", sellingPriceDetails: "فروخت کی قیمت کی تفصیلات", profitMargin: "مارجن",
            margin: "مارجن", fullInventoryList: "پوری انوینٹری کی فہرست",
            cashFlowTab: "کیش فلو", addCashFlowTitle: "نئی کیش انٹری", transactionType: "لین دین کی قسم", cashIn: "کیش ان", cashOut: "کیش آؤٹ",
            associatedParty: "متعلقہ پارٹی", notes: "نوٹس", addEntry: "انٹری شامل کریں", cashFlowSummary: "کیش فلو کا خلاصہ",
            totalCashIn: "کل کیش ان", totalCashOut: "کل کیش آؤٹ", netBalance: "نیٹ بیلنس", cashFlowHistory: "کیش فلو کی تاریخ"
        }
    };
    
    // --- ग्लोबल वेरिएबल्स ---
    let allRetailerData = {}, currentUserEmail = null, currentBillItems = [], billCounter = 1, productForCalculator = null, currentLanguage = 'hi', editingProductId = null, currentBillForModal = null, editingSupplierId = null, editingCustomerId = null, editingBillId = null, editingPurchaseId = null, lastActiveTab = 'dashboard';
    let cropper, currentCropTarget;
    let salesChart, purchaseChart, profitLossChart;
    const app = {}; window.app = app;
    const appLink = "https://my-billing-app.com";
    
    // --- भाषा फंक्शन ---
    const setLanguage = (lang) => {
        if (!translations[lang]) return;
        currentLanguage = lang;
        localStorage.setItem('appLanguage', lang);
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'ur') ? 'rtl' : 'ltr';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            const translation = translations[lang][key];
            if (translation) {
                if (el.placeholder) { el.placeholder = translation; } 
                else if (el.tagName === 'SPAN' || el.tagName === 'BUTTON' || el.tagName === 'H2' || el.tagName === 'H4' || el.tagName === 'H5' || el.tagName === 'P' || el.tagName === 'LABEL' || el.tagName === 'TH' || el.tagName === 'A' || el.tagName === 'STRONG') {
                    el.innerText = translation;
                }
            }
        });
        document.getElementById('language-select').value = lang;
        if (currentUserEmail) { renderAllUI(); }
    };

    // --- हेल्पर और UI फंक्शन ---
    const saveData = () => { localStorage.setItem('allRetailerData', JSON.stringify(allRetailerData)); };
    const loadData = () => { allRetailerData = JSON.parse(localStorage.getItem('allRetailerData')) || {}; billCounter = parseInt(localStorage.getItem('billCounter')) || 1; };
    const showPage = (pageName) => { 
        document.querySelectorAll('.container').forEach(p => p.classList.add('hidden')); 
        document.getElementById(pageName).classList.remove('hidden');
        if (pageName === 'reset-password-page') {
             document.getElementById('resetPasswordForm').reset();
             document.getElementById('newPasswordSection').classList.add('hidden');
             document.getElementById('resetEmail').disabled = false;
             document.getElementById('verifyEmailBtn').disabled = false;
        }
    };

    const closeProfileSidebar = () => {
        document.getElementById('profile-sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').classList.add('hidden');
        showTab(lastActiveTab);
    };

    const showTab = (tabName) => {
        if (tabName === 'profile') return;
        document.getElementById('profile-sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').classList.add('hidden');

        document.querySelectorAll('.tab-content, .tab-link').forEach(el => el.classList.remove('active'));
        
        const tabContent = document.getElementById(`${tabName}-tab`);
        const tabLink = document.querySelector(`.tab-link[data-tab='${tabName}']`);
        
        if(tabContent) tabContent.classList.add('active');
        if(tabLink) tabLink.classList.add('active');
        
        lastActiveTab = tabName;
        
        if (tabName === 'dashboard') renderDashboard();
        if (tabName === 'reports') {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salesReportToDate').value = today;
            document.getElementById('purchaseReportToDate').value = today;
        } else if (tabName === 'purchase') {
            document.getElementById('purchaseBillDate').valueAsDate = new Date();
            renderPurchaseHistory(); 
        } else if (tabName === 'expenses') {
            document.getElementById('expenseDate').valueAsDate = new Date();
        } else if (tabName === 'sell') {
            renderSellInventoryList();
        } else if (tabName === 'cashflow') {
            renderCashFlow();
        }
    };
    
    const renderDashboard = () => {
        const retailer = allRetailerData[currentUserEmail];
        if (!retailer) return;

        const bills = retailer.bills || [];
        const purchaseEntries = retailer.purchaseEntries || [];
        const expenses = retailer.expenses || [];
        
        const totalSales = bills.reduce((sum, bill) => sum + bill.total, 0);
        const totalPurchases = purchaseEntries.reduce((sum, entry) => sum + (entry.item.totalPrice * entry.item.quantity), 0);
        const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const totalBills = bills.length;
        
        const salesData = {};
        bills.forEach(bill => { bill.items.forEach(item => { if(item.type === 'product') { salesData[item.name] = (salesData[item.name] || 0) + item.quantity; } }); });
        const sortedProducts = Object.entries(salesData).sort((a, b) => b[1] - a[1]);

        document.getElementById('totalSalesDisplay').innerText = `₹${totalSales.toFixed(2)}`;
        document.getElementById('totalPurchasesDisplay').innerText = `₹${totalPurchases.toFixed(2)}`;
        document.getElementById('totalExpensesDisplay').innerText = `₹${totalExpenses.toFixed(2)}`;
        document.getElementById('totalBillsDisplay').innerText = totalBills;
        
        const topSellingTableBody = document.getElementById('topSellingTableBody');
        topSellingTableBody.innerHTML = sortedProducts.slice(0, 5).map(([name, quantity]) => `<tr><td>${name}</td><td>${quantity.toFixed(2)}</td></tr>`).join('');
        
        renderSalesChart(bills);
        renderPurchaseChart(purchaseEntries);
        renderProfitLossChart(totalSales, totalPurchases, totalExpenses);
    };

    const renderSalesChart = (bills) => {
        const labels = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString(currentLanguage, {month: 'short'}));
        const data = new Array(12).fill(0);

        bills.forEach(bill => {
            const [d, m, y] = bill.date.split('-');
            const month = parseInt(m, 10) - 1;
            if(month >= 0 && month < 12 && new Date().getFullYear() == y) data[month] += bill.total;
        });

        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ 
                    label: translations[currentLanguage].totalSales, 
                    data: data, 
                    borderColor: 'rgba(39, 174, 96, 1)',
                    backgroundColor: 'rgba(39, 174, 96, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    };
    
    const renderPurchaseChart = (purchases) => {
        const labels = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString(currentLanguage, {month: 'short'}));
        const data = new Array(12).fill(0);

        purchases.forEach(p => {
            const purchaseDate = new Date(p.date);
            const month = purchaseDate.getMonth();
            if(month >= 0 && month < 12 && purchaseDate.getFullYear() == new Date().getFullYear()) {
                data[month] += (p.item.totalPrice * p.item.quantity);
            }
        });

        const ctx = document.getElementById('purchaseChart').getContext('2d');
        if (purchaseChart) purchaseChart.destroy();
        purchaseChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ 
                    label: translations[currentLanguage].totalPurchases, 
                    data: data, 
                    backgroundColor: 'rgba(231, 76, 60, 0.7)', 
                    borderColor: 'rgba(231, 76, 60, 1)', 
                    borderWidth: 1 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    };

    const renderProfitLossChart = (totalSales, totalPurchases, totalExpenses) => {
        const cogs = totalPurchases;
        let netProfit = totalSales - cogs - totalExpenses;
        let data, labels, colors;

        if (netProfit < 0) {
            data = [totalSales, Math.abs(netProfit)];
            labels = ['कुल बिक्री', 'कुल हानि'];
            colors = ['rgba(74, 144, 226, 0.8)', 'rgba(217, 30, 24, 0.8)'];
        } else {
            data = [cogs, totalExpenses, netProfit];
            labels = ['बेचे गए माल की लागत', 'परिचालन व्यय', 'शुद्ध लाभ'];
            colors = ['rgba(243, 156, 18, 0.8)', 'rgba(231, 76, 60, 0.8)', 'rgba(39, 174, 96, 0.8)'];
        }
        
        const ctx = document.getElementById('profitLossChart').getContext('2d');
        if(profitLossChart) profitLossChart.destroy();
        profitLossChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{ data: data, backgroundColor: colors }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    };

    const renderAllUI = () => {
        if (!currentUserEmail || !allRetailerData[currentUserEmail]) return;
        const retailer = allRetailerData[currentUserEmail];
        document.getElementById('retailerShopName').innerText = retailer.shopDetails.name;
        renderInventoryTable();
        renderSupplierTable();
        renderProfile();
        renderCustomerTable();
        renderExpensesTable();
        updateCurrentBillDisplay();
        renderDashboard();
        renderPurchaseHistory();
        renderCashFlow();
        renderSellInventoryList();
    };
    const renderInventoryTable = () => {
        const inventory = allRetailerData[currentUserEmail]?.inventory || [];
        const lang = translations[currentLanguage];
        document.getElementById('stockTableBody').innerHTML = inventory.map(item => {
            const purchasePrice = item.purchasePrice || 0;
            const sellingPrice = item.price || 0;
            const marginAmount = sellingPrice - purchasePrice;
            const marginPercent = purchasePrice > 0 ? (marginAmount / purchasePrice) * 100 : 0;
            const gstInfo = item.gstPercent > 0 ? `${item.gstPercent}%` : lang.withoutGst;

            return `
            <tr>
                <td>${item.name}</td>
                <td>₹${purchasePrice.toFixed(2)}</td>
                <td>${gstInfo}</td>
                <td>₹${sellingPrice.toFixed(2)}</td>
                <td>₹${marginAmount.toFixed(2)} (${marginPercent.toFixed(1)}%)</td>
                <td>${item.quantity} ${item.unit}</td>
                <td>
                    <button class="action-button delete" onclick="window.app.deleteProduct(${item.id})">${lang.deleteBtn}</button>
                </td>
            </tr>`
        }).join('');
    };

    const renderSupplierTable = () => {
        const suppliers = allRetailerData[currentUserEmail]?.suppliers || [];
        const lang = translations[currentLanguage];
        document.getElementById('supplierTableBody').innerHTML = suppliers.map(s => `
            <tr>
                <td>${s.name}</td>
                <td>${s.phone}</td>
                <td>
                    <button class="action-button view" onclick="window.app.showPurchaseHistoryForSupplier(${s.id})">${lang.historyBtn}</button>
                    <button class="action-button edit" onclick="window.app.editSupplier(${s.id})">${lang.editBtn}</button>
                    <button class="action-button delete" onclick="window.app.deleteSupplier(${s.id})">${lang.deleteBtn}</button>
                </td>
            </tr>`).join('');
    };

    const renderProfile = () => {
        const details = allRetailerData[currentUserEmail].shopDetails;
        document.getElementById('profileShopName').value = details.name; document.getElementById('profileAddress').value = details.address || '';
        document.getElementById('profilePhone').value = details.phone; document.getElementById('profileEmail').value = currentUserEmail;
        document.getElementById('profileGstin').value = details.gstin || '';
        document.getElementById('logoPreview').src = details.logo || 'https://via.placeholder.com/150'; 
        document.getElementById('signaturePreview').src = details.signature || 'https://via.placeholder.com/150x80';
        document.getElementById('stampPreview').src = details.stamp || 'https://via.placeholder.com/150x80';
        document.getElementById('profileUpiId').value = details.upiId || '';
    };
    const renderCustomerTable = () => {
        const customers = allRetailerData[currentUserEmail]?.customers || [];
        const lang = translations[currentLanguage];
        document.getElementById('customerTableBody').innerHTML = customers.map(c => `<tr><td>${c.name}</td><td>${c.phone}</td><td><button class="action-button view" onclick="window.app.showSalesHistoryForCustomer(${c.id})">${lang.historyBtn}</button><button class="action-button edit" onclick="window.app.editCustomer(${c.id})">${lang.editBtn}</button></td></tr>`).join('');
    };
    
    const updateCurrentBillDisplay = () => {
        let subTotal = 0;
        document.getElementById('currentBillBody').innerHTML = currentBillItems.map(item => { 
            subTotal += item.total; 
            return `<tr>
                        <td>${item.name}</td>
                        <td>${item.type === 'product' ? (item.quantity + ' ' + item.unit) : '-'}</td>
                        <td>₹${item.price.toFixed(2)}</td>
                        <td>₹${item.total.toFixed(2)}</td>
                    </tr>`; 
        }).join('');
        calculateFinalTotal();
    };

    const calculateFinalTotal = () => {
        const subTotal = currentBillItems.reduce((sum, item) => sum + (item.basePrice * item.quantity), 0);
        const totalGst = currentBillItems.reduce((sum, item) => sum + (item.gstAmount * item.quantity), 0);
        
        document.getElementById('subTotalDisplay').innerText = subTotal.toFixed(2);
        document.getElementById('totalGstDisplay').innerText = totalGst.toFixed(2);
        
        const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
        const discountType = document.getElementById('discountType').value;
        
        let discountAmount = (discountType === 'percent') ? (subTotal * discountValue) / 100 : discountValue;
        
        const finalTotal = subTotal + totalGst - discountAmount;
        document.getElementById('grandTotalDisplay').innerText = finalTotal.toFixed(2);
    };

    // --- प्रमाणीकरण और आरंभीकरण ---
    const logout = () => { sessionStorage.removeItem('loggedInUser'); currentUserEmail = null; showPage('welcome-page'); };
    const initializeApp = () => {
        loadData();
        const savedLang = localStorage.getItem('appLanguage') || 'hi';
        setLanguage(savedLang);
        currentUserEmail = sessionStorage.getItem('loggedInUser');
        if (currentUserEmail && allRetailerData[currentUserEmail]) {
            renderAllUI(); 
            showPage('main-app'); 
            showTab('dashboard');
        } else {
            logout();
        }
    };
    
    const downloadCsv = (filename, headers, data) => {
        const csvRows = [headers.join(','), ...data.map(row => row.map(val => `"${String(val ?? '').replace(/"/g, '""')}"`).join(','))];
        const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = filename;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
    };

    // --- इवेंट हैंडलर्स ---
    const handleLogin = (e) => {
        e.preventDefault();
        const identifier = document.getElementById('loginIdentifier').value.toLowerCase();
        const password = document.getElementById('loginPassword').value;
        const userEmail = Object.keys(allRetailerData).find(email => (email === identifier || allRetailerData[email].shopDetails.phone === identifier) && allRetailerData[email].password === password);
        if (userEmail) { sessionStorage.setItem('loggedInUser', userEmail); initializeApp(); } else { alert(translations[currentLanguage].invalidCredentials); }
    };

    const handleSignup = (e) => {
        e.preventDefault();
        const email = document.getElementById('signupEmail').value.toLowerCase();
        if (allRetailerData[email]) { alert(translations[currentLanguage].emailExists); return; }
        allRetailerData[email] = {
            password: document.getElementById('signupPassword').value,
            shopDetails: { name: document.getElementById('signupShopName').value, phone: document.getElementById('signupPhone').value, address: '', logo: '', upiId: '', gstin: '', signature:'', stamp:'' },
            inventory: [], customers: [], bills: [], suppliers: [], purchaseEntries: [], expenses: [], cashFlow: []
        };
        saveData(); alert(translations[currentLanguage].signupSuccess); e.target.reset(); showPage('login-page');
    };
    
    app.deleteProduct = (productId) => {
        if (confirm(translations[currentLanguage].deleteConfirm)) {
            const retailerData = allRetailerData[currentUserEmail];
            retailerData.inventory = retailerData.inventory.filter(p => p.id !== productId);
            saveData(); 
            renderAllUI();
        }
    };
    
    const handlePrintStock = () => {
        const printContent = document.getElementById('inventoryToPrint').innerHTML;
        const shopName = allRetailerData[currentUserEmail].shopDetails.name;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>${translations[currentLanguage].stockReport} - ${shopName}</title><style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;}.no-print{display:none;}</style></head><body><h1>${translations[currentLanguage].stockReport} - ${shopName}</h1>${printContent}</body></html>`);
        printWindow.document.close();
        printWindow.print();
    };

    const handleSaveStockPdf = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const shopName = allRetailerData[currentUserEmail].shopDetails.name;
        doc.text(`${translations[currentLanguage].stockReport} - ${shopName}`, 14, 15);
        const tableData = (allRetailerData[currentUserEmail].inventory || []).map(p => [
            p.name, 
            `Rs. ${p.purchasePrice.toFixed(2)}`,
            `Rs. ${p.price.toFixed(2)}`,
            `${p.quantity} ${p.unit}`
        ]);
        doc.autoTable({ head: [[translations[currentLanguage].productColumn, translations[currentLanguage].purchasePrice, translations[currentLanguage].priceLabel, translations[currentLanguage].inStock]], body: tableData, startY: 20 });
        doc.save(`${translations[currentLanguage].stockReport}-${Date.now()}.pdf`);
    };
    
    const handleSaveProfile = () => {
        const details = allRetailerData[currentUserEmail].shopDetails;
        Object.assign(details, { 
            name: document.getElementById('profileShopName').value, 
            address: document.getElementById('profileAddress').value, 
            phone: document.getElementById('profilePhone').value, 
            upiId: document.getElementById('profileUpiId').value.trim(),
            gstin: document.getElementById('profileGstin').value.trim(),
            logo: document.getElementById('logoPreview').src,
            signature: document.getElementById('signaturePreview').src,
            stamp: document.getElementById('stampPreview').src
        });
        saveData(); 
        alert(translations[currentLanguage].profileSaved); 
        renderAllUI();
    };
    
    const loadNativeAdAfterBill = () => {
        const adPlaceholder = document.getElementById('ad-placeholder-in-modal'); if (!adPlaceholder) return; 
        adPlaceholder.innerHTML = `<div id="container-4602f664803407cfda1aae472a65c04e"></div>`;
        const oldScript = document.querySelector('script[src*="pl27251273.profitableratecpm.com"]'); if (oldScript) oldScript.remove();
        const adScript = document.createElement('script');
        Object.assign(adScript, { async: true, 'data-cfasync': false, src: '//pl27251273.profitableratecpm.com/4602f664803407cfda1aae472a65c04e/invoke.js' });
        document.head.appendChild(adScript);
    };

    app.generateBillHTML = (bill, retailer, customer) => {
        const lang = translations[currentLanguage];
        return `<div id="bill-to-print" style="background-color: #fff; color: #000; padding: 15px; font-family:'Courier New', monospace; direction: ${document.documentElement.dir};">
            <div style="text-align:center;">
                <img src="${retailer.shopDetails.logo || ''}" style="max-height:80px; margin-bottom: 5px;">
                <h3 style="margin:5px 0; font-weight:bold;">${retailer.shopDetails.name}</h3>
                <p style="margin:2px 0; font-size: 12px;">${retailer.shopDetails.address}</p>
                ${retailer.shopDetails.gstin ? `<p style="margin:2px 0; font-size: 12px;">${lang.gstinBill} ${retailer.shopDetails.gstin}</p>` : ''}
                <p style="margin:2px 0; font-size: 12px;">${lang.phoneColumn}: ${retailer.shopDetails.phone}</p>
                <hr style="border:1px dashed #333; margin: 8px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                    <span>${lang.billNo} ${bill.billNo}</span>
                    <span>${lang.date}: ${bill.date} ${bill.time}</span>
                </div>
            </div>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <div class="bill-customer-info" style="font-size: 12px;">
                <p style="margin:2px 0;"><strong>${lang.customer}:</strong> ${customer.name}, ${customer.phone}</p>
                 ${customer.gstin ? `<p style="margin:2px 0; font-size: 12px;"><strong>${lang.gstinBill}</strong> ${customer.gstin}</p>` : ''}
            </div>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <table style="width:100%; font-size:12px; border-collapse:collapse;">
                <thead><tr><th style="text-align:left; padding: 2px;">${lang.productColumn}</th><th style="text-align:center; padding: 2px;">${lang.quantityColumn}</th><th style="text-align:right; padding: 2px;">${lang.rateColumn}</th><th style="text-align:center; padding: 2px;">${lang.gst}</th><th style="text-align:right; padding: 2px;">${lang.totalColumn}</th></tr></thead>
                <tbody>${bill.items.map(item => `<tr><td style="text-align:left; padding: 2px;">${item.name}</td><td style="text-align:center; padding: 2px;">${item.type === 'product' ? (item.quantity + ' ' + item.unit) : '-'}</td><td style="text-align:right; padding: 2px;">₹${item.price.toFixed(2)}</td><td style="text-align:center; padding: 2px;">${item.gstPercent ? item.gstPercent.toFixed(2) + '%' : '-'}</td><td style="text-align:right; padding: 2px;">₹${item.total.toFixed(2)}</td></tr>`).join('')}</tbody>
            </table>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <div style="font-size: 13px;">
                <div style="display:flex; justify-content:space-between;"><span>${lang.subTotalBill}</span><span>₹${bill.subTotal.toFixed(2)}</span></div>
                 <div style="display:flex; justify-content:space-between;"><span>${lang.totalGst}</span><span>+ ₹${bill.totalGst.toFixed(2)}</span></div>
                <div style="display:flex; justify-content:space-between;"><span>${lang.discountBill}</span><span>- ₹${bill.discountAmount.toFixed(2)}</span></div>
                <hr style="border-top:1px solid #333; margin: 5px 0;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size: 15px;"><span>${lang.grandTotalBill}</span><span>₹${bill.total.toFixed(2)}</span></div>
            </div>
             ${retailer.shopDetails.upiId ? `<div style="text-align:center; margin-top:10px;"><p style="font-weight:bold; margin: 5px 0;">${lang.scanToPay}</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(`upi://pay?pa=${retailer.shopDetails.upiId}&pn=${encodeURIComponent(retailer.shopDetails.name)}&am=${bill.total.toFixed(2)}&cu=INR&tn=BillNo${bill.billNo}`)}" alt="UPI QR Code" style="display:block;margin:5px auto;width:120px;height:120px;"></div>` : ''}
             <div style="display: flex; justify-content: space-between; margin-top: 40px; padding-top: 10px; border-top: 1px dashed #333;">
                <div style="text-align: center;">
                    ${retailer.shopDetails.signature ? `<img src="${retailer.shopDetails.signature}" style="height: 40px;"/>` : ''}
                    <p style="margin: 0; font-size: 12px;">(${lang.authorizedSignatory})</p>
                </div>
                <div style="text-align: center;">
                     ${retailer.shopDetails.stamp ? `<img src="${retailer.shopDetails.stamp}" style="height: 50px;"/>` : ''}
                </div>
            </div>
            <div style="text-align:center;margin-top:15px; font-size: 12px;"><p style="margin:0;">${lang.visitAgain} ${lang.thanksForShopping}</p></div>
        </div>`;
    };

    const getOrCreateCustomer = (name, phone, address) => {
        const retailer = allRetailerData[currentUserEmail];
        let customer = retailer.customers.find(c => c.phone === phone);
        if (customer) { Object.assign(customer, { name, address }); } 
        else { customer = { id: Date.now(), name, phone, address, gstin: '' }; retailer.customers.push(customer); }
        return customer;
    };
    
    const handleGenerateBill = () => {
        if (currentBillItems.length === 0) { alert(translations[currentLanguage].addItemsToBill); return; }
        const retailer = allRetailerData[currentUserEmail];
        const customerName = document.getElementById('billingCustomerName').value.trim();
        const customerPhone = document.getElementById('billingCustomerPhone').value.trim();
        if (!customerPhone || !customerName) { alert(translations[currentLanguage].customerInfoRequired); return; }
        
        const subTotal = currentBillItems.reduce((sum, item) => sum + (item.basePrice * item.quantity), 0);
        const totalGst = currentBillItems.reduce((sum, item) => sum + (item.gstAmount * item.quantity), 0);
        const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
        const discountType = document.getElementById('discountType').value;
        const discountAmount = (discountType === 'percent') ? (subTotal * discountValue) / 100 : discountValue;
        const finalTotal = subTotal + totalGst - discountAmount;

        if (editingBillId) { // Update existing bill
            const billToUpdate = retailer.bills.find(b => b.billNo === editingBillId);
            if(billToUpdate) {
                // Revert old stock change
                billToUpdate.items.forEach(oldItem => {
                    if (oldItem.type === 'product') {
                        const inventoryItem = retailer.inventory.find(p => p.id === oldItem.id);
                        if (inventoryItem) inventoryItem.quantity += oldItem.quantity;
                    }
                });

                billToUpdate.items = JSON.parse(JSON.stringify(currentBillItems));
                billToUpdate.subTotal = subTotal;
                billToUpdate.totalGst = totalGst;
                billToUpdate.discountAmount = discountAmount;
                billToUpdate.total = finalTotal;
            }
             document.getElementById('generateBillBtn').innerText = translations[currentLanguage].generateBill;
             editingBillId = null;
        } else { // Create new bill
            const customerForBill = getOrCreateCustomer(customerName, customerPhone, document.getElementById('billingCustomerAddress').value.trim());
            const today = new Date();
            const pad = (n) => n.toString().padStart(2, '0');
            const billId = `${today.getFullYear()}${pad(today.getMonth() + 1)}${pad(today.getDate())}${pad(today.getHours())}${pad(today.getMinutes())}${pad(today.getSeconds())}-${billCounter++}`;
            const billDate = `${pad(today.getDate())}-${pad(today.getMonth() + 1)}-${today.getFullYear()}`;
            const billTime = `${pad(today.getHours())}:${pad(today.getMinutes())}`;
            const newBill = { billNo: billId, customerId: customerForBill.id, date: billDate, time: billTime, items: JSON.parse(JSON.stringify(currentBillItems)), subTotal, totalGst, discountAmount, total: finalTotal };
            retailer.bills.push(newBill);
            currentBillForModal = newBill;
            document.getElementById('bill-to-print-container').innerHTML = app.generateBillHTML(newBill, retailer, customerForBill);
            loadNativeAdAfterBill();
            document.getElementById('bill-modal').style.display = 'block';
        }

        // Apply new stock change
        currentBillItems.forEach(item => { 
            if (item.type === 'product') {
                const inventoryItem = retailer.inventory.find(p => p.id === item.id);
                if(inventoryItem) inventoryItem.quantity -= item.quantity; 
            }
        });

        saveData();
        renderAllUI();
        resetBillForm();
    };

    const resetBillForm = () => {
        currentBillItems = [];
        editingBillId = null;
        document.getElementById('customerDetailsForm').reset();
        document.querySelector('input[name="itemType"][value="product"]').checked = true;
        document.getElementById('product-fields').classList.remove('hidden');
        document.getElementById('service-fields').classList.add('hidden');
        document.getElementById('discountInput').value = 0;
        document.getElementById('generateBillBtn').innerText = translations[currentLanguage].generateBill;
        updateCurrentBillDisplay();
        resetItemCalculator();
        document.getElementById('serviceDescriptionInput').value = '';
        document.getElementById('serviceChargeInput').value = '';
        document.querySelector('input[name="serviceGstType"][value="without_gst"]').checked = true;
        document.getElementById('serviceGstPercent').value = 0;
        document.getElementById('service-gst-field-container').classList.add('hidden');
    };


    app.showSalesHistoryForCustomer = (customerId) => {
        const retailer = allRetailerData[currentUserEmail];
        const customer = retailer.customers.find(c => c.id == customerId);
        const customerBills = retailer.bills.filter(b => b.customerId == customerId).reverse();
        document.getElementById('history-modal-title').innerText = `${customer.name} ${translations[currentLanguage].salesHistoryOf}`;
        const container = document.getElementById('historyContainer');
        const lang = translations[currentLanguage];
        if (customerBills.length === 0) container.innerHTML = `<p>${lang.noSalesHistory}</p>`;
        else container.innerHTML = customerBills.map(bill => `<div class="history-item"><p><strong>${lang.billNo}</strong> ${bill.billNo} | <strong>${lang.date}:</strong> ${bill.date} | <strong>${lang.total}:</strong> ₹${bill.total.toFixed(2)}</p><div class="history-item-actions"><button onclick="app.reprintBill('${bill.billNo}')" class="action-button view">${lang.viewBill}</button><button onclick="app.editBill('${bill.billNo}')" class="action-button edit">${lang.editBtn}</button></div></div>`).join('');
        document.getElementById('history-modal').style.display = 'block';
    };
    
    app.editBill = (billNo) => {
        const retailer = allRetailerData[currentUserEmail];
        const bill = retailer.bills.find(b => b.billNo == billNo);
        const customer = retailer.customers.find(c => c.id == bill.customerId);
        if(!bill || !customer) return;

        editingBillId = billNo;
        
        document.getElementById('billingCustomerName').value = customer.name;
        document.getElementById('billingCustomerPhone').value = customer.phone;
        document.getElementById('billingCustomerAddress').value = customer.address || '';
        
        currentBillItems = JSON.parse(JSON.stringify(bill.items));
        
        const subTotal = bill.subTotal;
        const discountAmount = bill.discountAmount;
        if(bill.discountType === 'percent') {
            document.getElementById('discountType').value = 'percent';
            document.getElementById('discountInput').value = subTotal > 0 ? ((discountAmount * 100) / subTotal).toFixed(2) : 0;
        } else {
            document.getElementById('discountType').value = 'fixed';
            document.getElementById('discountInput').value = discountAmount;
        }

        updateCurrentBillDisplay();
        document.getElementById('generateBillBtn').innerText = translations[currentLanguage].updateBtn;
        document.getElementById('history-modal').style.display = 'none';
        showTab('sell');
    };

    app.reprintBill = (billNo) => {
        const retailer = allRetailerData[currentUserEmail];
        const bill = retailer.bills.find(b => b.billNo == billNo);
        const customer = retailer.customers.find(c => c.id == bill.customerId);
        if (bill && customer) {
            currentBillForModal = bill;
            document.getElementById('bill-to-print-container').innerHTML = app.generateBillHTML(bill, retailer, customer);
            document.getElementById('history-modal').style.display = 'none';
            loadNativeAdAfterBill();
            document.getElementById('bill-modal').style.display = 'block';
            document.getElementById('closeBillModalBtn').dataset.isReprint = "true";
        }
    };

    const handleCreateBackup = () => {
        try {
            const backupData = { allRetailerData: allRetailerData, billCounter: billCounter };
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `billing-app-backup-${new Date().toISOString().slice(0, 10)}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            alert(translations[currentLanguage].backupSuccess);
        } catch (error) { console.error('Backup failed:', error); alert('Backup creation failed.'); }
    };

    const handleRestoreBackup = (event) => {
        const lang = translations[currentLanguage];
        if (!confirm(lang.restoreConfirm)) { event.target.value = ''; return; }
        const file = event.target.files[0];
        if (file && file.type === "application/json") {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (backupData && backupData.allRetailerData && backupData.billCounter) {
                        localStorage.setItem('allRetailerData', JSON.stringify(backupData.allRetailerData));
                        localStorage.setItem('billCounter', backupData.billCounter);
                        alert(lang.restoreSuccess);
                        initializeApp();
                    } else { alert(lang.invalidBackupFile); }
                } catch (error) { console.error('Restore failed:', error); alert(lang.invalidBackupFile); } 
                finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        } else { alert(lang.invalidBackupFile); event.target.value = ''; }
    };
    
    // --- पासवर्ड रीसेट हैंडलर्स ---
    const handleVerifyEmail = () => {
        const email = document.getElementById('resetEmail').value.toLowerCase();
        const lang = translations[currentLanguage];
        if (allRetailerData[email]) {
            document.getElementById('newPasswordSection').classList.remove('hidden');
            document.getElementById('resetEmail').disabled = true;
            document.getElementById('verifyEmailBtn').disabled = true;
        } else {
            alert(lang.emailNotFound);
        }
    };
    
    const handleResetPassword = (e) => {
        e.preventDefault();
        const email = document.getElementById('resetEmail').value.toLowerCase();
        const phone = document.getElementById('resetPhone').value;
        const newPassword = document.getElementById('resetNewPassword').value;
        const confirmPassword = document.getElementById('resetConfirmPassword').value;
        const lang = translations[currentLanguage];

        if (newPassword !== confirmPassword) {
            alert(lang.passwordsDoNotMatch);
            return;
        }
        if (!newPassword) {
             alert(lang.fillAllFields);
             return;
        }

        const userData = allRetailerData[email];
        if (userData && userData.shopDetails.phone === phone) {
            userData.password = newPassword;
            saveData();
            alert(lang.passwordResetSuccess);
            showPage('login-page');
        } else {
            alert(lang.verificationFailed);
        }
    };

    // --- आपूर्तिकर्ता फंक्शन ---
    const getOrCreateSupplier = (name, phone, address) => {
        const retailer = allRetailerData[currentUserEmail];
        let supplier = retailer.suppliers.find(s => s.phone === phone);
        if (supplier) {
            if (supplier.name !== name) { supplier.name = name; } 
            if (address) { supplier.address = address; }
        } else {
            supplier = { id: Date.now(), name, phone, address: address || '', gstin: '' }; 
            if (!Array.isArray(retailer.suppliers)) retailer.suppliers = [];
            retailer.suppliers.push(supplier);
        }
        renderSupplierTable(); 
        return supplier;
    };
    const handleAddSupplier = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const name = document.getElementById('supplierName').value.trim();
        const phone = document.getElementById('supplierPhone').value.trim();
        const address = document.getElementById('supplierAddress').value.trim();
        const gstin = document.getElementById('supplierGstin').value.trim();
        const lang = translations[currentLanguage];
        if (!name || !phone) { alert(lang.fillAllFields); return; }

        if (editingSupplierId) {
            const supplier = retailerData.suppliers.find(s => s.id === editingSupplierId);
            if(supplier) Object.assign(supplier, { name, phone, address, gstin });
            document.getElementById('supplierSubmitBtn').innerText = lang.addSupplierBtn;
            editingSupplierId = null;
        } else {
            if (!Array.isArray(retailerData.suppliers)) retailerData.suppliers = [];
            if (retailerData.suppliers.some(s => s.phone === phone)) {
                alert("इस फ़ोन नंबर वाला आपूर्तिकर्ता पहले से मौजूद है।");
                return;
            }
            retailerData.suppliers.push({ id: Date.now(), name, phone, address, gstin });
        }
        saveData();
        renderSupplierTable();
        e.target.reset();
    };

    app.editSupplier = (supplierId) => {
        const supplier = allRetailerData[currentUserEmail].suppliers.find(s => s.id === supplierId);
        if (supplier) {
            editingSupplierId = supplierId;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierAddress').value = supplier.address || '';
            document.getElementById('supplierGstin').value = supplier.gstin || '';
            document.getElementById('supplierSubmitBtn').innerText = translations[currentLanguage].updateBtn;
            showTab('suppliers');
        }
    };

    app.deleteSupplier = (supplierId) => {
        if(confirm(translations[currentLanguage].confirmDeleteSupplier)) {
            const retailerData = allRetailerData[currentUserEmail];
            retailerData.suppliers = retailerData.suppliers.filter(s => s.id !== supplierId);
            saveData();
            renderAllUI();
        }
    };
    
    // --- ग्राहक फंक्शन ---
    const handleAddCustomer = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const name = document.getElementById('addCustomerName').value.trim();
        const phone = document.getElementById('addCustomerPhone').value.trim();
        const address = document.getElementById('addCustomerAddress').value.trim();
        const gstin = document.getElementById('addCustomerGstin').value.trim();
        const lang = translations[currentLanguage];
        if (!name || !phone) { alert(lang.fillAllFields); return; }

        if (editingCustomerId) {
            const customer = retailerData.customers.find(c => c.id === editingCustomerId);
            if (customer) { Object.assign(customer, { name, phone, address, gstin }); }
            document.getElementById('customerSubmitBtn').innerText = lang.addCustomerBtn;
            editingCustomerId = null;
        } else {
            if (!Array.isArray(retailerData.customers)) retailerData.customers = [];
            if (retailerData.customers.some(c => c.phone === phone)) {
                 alert("इस फ़ोन नंबर वाला ग्राहक पहले से मौजूद है।");
                 return;
            }
            retailerData.customers.push({ id: Date.now(), name, phone, address, gstin });
            alert(lang.customerAddedSuccess);
        }
        saveData();
        renderCustomerTable();
        e.target.reset();
    };

    app.editCustomer = (customerId) => {
        const customer = allRetailerData[currentUserEmail].customers.find(c => c.id === customerId);
        if (customer) {
            editingCustomerId = customerId;
            document.getElementById('addCustomerName').value = customer.name;
            document.getElementById('addCustomerPhone').value = customer.phone;
            document.getElementById('addCustomerAddress').value = customer.address || '';
            document.getElementById('addCustomerGstin').value = customer.gstin || '';
            document.getElementById('customerSubmitBtn').innerText = translations[currentLanguage].updateBtn;
            showTab('customers');
        }
    };

    // --- खरीद फंक्शन ---
    const calculatePurchasePrices = (source) => {
        const gstType = document.querySelector('input[name="gstType"]:checked').value;
        const basePriceEl = document.getElementById('purchaseBasePrice');
        const gstPercentEl = document.getElementById('purchaseGstPercent');
        const totalPriceEl = document.getElementById('purchaseTotalPrice');
        const profitValueEl = document.getElementById('purchaseProfitMarginValue');
        const profitTypeEl = document.getElementById('purchaseProfitMarginType');
        const sellingPriceEl = document.getElementById('purchaseSellingPrice');

        let basePrice = parseFloat(basePriceEl.value) || 0;
        let gstPercent = (gstType === 'with_gst') ? (parseFloat(gstPercentEl.value) || 0) : 0;
        let totalPrice = parseFloat(totalPriceEl.value) || 0;

        if (source === 'base' || source === 'gst') {
            totalPrice = basePrice * (1 + (gstPercent / 100));
            if(totalPrice > 0) totalPriceEl.value = totalPrice.toFixed(2);
        } else if (source === 'total') {
            basePrice = totalPrice / (1 + (gstPercent / 100));
            if(basePrice > 0) basePriceEl.value = basePrice.toFixed(2);
        }
        
        let profitValue = parseFloat(profitValueEl.value) || 0;
        let profitType = profitTypeEl.value;
        let finalSellingPrice = 0;
        
        const purchasePriceForProfitCalc = parseFloat(totalPriceEl.value) || 0;

        if (profitType === 'percent') {
            finalSellingPrice = purchasePriceForProfitCalc * (1 + (profitValue / 100));
        } else {
            finalSellingPrice = purchasePriceForProfitCalc + profitValue;
        }
        if(finalSellingPrice > 0) sellingPriceEl.value = finalSellingPrice.toFixed(2);
    };

    const renderPurchaseHistory = (supplierId = null) => {
        const retailerData = allRetailerData[currentUserEmail];
        const container = document.getElementById('tabPurchaseHistoryContainer');
        const lang = translations[currentLanguage];
        const suppliers = retailerData.suppliers || [];

        let entries = retailerData.purchaseEntries || [];
        if(supplierId) {
            entries = entries.filter(e => e.supplierId == supplierId);
        }
        
        entries = entries.slice().reverse().slice(0, 20); 

        if(entries.length === 0) {
            container.innerHTML = `<p>${lang.noPurchaseEntries}</p>`;
            return;
        }

        container.innerHTML = entries.map(entry => {
            const supplier = suppliers.find(s => s.id === entry.supplierId);
            const totalCost = (entry.item.totalPrice || 0) * (entry.item.quantity || 0);
            return `
            <div class="history-item">
                <p><strong>${lang.supplierName}</strong> ${supplier ? supplier.name : 'N/A'} | <strong>${lang.purchaseDate}:</strong> ${new Date(entry.date).toLocaleDateString()}</p>
                <p><strong>${lang.purchaseBillNo}:</strong> ${entry.purchaseBillNo || 'N/A'}</p>
                <p><strong>${lang.purchaseItems}:</strong> ${entry.item.name} (${entry.item.quantity} ${entry.item.unit}) @ ₹${totalCost.toFixed(2)}</p>
            </div>
        `}).join('');
    };
    
    app.showPurchaseHistoryForSupplier = (supplierId) => {
        const retailer = allRetailerData[currentUserEmail];
        const supplier = retailer.suppliers.find(s => s.id == supplierId);
        const entries = (retailer.purchaseEntries || []).filter(e => e.supplierId == supplierId).reverse();
        
        document.getElementById('history-modal-title').innerText = `${supplier.name} ${translations[currentLanguage].purchaseHistoryOf}`;
        const container = document.getElementById('historyContainer');
        const lang = translations[currentLanguage];
        if (entries.length === 0) {
            container.innerHTML = `<p>${lang.noPurchaseHistory}</p>`;
        } else {
            container.innerHTML = entries.map(entry => `
                <div class="history-item">
                    <p><strong>${lang.purchaseDate}:</strong> ${new Date(entry.date).toLocaleString()}</p>
                    ${entry.purchaseBillNo ? `<p><strong>${lang.purchaseBillNo}:</strong> ${entry.purchaseBillNo}</p>` : ''}
                    <p><strong>${lang.purchaseItems}:</strong> ${entry.item.name} (${entry.item.quantity} ${entry.item.unit})</p>
                    <p><strong>Total Cost:</strong> ₹${((entry.item.totalPrice || 0) * (entry.item.quantity || 0)).toFixed(2)}</p>
                     <div class="history-item-actions">
                        <button onclick="app.showPurchaseSlipPreview(${entry.id})" class="action-button print">${lang.printPurchaseNote}</button>
                        <button onclick="app.editPurchase(${entry.id})" class="action-button edit">${lang.editBtn}</button>
                    </div>
                </div>
            `).join('');
        }
        document.getElementById('history-modal').style.display = 'block';
    };


    const handleAddPurchaseEntry = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        
        const supplierName = document.getElementById('purchaseSupplierName').value.trim();
        const supplierPhone = document.getElementById('purchaseSupplierPhone').value.trim();
        const supplierAddress = document.getElementById('purchaseSupplierAddress').value.trim();
        const purchaseBillNo = document.getElementById('purchaseBillNo').value.trim();
        const purchaseBillDate = document.getElementById('purchaseBillDate').value;
        const productName = document.getElementById('purchaseProductName').value.trim();
        const hsnSac = document.getElementById('purchaseHsnSac').value.trim();
        const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
        const unit = document.getElementById('purchaseUnit').value;

        const basePrice = parseFloat(document.getElementById('purchaseBasePrice').value);
        const gstPercent = parseFloat(document.getElementById('purchaseGstPercent').value) || 0;
        const totalPrice = parseFloat(document.getElementById('purchaseTotalPrice').value);
        const profitMarginValue = parseFloat(document.getElementById('purchaseProfitMarginValue').value) || 0;
        const profitMarginType = document.getElementById('purchaseProfitMarginType').value;
        const sellingPrice = parseFloat(document.getElementById('purchaseSellingPrice').value);
        
        if (!supplierName || !supplierPhone || !productName || isNaN(basePrice) || basePrice <= 0 || isNaN(totalPrice) || totalPrice <= 0 || isNaN(sellingPrice) || sellingPrice <= 0 || isNaN(quantity) || quantity <= 0) {
            alert(lang.fillAllFields); return;
        }
        
        const purchaseItemObject = {
            name: productName, hsnSac: hsnSac || '', unit, quantity,
            basePrice, gstPercent, totalPrice,
            profitMarginValue, profitMarginType, sellingPrice
        };

        if(editingPurchaseId) {
             const purchaseToUpdate = retailerData.purchaseEntries.find(p => p.id === editingPurchaseId);
             if(purchaseToUpdate) {
                const oldInventoryItem = retailerData.inventory.find(item => item.name.toLowerCase() === purchaseToUpdate.item.name.toLowerCase());
                if(oldInventoryItem) oldInventoryItem.quantity -= purchaseToUpdate.item.quantity;

                Object.assign(purchaseToUpdate, {
                    purchaseBillNo, purchaseBillDate,
                    item: purchaseItemObject
                });
             }
             editingPurchaseId = null;
        } else {
            const supplier = getOrCreateSupplier(supplierName, supplierPhone, supplierAddress);
            if (!Array.isArray(retailerData.purchaseEntries)) retailerData.purchaseEntries = [];
            retailerData.purchaseEntries.push({
                id: Date.now(),
                supplierId: supplier.id,
                date: new Date().toISOString(),
                purchaseBillNo,
                purchaseBillDate,
                item: purchaseItemObject
            });
        }
        
        let inventoryItem = retailerData.inventory.find(item => item.name.toLowerCase() === productName.toLowerCase());
        if (inventoryItem) {
            inventoryItem.quantity += quantity;
            inventoryItem.price = sellingPrice;
            inventoryItem.purchasePrice = totalPrice;
            inventoryItem.gstPercent = gstPercent;
        } else {
            retailerData.inventory.push({ 
                id: Date.now(), 
                name: productName, 
                price: sellingPrice, 
                quantity, 
                unit,
                purchasePrice: totalPrice,
                gstPercent: gstPercent
            });
        }

        saveData();
        renderAllUI();
        document.getElementById('addPurchaseItemForm').reset();
        document.getElementById('purchaseSellingPrice').value = '';
        document.getElementById('purchaseBillDate').valueAsDate = new Date();
    };
    
    app.editPurchase = (purchaseId) => {
        const retailer = allRetailerData[currentUserEmail];
        const purchase = retailer.purchaseEntries.find(p => p.id === purchaseId);
        const supplier = retailer.suppliers.find(s => s.id === purchase.supplierId);
        if(!purchase || !supplier) return;

        editingPurchaseId = purchaseId;

        document.getElementById('purchaseSupplierName').value = supplier.name;
        document.getElementById('purchaseSupplierPhone').value = supplier.phone;
        document.getElementById('purchaseSupplierAddress').value = supplier.address || '';
        document.getElementById('purchaseBillNo').value = purchase.purchaseBillNo || '';
        document.getElementById('purchaseBillDate').value = purchase.purchaseBillDate || '';
        
        const item = purchase.item;
        document.getElementById('purchaseProductName').value = item.name;
        document.getElementById('purchaseHsnSac').value = item.hsnSac || '';
        document.getElementById('purchaseBasePrice').value = item.basePrice;
        document.getElementById('purchaseTotalPrice').value = item.totalPrice;
        document.getElementById('purchaseSellingPrice').value = item.sellingPrice;
        document.getElementById('purchaseQuantity').value = item.quantity;
        document.getElementById('purchaseUnit').value = item.unit;
        document.getElementById('purchaseProfitMarginValue').value = item.profitMarginValue || 0;
        document.getElementById('purchaseProfitMarginType').value = item.profitMarginType || 'percent';
        
        if(item.gstPercent > 0) {
            document.querySelector('input[name="gstType"][value="with_gst"]').checked = true;
            document.getElementById('gst-field-container').classList.remove('hidden');
            document.getElementById('purchaseGstPercent').value = item.gstPercent;
        } else {
             document.querySelector('input[name="gstType"][value="without_gst"]').checked = true;
             document.getElementById('gst-field-container').classList.add('hidden');
             document.getElementById('purchaseGstPercent').value = 0;
        }

        document.getElementById('history-modal').style.display = 'none';
        showTab('purchase');
    };
    
    const generatePurchaseSlipHTML = (purchaseEntry) => {
        const retailer = allRetailerData[currentUserEmail];
        const supplier = retailer.suppliers.find(s => s.id === purchaseEntry.supplierId);
        const item = purchaseEntry.item;
        const totalCost = item.totalPrice * item.quantity;
        const lang = translations[currentLanguage];

        return `<div style="background-color: #fff; color: #000; padding: 15px; font-family:'Courier New', monospace;">
            <div style="text-align:center;">
                <h3 style="margin:5px 0; font-weight:bold;">${lang.purchaseReportTitle}</h3>
                <p style="margin:2px 0; font-size: 12px;">${retailer.shopDetails.name}</p>
                 <hr style="border:1px dashed #333; margin: 8px 0;">
            </div>
            <p><strong>${lang.purchaseId}:</strong> ${purchaseEntry.id}</p>
            ${purchaseEntry.purchaseBillNo ? `<p><strong>${lang.purchaseBillNo}:</strong> ${purchaseEntry.purchaseBillNo}</p>`:''}
            <p><strong>${lang.purchaseDate}:</strong> ${new Date(purchaseEntry.date).toLocaleString()}</p>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <h4>${lang.supplierDetails}</h4>
            <p><strong>${lang.name}:</strong> ${supplier.name}</p>
            <p><strong>${lang.phoneColumn}:</strong> ${supplier.phone}</p>
            <p><strong>${lang.address}:</strong> ${supplier.address || 'N/A'}</p>
            ${supplier.gstin ? `<p><strong>${lang.gstinLabel}:</strong> ${supplier.gstin}</p>`:''}
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <h4>${lang.purchaseItems}</h4>
            <table style="width:100%; font-size:12px; border-collapse:collapse;">
                 <thead><tr><th style="text-align:left;">${lang.productColumn}</th><th style="text-align:center;">${lang.quantity}</th><th style="text-align:right;">${lang.purchasePrice}</th><th style="text-align:right;">${lang.total}</th></tr></thead>
                 <tbody>
                    <tr>
                        <td>${item.name}</td>
                        <td style="text-align:center;">${item.quantity} ${item.unit}</td>
                        <td style="text-align:right;">₹${item.totalPrice.toFixed(2)}</td>
                        <td style="text-align:right;">₹${totalCost.toFixed(2)}</td>
                    </tr>
                 </tbody>
            </table>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <div style="text-align:right; font-weight:bold; font-size: 15px;">
                <span>${lang.grandTotal}:</span><span>₹${totalCost.toFixed(2)}</span>
            </div>
        </div>`;
    };
    
    app.showPurchaseSlipPreview = (purchaseId) => {
        const purchase = allRetailerData[currentUserEmail].purchaseEntries.find(p => p.id === purchaseId);
        if(!purchase) return;
        
        const modal = document.getElementById('print-preview-modal');
        const contentDiv = document.getElementById('print-preview-content');
        contentDiv.innerHTML = generatePurchaseSlipHTML(purchase);
        
        document.querySelector('input[name="paper-size"][value="a4"]').checked = true;
        contentDiv.className = 'preview-a4';
        
        document.getElementById('history-modal').style.display = 'none';
        modal.style.display = 'block';
    };


    // --- खर्च फंक्शन ---
    const renderExpensesTable = () => {
        const expenses = allRetailerData[currentUserEmail]?.expenses || [];
        const lang = translations[currentLanguage];
        const tableBody = document.getElementById('expensesTableBody');
        tableBody.innerHTML = expenses.slice().reverse().map(exp => `
            <tr>
                <td>${exp.description}</td>
                <td>₹${exp.amount.toFixed(2)}</td>
                <td>${exp.date}</td>
                <td>
                    <button class="action-button delete" onclick="window.app.deleteExpense(${exp.id})">${lang.deleteBtn}</button>
                </td>
            </tr>
        `).join('');
    };

    const handleAddExpense = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const description = document.getElementById('expenseDescription').value.trim();
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const date = document.getElementById('expenseDate').value;
        const lang = translations[currentLanguage];

        if (!description || isNaN(amount) || amount <= 0 || !date) {
            alert(lang.fillAllFields);
            return;
        }

        if (!Array.isArray(retailerData.expenses)) retailerData.expenses = [];
        
        retailerData.expenses.push({ id: Date.now(), description, amount, date });
        saveData();
        renderExpensesTable();
        renderDashboard();
        alert(lang.expenseAddedSuccess);
        e.target.reset();
        document.getElementById('expenseDate').valueAsDate = new Date();
    };

    app.deleteExpense = (expenseId) => {
        if (confirm(translations[currentLanguage].deleteConfirm)) {
            const retailerData = allRetailerData[currentUserEmail];
            retailerData.expenses = retailerData.expenses.filter(exp => exp.id !== expenseId);
            saveData();
            renderExpensesTable();
            renderDashboard();
        }
    };
    
    // --- सेल टैब फंक्शन ---
    const renderSellInventoryList = () => {
        const inventory = allRetailerData[currentUserEmail]?.inventory || [];
        const lang = translations[currentLanguage];
        const tableBody = document.getElementById('sellInventoryTableBody');
        tableBody.innerHTML = inventory.map(item => {
            if (item.quantity <= 0) return '';
            return `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity} ${item.unit}</td>
                    <td>₹${item.price.toFixed(2)}</td>
                    <td>
                        <button class="action-button view" onclick="window.app.addProductToBillFromList(${item.id})">${lang.addToBill}</button>
                    </td>
                </tr>
            `;
        }).join('');
    };
    
    app.addProductToBillFromList = (productId) => {
        const product = allRetailerData[currentUserEmail].inventory.find(p => p.id === productId);
        if (product) {
            document.querySelector('input[name="itemType"][value="product"]').checked = true;
            document.getElementById('product-fields').classList.remove('hidden');
            document.getElementById('service-fields').classList.add('hidden');
            showItemCalculator(product);
            window.scrollTo(0, 0); // Scroll to top to see calculator
        }
    };

    const showItemCalculator = (product) => {
        productForCalculator = product;
        const calculator = document.getElementById('item-details-calculator');
        document.getElementById('calculatorProductName').innerText = product.name;
        document.getElementById('calcQuantity').value = 1;
        document.getElementById('calcUnit').value = product.unit;
        
        const basePrice = product.purchasePrice || 0;
        const gstPercent = product.gstPercent || 0;
        const sellingPrice = product.price || 0;
        
        document.getElementById('calcGstPercent').value = gstPercent;
        document.getElementById('calcTotalPrice').value = sellingPrice.toFixed(2);
        
        calculateItemPrice('total');
        
        calculator.classList.remove('hidden');
    };
    
    const calculateItemPrice = (source) => {
        if (!productForCalculator) return;
        const qty = parseFloat(document.getElementById('calcQuantity').value) || 1;
        let basePrice = parseFloat(document.getElementById('calcBasePrice').value) || 0;
        let gstPercent = parseFloat(document.getElementById('calcGstPercent').value) || 0;
        let totalPrice = parseFloat(document.getElementById('calcTotalPrice').value) || 0;

        if (source === 'base' || source === 'gst') {
            totalPrice = basePrice * (1 + (gstPercent / 100));
            document.getElementById('calcTotalPrice').value = totalPrice.toFixed(2);
        } else if (source === 'total') {
            basePrice = totalPrice / (1 + (gstPercent / 100));
            document.getElementById('calcBasePrice').value = basePrice.toFixed(2);
        }
        
        const lineTotal = qty * totalPrice;
        document.getElementById('calcLineTotal').innerText = lineTotal.toFixed(2);
    };

    const handleAddItemToBillFromCalculator = () => {
        const lang = translations[currentLanguage];
        const quantity = parseFloat(document.getElementById('calcQuantity').value);
        if (!productForCalculator || isNaN(quantity) || quantity <= 0) {
            alert(lang.fillAllFields);
            return;
        }
        if (quantity > productForCalculator.quantity) {
             alert(lang.stockUnavailable.replace('{quantity}', productForCalculator.quantity).replace('{unit}', productForCalculator.unit));
             return;
        }

        const basePrice = parseFloat(document.getElementById('calcBasePrice').value);
        const gstPercent = parseFloat(document.getElementById('calcGstPercent').value);
        const totalPricePerUnit = parseFloat(document.getElementById('calcTotalPrice').value);
        const lineTotal = parseFloat(document.getElementById('calcLineTotal').innerText);
        const gstAmountPerUnit = totalPricePerUnit - basePrice;
        
        const existingItem = currentBillItems.find(item => item.id === productForCalculator.id && item.type === 'product');
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.total = existingItem.quantity * existingItem.price;
        } else {
             currentBillItems.push({
                ...productForCalculator, type: 'product',
                quantity: quantity,
                basePrice: basePrice,
                gstPercent: gstPercent,
                gstAmount: gstAmountPerUnit,
                price: totalPricePerUnit,
                total: lineTotal
            });
        }
       
        updateCurrentBillDisplay();
        resetItemCalculator();
        document.getElementById('productSearchInput').value = '';
    };
    
    const handleAddServiceToBill = () => {
        const lang = translations[currentLanguage];
        const description = document.getElementById('serviceDescriptionInput').value.trim();
        const totalPrice = parseFloat(document.getElementById('serviceChargeInput').value);
        const gstType = document.querySelector('input[name="serviceGstType"]:checked').value;
        const gstPercent = (gstType === 'with_gst') ? parseFloat(document.getElementById('serviceGstPercent').value) || 0 : 0;

        if (!description || isNaN(totalPrice) || totalPrice <= 0) {
            alert(lang.fillAllFields);
            return;
        }

        let basePrice, gstAmount;

        if (gstPercent > 0) {
            basePrice = totalPrice / (1 + (gstPercent / 100));
            gstAmount = totalPrice - basePrice;
        } else {
            basePrice = totalPrice;
            gstAmount = 0;
        }

        currentBillItems.push({
            id: Date.now(),
            type: 'service',
            name: description,
            basePrice: basePrice,
            gstAmount: gstAmount,
            gstPercent: gstPercent,
            price: totalPrice,
            quantity: 1,
            total: totalPrice,
            unit: ''
        });

        updateCurrentBillDisplay();
        document.getElementById('serviceDescriptionInput').value = '';
        document.getElementById('serviceChargeInput').value = '';
        document.querySelector('input[name="serviceGstType"][value="without_gst"]').checked = true;
        document.getElementById('serviceGstPercent').value = 0;
        document.getElementById('service-gst-field-container').classList.add('hidden');
    };

    const resetItemCalculator = () => {
        document.getElementById('item-details-calculator').classList.add('hidden');
        productForCalculator = null;
    };
    
    // --- कैश फ्लो फंक्शन ---
    const renderCashFlow = () => {
        const retailer = allRetailerData[currentUserEmail];
        if(!retailer) return;

        if (!retailer.cashFlow) retailer.cashFlow = [];

        populateCashFlowParties();
        renderCashFlowTable();
        updateCashFlowSummary();

        document.getElementById('cashFlowDate').valueAsDate = new Date();
    };

    const populateCashFlowParties = () => {
        const retailer = allRetailerData[currentUserEmail];
        const select = document.getElementById('cashFlowParty');
        select.innerHTML = '<option value="none">कोई नहीं</option>';

        (retailer.customers || []).forEach(c => {
            const option = document.createElement('option');
            option.value = `customer-${c.id}`;
            option.textContent = `ग्राहक: ${c.name}`;
            select.appendChild(option);
        });

        (retailer.suppliers || []).forEach(s => {
            const option = document.createElement('option');
            option.value = `supplier-${s.id}`;
            option.textContent = `आपूर्तिकर्ता: ${s.name}`;
            select.appendChild(option);
        });
    };

    const renderCashFlowTable = () => {
        const retailer = allRetailerData[currentUserEmail];
        const cashFlow = retailer.cashFlow || [];
        const tableBody = document.getElementById('cashFlowTableBody');
        tableBody.innerHTML = cashFlow.slice().reverse().map(entry => {
            const amountClass = entry.type === 'in' ? 'cashflow-in' : 'cashflow-out';
            const amountPrefix = entry.type === 'in' ? '+' : '-';
            
            let partyName = entry.notes || 'N/A';
            if (entry.partyId !== 'none') {
                const [type, id] = entry.partyId.split('-');
                let foundParty;
                if(type === 'customer') {
                    foundParty = (retailer.customers || []).find(c => c.id == id);
                } else if (type === 'supplier') {
                    foundParty = (retailer.suppliers || []).find(s => s.id == id);
                }
                if(foundParty) partyName = `${foundParty.name} (${entry.notes})`;
            }

            return `<tr>
                        <td>${new Date(entry.date).toLocaleDateString()}</td>
                        <td>${partyName}</td>
                        <td class="${amountClass}">${amountPrefix} ₹${entry.amount.toFixed(2)}</td>
                    </tr>`;
        }).join('');
    };

    const updateCashFlowSummary = () => {
        const cashFlow = allRetailerData[currentUserEmail].cashFlow || [];
        const totalIn = cashFlow.filter(e => e.type === 'in').reduce((sum, e) => sum + e.amount, 0);
        const totalOut = cashFlow.filter(e => e.type === 'out').reduce((sum, e) => sum + e.amount, 0);
        const netBalance = totalIn - totalOut;

        document.getElementById('totalCashInDisplay').textContent = `₹${totalIn.toFixed(2)}`;
        document.getElementById('totalCashOutDisplay').textContent = `₹${totalOut.toFixed(2)}`;
        const netBalanceEl = document.getElementById('netBalanceDisplay');
        netBalanceEl.textContent = `₹${netBalance.toFixed(2)}`;
        netBalanceEl.className = netBalance >= 0 ? 'cashflow-in' : 'cashflow-out';
    };

    const handleAddCashFlow = (e) => {
        e.preventDefault();
        const retailer = allRetailerData[currentUserEmail];
        const type = document.getElementById('cashFlowType').value;
        const amount = parseFloat(document.getElementById('cashFlowAmount').value);
        const partyId = document.getElementById('cashFlowParty').value;
        const date = document.getElementById('cashFlowDate').value;
        const notes = document.getElementById('cashFlowNotes').value.trim();

        if (isNaN(amount) || amount <= 0 || !date) {
            alert(translations[currentLanguage].fillAllFields);
            return;
        }

        if(!Array.isArray(retailer.cashFlow)) retailer.cashFlow = [];

        retailer.cashFlow.push({ id: Date.now(), type, amount, partyId, date, notes });

        saveData();
        renderCashFlowTable();
        updateCashFlowSummary();
        e.target.reset();
        document.getElementById('cashFlowDate').valueAsDate = new Date();
    };

    const handleThemeToggle = (e) => {
        const isChecked = e.target.checked;
        document.body.classList.toggle('dark-mode', isChecked);
        localStorage.setItem('theme', isChecked ? 'dark' : 'light');
        document.getElementById('theme-toggle-sidebar').checked = isChecked;
    };

    const attachAllEventListeners = () => {
        document.getElementById('goToLoginBtn').addEventListener('click', () => showPage('login-page'));
        document.getElementById('goToSignUpBtn').addEventListener('click', () => showPage('signup-page'));
        document.getElementById('loginBackBtn').addEventListener('click', () => showPage('welcome-page'));
        document.getElementById('signupBackBtn').addEventListener('click', () => showPage('welcome-page'));
        document.getElementById('logoutBtnSidebar').addEventListener('click', logout);
        
        document.getElementById('headerSettingsBtn').addEventListener('click', () => {
             document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
             document.querySelector('.tab-link[data-tab="profile"]').classList.add('active');
             document.getElementById('profile-sidebar').classList.add('open');
             document.getElementById('sidebar-overlay').classList.remove('hidden');
        });
        
        document.getElementById('appTabsContainer').addEventListener('click', (e) => {
            if (e.target.matches('.tab-link')) {
                const tabName = e.target.dataset.tab;
                if (tabName === 'profile') {
                    document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById('profile-sidebar').classList.add('open');
                    document.getElementById('sidebar-overlay').classList.remove('hidden');
                } else if (tabName) {
                    showTab(tabName);
                }
            }
        });

        document.getElementById('closeProfileSidebarBtn').addEventListener('click', closeProfileSidebar);
        document.getElementById('sidebar-overlay').addEventListener('click', closeProfileSidebar);
        
        document.getElementById('language-select').addEventListener('change', (e) => setLanguage(e.target.value));

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('signupForm').addEventListener('submit', handleSignup);
        
        document.getElementById('addItemToBillBtn').addEventListener('click', handleAddItemToBillFromCalculator);
        document.getElementById('addServiceToBillBtn').addEventListener('click', handleAddServiceToBill);

        document.getElementById('printStockBtn').addEventListener('click', handlePrintStock);
        document.getElementById('saveStockPdfBtn').addEventListener('click', handleSaveStockPdf);
        document.getElementById('saveProfileBtn').addEventListener('click', handleSaveProfile);
        document.getElementById('generateBillBtn').addEventListener('click', handleGenerateBill);
        document.getElementById('addExpenseForm').addEventListener('submit', handleAddExpense);
        document.getElementById('addCashFlowForm').addEventListener('submit', handleAddCashFlow);

        document.getElementById('createBackupBtn').addEventListener('click', handleCreateBackup);
        document.getElementById('restoreBackupBtn').addEventListener('click', () => document.getElementById('restoreFileInput').click());
        document.getElementById('restoreFileInput').addEventListener('change', handleRestoreBackup);
        
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); showPage('reset-password-page'); });
        document.getElementById('resetBackBtn').addEventListener('click', () => showPage('login-page'));
        document.getElementById('verifyEmailBtn').addEventListener('click', handleVerifyEmail);
        document.getElementById('resetPasswordForm').addEventListener('submit', handleResetPassword);

        document.getElementById('addSupplierForm').addEventListener('submit', handleAddSupplier);
        document.getElementById('addCustomerForm').addEventListener('submit', handleAddCustomer);
        document.getElementById('addPurchaseItemForm').addEventListener('submit', handleAddPurchaseEntry);

        document.querySelectorAll('input[name="gstType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const gstField = document.getElementById('gst-field-container');
                if (e.target.value === 'with_gst') {
                    gstField.classList.remove('hidden');
                } else {
                    gstField.classList.add('hidden');
                    document.getElementById('purchaseGstPercent').value = 0;
                }
                calculatePurchasePrices('gst');
            });
        });

        document.getElementById('purchaseBasePrice').addEventListener('input', () => calculatePurchasePrices('base'));
        document.getElementById('purchaseGstPercent').addEventListener('input', () => calculatePurchasePrices('base'));
        document.getElementById('purchaseTotalPrice').addEventListener('input', () => calculatePurchasePrices('total'));
        document.getElementById('purchaseProfitMarginValue').addEventListener('input', () => calculatePurchasePrices('profit'));
        document.getElementById('purchaseProfitMarginType').addEventListener('change', () => calculatePurchasePrices('profit'));


        document.querySelectorAll('input[name="serviceGstType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const gstField = document.getElementById('service-gst-field-container');
                if (e.target.value === 'with_gst') {
                    gstField.classList.remove('hidden');
                } else {
                    gstField.classList.add('hidden');
                    document.getElementById('serviceGstPercent').value = 0;
                }
            });
        });

        document.querySelectorAll('input[name="itemType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const productFields = document.getElementById('product-fields');
                const serviceFields = document.getElementById('service-fields');
                const inventoryList = document.getElementById('sell-inventory-list-container');
                if (e.target.value === 'product') {
                    productFields.classList.remove('hidden');
                    inventoryList.classList.remove('hidden');
                    serviceFields.classList.add('hidden');
                } else {
                    productFields.classList.add('hidden');
                    inventoryList.classList.add('hidden');
                    serviceFields.classList.remove('hidden');
                    resetItemCalculator();
                }
            });
        });
        
        ['calcQuantity', 'calcGstPercent'].forEach(id => document.getElementById(id).addEventListener('input', () => calculateItemPrice('gst')));
        document.getElementById('calcBasePrice').addEventListener('input', () => calculateItemPrice('base'));
        document.getElementById('calcTotalPrice').addEventListener('input', () => calculateItemPrice('total'));

        
        ['discountInput', 'discountType'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateFinalTotal);
        });


        document.getElementById('downloadSalesPdfBtn').addEventListener('click', () => generateSalesReport('pdf'));
        document.getElementById('downloadSalesCsvBtn').addEventListener('click', () => generateSalesReport('csv'));
        document.getElementById('downloadPurchasePdfBtn').addEventListener('click', () => generatePurchaseReport('pdf'));
        document.getElementById('downloadPurchaseCsvBtn').addEventListener('click', () => generatePurchaseReport('csv'));
        document.getElementById('downloadStockReportPdfBtn').addEventListener('click', generateStockReportPdf);
        document.getElementById('downloadStockReportCsvBtn').addEventListener('click', generateStockReportCsv);
        document.getElementById('downloadCustomersPdfBtn').addEventListener('click', generateCustomerReportPdf);
        document.getElementById('downloadCustomersCsvBtn').addEventListener('click', generateCustomerReportCsv);
        
        // --- ग्राहक खोज ---
        const customerSearchInput = document.getElementById('billingCustomerName');
        const customerSearchResultsContainer = document.getElementById('customerSearchResultsContainer');
        customerSearchInput.addEventListener('input', () => {
            const searchTerm = customerSearchInput.value.toLowerCase().trim();
            customerSearchResultsContainer.innerHTML = ''; 
            if (searchTerm.length === 0) { customerSearchResultsContainer.classList.add('hidden'); return; }
            const matches = (allRetailerData[currentUserEmail]?.customers || []).filter(c => c.name.toLowerCase().includes(searchTerm) || c.phone.includes(searchTerm));
            if (matches.length > 0) {
                matches.forEach(customer => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-item';
                    itemDiv.textContent = `${customer.name} - ${customer.phone}`;
                    itemDiv.onclick = () => { document.getElementById('billingCustomerName').value = customer.name; document.getElementById('billingCustomerPhone').value = customer.phone; document.getElementById('billingCustomerAddress').value = customer.address || ''; customerSearchResultsContainer.classList.add('hidden'); };
                    customerSearchResultsContainer.appendChild(itemDiv);
                });
                customerSearchResultsContainer.classList.remove('hidden');
            } else { customerSearchResultsContainer.classList.add('hidden'); }
        });

        // --- उत्पाद खोज ---
        const searchInput = document.getElementById('productSearchInput');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        searchInput.addEventListener('input', () => {
            if (productForCalculator) {
                resetItemCalculator();
            }
            const searchTerm = searchInput.value.toLowerCase();
            searchResultsContainer.innerHTML = '';
            if (searchTerm.length === 0) { 
                searchResultsContainer.classList.add('hidden'); 
                return; 
            }
            const matches = (allRetailerData[currentUserEmail]?.inventory || []).filter(p => p.name.toLowerCase().includes(searchTerm) && p.quantity > 0);
            if (matches.length > 0) {
                const stockText = translations[currentLanguage].inStock;
                matches.forEach(product => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-item';
                    itemDiv.innerHTML = `${product.name} <small>(${stockText}: ${product.quantity} ${product.unit})</small>`;
                    itemDiv.onclick = () => { 
                        searchInput.value = product.name; 
                        searchResultsContainer.classList.add('hidden'); 
                        showItemCalculator(product);
                    };
                    searchResultsContainer.appendChild(itemDiv);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.classList.add('hidden');
            }
        });
        
        // --- आपूर्तिकर्ता खोज ---
        const supplierSearchInput = document.getElementById('purchaseSupplierName');
        const supplierSearchResultsContainer = document.getElementById('supplierPurchaseSearchResultsContainer');
        supplierSearchInput.addEventListener('input', () => {
             const searchTerm = supplierSearchInput.value.toLowerCase().trim();
             supplierSearchResultsContainer.innerHTML = '';
             if (searchTerm.length === 0) { supplierSearchResultsContainer.classList.add('hidden'); return; }
             const matches = (allRetailerData[currentUserEmail]?.suppliers || []).filter(s => s.name.toLowerCase().includes(searchTerm) || s.phone.includes(searchTerm));
             if(matches.length > 0) {
                 matches.forEach(supplier => {
                     const itemDiv = document.createElement('div');
                     itemDiv.className = 'search-item';
                     itemDiv.textContent = `${supplier.name} - ${supplier.phone}`;
                     itemDiv.onclick = () => {
                         document.getElementById('purchaseSupplierName').value = supplier.name;
                         document.getElementById('purchaseSupplierPhone').value = supplier.phone;
                         document.getElementById('purchaseSupplierAddress').value = supplier.address || '';
                         supplierSearchResultsContainer.classList.add('hidden');
                     };
                     supplierSearchResultsContainer.appendChild(itemDiv);
                 });
                 supplierSearchResultsContainer.classList.remove('hidden');
             } else {
                 supplierSearchResultsContainer.classList.add('hidden');
             }
        });


        document.addEventListener('click', (e) => { 
            if (!e.target.closest('.search-container')) { 
                document.querySelectorAll('.search-results').forEach(el => el.classList.add('hidden'));
            } 
        });
        
        document.getElementById('closeBillModalBtn').addEventListener('click', (e) => {
            document.getElementById('bill-modal').style.display = 'none';
            if (e.target.dataset.isReprint !== "true") {
                localStorage.setItem('billCounter', billCounter);
                resetBillForm();
            }
            e.target.dataset.isReprint = "false";
            currentBillForModal = null;
        });
        
        document.getElementById('closeHistoryModalBtn').addEventListener('click', () => { document.getElementById('history-modal').style.display = 'none'; });

        document.getElementById('sendWhatsAppBtn').addEventListener('click', () => {
            const lang = translations[currentLanguage];
            if (!currentBillForModal) { alert(lang.noBillToShare); return; }
            const bill = currentBillForModal;
            const retailer = allRetailerData[currentUserEmail];
            const customer = retailer.customers.find(c => c.id == bill.customerId);
            if (!retailer || !customer) { alert(lang.noBillToShare); return; }
            
            const message = `*${retailer.shopDetails.name}*\n\n*${lang.customer}:* ${customer.name}\n*${lang.mobile}:* ${customer.phone}\n\n*${lang.billNo}:* ${bill.billNo}\n*${lang.date}:* ${bill.date} ${bill.time}\n----------------------------------\n${bill.items.map(item => `${item.name} (${item.type === 'product' ? item.quantity + ' ' + item.unit : ''}) - ₹${item.total.toFixed(2)}`).join('\n')}\n----------------------------------\n${lang.subTotalBill} ₹${bill.subTotal.toFixed(2)}\n${lang.totalGst}: +₹${bill.totalGst.toFixed(2)}\n${lang.discountBill} -₹${bill.discountAmount.toFixed(2)}\n\n*${lang.grandTotalBill}* *₹${bill.total.toFixed(2)}*\n\n${lang.visitAgain} ${lang.thanksForShopping}\n\nPowered by My Billing App:\n${appLink}`;
            
            let customerPhone = customer.phone.replace(/[^0-9]/g, '');
            if (customerPhone.length === 10) {
                customerPhone = '91' + customerPhone;
            }

            const isMobile = /Mobi/i.test(window.navigator.userAgent);
            const whatsappUrl = isMobile 
                ? `https://wa.me/${customerPhone}?text=${encodeURIComponent(message)}`
                : `https://web.whatsapp.com/send?phone=${customerPhone}&text=${encodeURIComponent(message)}`;

            window.open(whatsappUrl, '_blank');
        });

        document.getElementById('shareBillImageBtn').addEventListener('click', () => {
            const billElement = document.getElementById('bill-to-print');
            const lang = translations[currentLanguage];
            if (!billElement) { alert(lang.noBillToShare); return; }
            const button = document.getElementById('shareBillImageBtn');
            const originalText = button.innerText;
            button.innerText = lang.preparing; button.disabled = true;
            html2canvas(billElement, { scale: 2.5, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                canvas.toBlob(function(blob) {
                    const file = new File([blob], 'bill.png', { type: 'image/png' });
                    const shareText = `${lang.thanksForShopping}\n\nDownload our app:\n${appLink}`;
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({ files: [file], title: lang.currentBill, text: shareText }).finally(() => { button.innerText = originalText; button.disabled = false; });
                    } else {
                        const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'bill.png';
                        document.body.appendChild(link); link.click(); document.body.removeChild(link);
                        alert(lang.imageDownloaded);
                        button.innerText = originalText; button.disabled = false;
                    }
                }, 'image/png');
            }).catch(err => { console.error("Image creation failed!", err); alert(lang.imageCreationFailed); button.innerText = originalText; button.disabled = false; });
        });

        // प्रिंट प्रीव्यू इवेंट्स
        document.getElementById('printBillBtn').addEventListener('click', () => {
            const printPreviewModal = document.getElementById('print-preview-modal');
            const previewContent = document.getElementById('print-preview-content');
            const billHTML = document.getElementById('bill-to-print-container').innerHTML;
            previewContent.innerHTML = billHTML;
            document.querySelector('input[name="paper-size"][value="a4"]').checked = true; // Default to A4
            previewContent.className = 'preview-a4';
            printPreviewModal.style.display = 'block';
        });

        document.getElementById('close-print-preview-btn').addEventListener('click', () => {
            document.getElementById('print-preview-modal').style.display = 'none';
        });
        
        document.querySelectorAll('input[name="paper-size"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const size = e.target.value;
                const previewContent = document.getElementById('print-preview-content');
                previewContent.className = `preview-${size}`;
            });
        });

        document.getElementById('execute-print-btn').addEventListener('click', () => {
            const paperSize = document.querySelector('input[name="paper-size"]:checked').value;
            const billContentHTML = document.getElementById('print-preview-content').innerHTML;
            const printArea = document.querySelector('.printable-area-for-print');
            let styleText = '';

            switch (paperSize) {
                case '58mm':
                    styleText = `@page { size: 58mm auto; margin: 1.5mm; } body { margin: 0; } .printable-area-for-print { width: 55mm; font-size: 8pt !important; } .printable-area-for-print * { font-size: 8pt !important; }`;
                    break;
                case '80mm':
                    styleText = `@page { size: 80mm auto; margin: 2mm; } body { margin: 0; } .printable-area-for-print { width: 76mm; font-size: 10pt !important; } .printable-area-for-print * { font-size: 10pt !important; }`;
                    break;
                case 'a4':
                default:
                    styleText = `@page { size: A4; margin: 20mm; } body { margin: 0; }`;
                    break;
            }
            
            document.getElementById('dynamic-print-style').innerHTML = styleText;
            printArea.innerHTML = billContentHTML;
            
            window.print();
            
            printArea.innerHTML = ''; // Clean up after print
            document.getElementById('dynamic-print-style').innerHTML = '';
        });

        document.getElementById('theme-toggle-sidebar').addEventListener('change', handleThemeToggle);
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle-sidebar').checked = true;
        }
        
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        
        document.querySelectorAll('.image-upload-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    currentCropTarget = e.target.dataset.target; // 'logo', 'signature', 'stamp'
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imageToCrop.src = event.target.result;
                        cropperModal.style.display = 'block';
                        if(cropper) cropper.destroy();
                        const aspectRatio = (currentCropTarget === 'logo') ? 1 : NaN; // Square for logo, free for others
                        cropper = new Cropper(imageToCrop, { aspectRatio: aspectRatio, viewMode: 1, background: false });
                    };
                    reader.readAsDataURL(files[0]);
                }
            });
        });

        document.getElementById('crop-and-save-btn').addEventListener('click', () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({ width: 250, height: 250 });
                const previewElId = `${currentCropTarget}Preview`;
                document.getElementById(previewElId).src = canvas.toDataURL('image/png');
                cropper.destroy();
                cropperModal.style.display = 'none';
                document.getElementById(`${currentCropTarget}Upload`).value = '';
            }
        });

        document.getElementById('close-cropper-modal-btn').addEventListener('click', () => {
            if(cropper) cropper.destroy();
            cropperModal.style.display = 'none';
            if(currentCropTarget) document.getElementById(`${currentCropTarget}Upload`).value = '';
        });
    };
    
    const generateSalesReport = (format) => {
        const retailer = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        let fromDate = document.getElementById('salesReportFromDate').value;
        let toDate = document.getElementById('salesReportToDate').value;
        if (!fromDate || !toDate) { alert(lang.fillAllFields); return; }
        fromDate = new Date(fromDate); fromDate.setHours(0, 0, 0, 0);
        toDate = new Date(toDate); toDate.setHours(23, 59, 59, 999);
        const filteredBills = (retailer.bills || []).filter(bill => { const [d, m, y] = bill.date.split('-'); return new Date(`${y}-${m}-${d}`) >= fromDate && new Date(`${y}-${m}-${d}`) <= toDate; });
        if (filteredBills.length === 0) { alert(lang.noDataFound); return; }
        const headers = [lang.billNo, lang.billDate, lang.customerName, lang.total];
        const data = filteredBills.map(bill => [bill.billNo, bill.date, (retailer.customers.find(c => c.id === bill.customerId) || {}).name || 'N/A', bill.total.toFixed(2)]);
        const reportTitle = `${lang.salesReportTitle} (${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()})`;
        if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(reportTitle, 14, 15);
            doc.autoTable({ head: [headers], body: data, startY: 20 });
            doc.save(`Sales-Report-${Date.now()}.pdf`);
        } else if (format === 'csv') {
            downloadCsv(`Sales-Report-${Date.now()}.csv`, headers, data.map(row => [row[0], row[1], row[2], row[3]]));
        }
    };
    
    const generatePurchaseReport = (format) => {
        const retailer = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        let fromDate = document.getElementById('purchaseReportFromDate').value;
        let toDate = document.getElementById('purchaseReportToDate').value;
        if (!fromDate || !toDate) { alert(lang.fillAllFields); return; }
        fromDate = new Date(fromDate); fromDate.setHours(0, 0, 0, 0);
        toDate = new Date(toDate); toDate.setHours(23, 59, 59, 999);
        const filteredPurchases = (retailer.purchaseEntries || []).filter(entry => new Date(entry.date) >= fromDate && new Date(entry.date) <= toDate);
        if (filteredPurchases.length === 0) { alert(lang.noDataFound); return; }
        const headers = [lang.purchaseId, lang.date, lang.supplierName, lang.productName, lang.quantity, lang.totalColumn];
        const data = filteredPurchases.map(entry => {
            const supplier = (retailer.suppliers.find(s => s.id === entry.supplierId) || {}).name || 'N/A';
            const totalCost = ((entry.item.totalPrice || 0) * (entry.item.quantity || 0)).toFixed(2);
            return [entry.id, new Date(entry.date).toLocaleDateString(), supplier, entry.item.name, `${entry.item.quantity} ${entry.item.unit}`, totalCost];
        });
        const reportTitle = `${lang.purchaseReportTitle} (${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()})`;
        if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(reportTitle, 14, 15);
            doc.autoTable({ head: [headers], body: data, startY: 20 });
            doc.save(`Purchase-Report-${Date.now()}.pdf`);
        } else if (format === 'csv') {
            downloadCsv(`Purchase-Report-${Date.now()}.csv`, headers, data);
        }
    };

    const generateStockReportPdf = () => {
        const { jsPDF } = window.jspdf;
        const lang = translations[currentLanguage];
        const doc = new jsPDF();
        doc.text(lang.stockReport, 14, 15);
        const tableData = (allRetailerData[currentUserEmail].inventory || []).map(p => [p.name, p.price.toFixed(2), p.quantity, p.unit]);
        doc.autoTable({ head: [[lang.productColumn, lang.priceColumn, lang.quantityColumn, lang.unitLabel]], body: tableData, startY: 20 });
        doc.save(`${lang.stockReport}-${Date.now()}.pdf`);
    };

    const generateStockReportCsv = () => {
        const lang = translations[currentLanguage];
        const headers = [lang.productColumn, lang.priceColumn, lang.quantityColumn, lang.unitLabel];
        const data = (allRetailerData[currentUserEmail].inventory || []).map(p => [p.name, p.price.toFixed(2), p.quantity, p.unit]);
        downloadCsv(`Stock-Report-${Date.now()}.csv`, headers, data);
    };

    const generateCustomerReportPdf = () => {
        const { jsPDF } = window.jspdf;
        const lang = translations[currentLanguage];
        const doc = new jsPDF();
        doc.text(lang.customerList, 14, 15);
        const tableData = (allRetailerData[currentUserEmail].customers || []).map(c => [c.name, c.phone, c.address || '']);
        doc.autoTable({ head: [[lang.nameColumn, lang.phoneColumn, lang.customerAddress]], body: tableData, startY: 20 });
        doc.save(`Customer-List-${Date.now()}.pdf`);
    };
    
    const generateCustomerReportCsv = () => {
        const lang = translations[currentLanguage];
        const headers = [lang.nameColumn, lang.phoneColumn, lang.customerAddress];
        const data = (allRetailerData[currentUserEmail].customers || []).map(c => [c.name, c.phone, c.address || '']);
        downloadCsv(`Customer-List-${Date.now()}.csv`, headers, data);
    };

    // --- ऐप शुरू करें ---
    attachAllEventListeners();
    initializeApp();
});
</script>

</body>
</html>