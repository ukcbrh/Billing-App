<!DOCTYPE html>
<html lang="hi" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अंतिम मल्टी-रिटेलर बिलिंग सिस्टम</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
    <!-- बिल को इमेज में बदलने के लिए लाइब्रेरी -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #fff;
            --text-color: #2c3e50;
            --border-color: #ccc;
            --input-bg: #fff;
            --primary-color: #3498db;
            --shadow-color: rgba(0,0,0,0.1);
        }
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --input-bg: #2c2c2c;
            --primary-color: #4a90e2;
            --shadow-color: rgba(255,255,255,0.1);
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        /* RTL सपोर्ट */
        [dir="rtl"] label, [dir="rtl"] h4, [dir="rtl"] p { text-align: right; }
        [dir="rtl"] .bill-summary-row { justify-content: flex-end; }
        [dir="rtl"] .bill-summary-row span:first-child { margin-left: 10px; }
        [dir="rtl"] .bill-summary-row span:last-child { margin-left: 0; margin-right: auto; }

        .container { max-width: 1100px; margin: 20px auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
        .form-container { max-width: 500px; }
        .hidden { display: none; }
        h1, h2, h3, h4 { color: var(--text-color); text-align: center; margin-top: 0; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        h4 { text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; text-align: left; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color); }
        button { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .action-button { width: auto; padding: 5px 10px; font-size: 14px; margin-right: 5px; }
        .action-button.edit { background-color: #f39c12; }
        .action-button.delete { background-color: #e74c3c; }
        .app-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-link.active { border-bottom-color: var(--primary-color); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .main-layout { display: grid; gap: 30px; grid-template-columns: 1fr 1.5fr; }
        .customer-details-grid { display: grid; gap: 20px; grid-template-columns: 1fr 1fr; }
        @media (max-width: 768px) { .main-layout, .profile-layout, .customer-details-grid { grid-template-columns: 1fr; } }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--container-bg); margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 450px; font-family: 'Segoe UI', sans-serif; border-radius: 8px; }
        body.dark-mode .modal-content { border-color: #555; }
        .bill-summary-row { display: flex; justify-content: space-between; font-size: 1.1em; padding: 5px 0; }
        .bill-summary-row.grand-total { font-weight: bold; font-size: 1.3em; border-top: 2px solid var(--text-color); margin-top: 10px; padding-top: 10px;}
        .search-container { position: relative; }
        .search-results { position: absolute; width: 100%; border: 1px solid var(--border-color); background-color: var(--container-bg); z-index: 99; max-height: 200px; overflow-y: auto; }
        .search-item { padding: 10px; cursor: pointer; } .search-item:hover { background-color: rgba(0,0,0,0.1); }
        body.dark-mode .search-item:hover { background-color: rgba(255,255,255,0.1); }
        .history-item { border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .history-item-actions button { width: auto; font-size: 12px; padding: 6px 10px; margin-top: 5px; margin-right: 10px; }
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: flex-end; margin-left: 20px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .backup-container { padding: 20px; text-align: center; border: 2px dashed var(--border-color); border-radius: 8px; }
        .backup-container button { width: auto; max-width: 250px; }
        @media print { body * { visibility: hidden; } .printable-area, .printable-area * { visibility: visible; } .printable-area { position: absolute; left: 0; top: 0; margin: 0; padding: 20px; color: #000 !important; } .no-print { display: none; } #bill-to-print-container { background-color: #fff !important; } }
    </style>
</head>
<body>

    <!-- सभी पेज -->
    <div id="welcome-page" class="container form-container">
        <div style="text-align: center;">
            <img src="logo.png" alt="App Logo" style="max-width: 150px; margin-bottom: 20px;">
        </div>
        <h2 style="border:none;">Welcome Billing App</h2>
        <div style="text-align:center;">
            <button id="goToLoginBtn" data-lang-key="login">लॉगिन करें</button>
            <button id="goToSignUpBtn" data-lang-key="createAccount">नया अकाउंट बनाएं</button>
        </div>
    </div>
    <div id="signup-page" class="container form-container hidden"><button class="back-btn" id="signupBackBtn" data-lang-key="back">← वापस</button><h2 data-lang-key="createAccount">नया अकाउंट बनाएं</h2><form id="signupForm"><label data-lang-key="shopNameLabel">दुकान का नाम:</label><input type="text" id="signupShopName" required><label data-lang-key="emailLabel">ईमेल:</label><input type="email" id="signupEmail" required><label data-lang-key="mobileLabel">मोबाइल:</label><input type="tel" id="signupPhone" required><label data-lang-key="passwordLabel">पासवर्ड:</label><input type="password" id="signupPassword" required><button type="submit" data-lang-key="signUp">साइन अप</button></form></div>
    <div id="login-page" class="container form-container hidden"><button class="back-btn" id="loginBackBtn" data-lang-key="back">← वापस</button><h2 data-lang-key="login">लॉगिन करें</h2><form id="loginForm"><label data-lang-key="emailOrMobileLabel">ईमेल या मोबाइल:</label><input type="text" id="loginIdentifier" required><label data-lang-key="passwordLabel">पासवर्ड:</label><input type="password" id="loginPassword" required><button type="submit" data-lang-key="login">लॉगिन करें</button></form></div>
    
    <!-- मुख्य एप्लीकेशन -->
    <div id="main-app" class="container hidden">
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
            <select id="language-select" style="width: auto; padding: 5px; margin-right: 15px;">
                <option value="hi">हिंदी</option>
                <option value="en">English</option>
                <option value="ur">اردو</option>
            </select>
            <div class="theme-switch-wrapper"><label class="theme-switch" for="theme-toggle"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label></div>
            <button id="logoutBtn" style="width: auto; margin-left:20px;" data-lang-key="logout">लॉगआउट</button>
        </div>
        <h2 id="retailerShopName"></h2>
        <hr>
        <div class="app-tabs" id="appTabsContainer"><span class="tab-link active" data-tab="billing" data-lang-key="billingTab">बिलिंग</span><span class="tab-link" data-tab="inventory" data-lang-key="inventoryTab">इन्वेंटरी</span><span class="tab-link" data-tab="customers" data-lang-key="customersTab">ग्राहक</span><span class="tab-link" data-tab="profile" data-lang-key="profileTab">प्रोफ़ाइल</span><span class="tab-link" data-tab="backup" data-lang-key="backupRestoreTab">बैकअप/रिस्टोर</span></div>
        <div id="billing-tab" class="tab-content active">
             <div class="main-layout">
                <div>
                    <h4 data-lang-key="customerDetails">ग्राहक का विवरण</h4>
                    <form id="customerDetailsForm">
                        <div class="customer-details-grid">
                            <div class="search-container">
                                <label data-lang-key="customerName">ग्राहक का नाम:</label>
                                <input type="text" id="billingCustomerName" autocomplete="off">
                                <div id="customerSearchResultsContainer" class="search-results hidden"></div>
                            </div>
                            <div>
                                <label data-lang-key="customerPhone">ग्राहक का फ़ोन:</label>
                                <input type="tel" id="billingCustomerPhone" required>
                            </div>
                        </div>
                        <label data-lang-key="customerAddress">ग्राहक का पता:</label>
                        <textarea id="billingCustomerAddress" rows="1"></textarea>
                    </form>
                    <hr style="margin:20px 0;">
                    <h4 data-lang-key="addItem">आइटम जोड़ें</h4>
                    <form id="addItemForm">
                        <div class="search-container"><label data-lang-key="productSearch">उत्पाद खोजें:</label><input type="text" id="productSearchInput" autocomplete="off"><div id="searchResultsContainer" class="search-results hidden"></div></div>
                        <label data-lang-key="quantity">मात्रा:</label><input type="number" id="itemQuantity" min="0.01" step="0.01" value="1" required>
                        <button type="submit" data-lang-key="addToBill">बिल में जोड़ें</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="currentBill">वर्तमान बिल</h4>
                    <table class="data-table"><thead><tr><th data-lang-key="productColumn">उत्पाद</th><th data-lang-key="quantityColumn">मात्रा</th><th data-lang-key="priceColumn">मूल्य</th><th data-lang-key="totalColumn">कुल</th></tr></thead><tbody id="currentBillBody"></tbody></table>
                    <div style="text-align:right; margin-top:15px;" id="billSummary">
                        <div class="bill-summary-row"><span data-lang-key="subTotal">उप-योग (Subtotal):</span><span>₹<span id="subTotalDisplay">0.00</span></span></div>
                        <div class="bill-summary-row" style="align-items:center;"><label for="discountInput" style="margin:0; text-align:right; margin-right:10px;" data-lang-key="discount">डिस्काउंट:</label><div style="display:flex; width: 60%;"><input type="number" id="discountInput" style="width: 70%; margin:0;" value="0"><select id="discountType" style="width: 30%; margin:0; padding:10px 5px;"><option value="percent">%</option><option value="fixed">₹</option></select></div></div>
                        <div class="bill-summary-row"><span data-lang-key="gst">GST (%):</span><input type="number" id="gstInput" value="0" style="width:60%; margin:0;"></div>
                        <div class="bill-summary-row grand-total"><span data-lang-key="grandTotal">कुल देय:</span><span>₹<span id="grandTotalDisplay">0.00</span></span></div>
                    </div>
                    <button id="generateBillBtn" style="margin-top: 20px;" data-lang-key="generateBill">बिल बनाएं</button>
                </div>
            </div>
        </div>
        <div id="inventory-tab" class="tab-content"><div class="main-layout"><div><h4 data-lang-key="addProduct">नया उत्पाद जोड़ें</h4><form id="stockForm"><label data-lang-key="productName">उत्पाद का नाम:</label><input type="text" id="productName" required><div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;"><div><label data-lang-key="priceLabel">मूल्य (₹):</label><input type="number" id="productPrice" required></div><div><label data-lang-key="unitLabel">इकाई:</label><select id="productUnit"><option>Pcs</option><option>Kg</option><option>Gm</option><option>Ltr</option><option>Mtr</option></select></div></div><label data-lang-key="stockQuantity">स्टॉक मात्रा:</label><input type="number" id="productQuantity" required><button type="submit" id="stockSubmitBtn" data-lang-key="addToStock">स्टॉक में जोड़ें</button></form></div><div id="inventoryToPrint"><h4 data-lang-key="currentStock">वर्तमान स्टॉक</h4><table class="data-table"><thead><tr><th data-lang-key="productColumn">उत्पाद</th><th data-lang-key="priceColumn">मूल्य</th><th data-lang-key="inStock">स्टॉक में</th><th data-lang-key="actionColumn">एक्शन</th></tr></thead><tbody id="stockTableBody"></tbody></table><div style="display:flex; gap:15px; margin-top:20px;" class="no-print"><button id="printStockBtn" data-lang-key="printStock">स्टॉक प्रिंट करें</button><button id="saveStockPdfBtn" data-lang-key="saveAsPdf">PDF के रूप में सहेजें</button></div></div></div></div>
        <div id="customers-tab" class="tab-content"><h4 data-lang-key="customerList">ग्राहकों की सूची</h4><table class="data-table"><thead><tr><th data-lang-key="nameColumn">नाम</th><th data-lang-key="phoneColumn">फ़ोन</th><th data-lang-key="actionColumn">एक्शन</th></tr></thead><tbody id="customerTableBody"></tbody></table></div>
        <div id="profile-tab" class="tab-content"><div class="profile-layout" style="grid-template-columns: 1fr 1fr; gap: 30px;"><div><h4 data-lang-key="shopDetails">दुकान का विवरण</h4><label data-lang-key="shopNameLabel">दुकान का नाम:</label><input type="text" id="profileShopName"><label data-lang-key="shopAddressLabel">दुकान का पता:</label><textarea id="profileAddress" rows="3"></textarea><label data-lang-key="phoneNumLabel">फ़ोन नंबर:</label><input type="tel" id="profilePhone"><label data-lang-key="emailIdLabel">ईमेल आईडी:</label><input type="email" id="profileEmail" readonly></div><div><h4 data-lang-key="paymentAndLogo">भुगतान और लोगो</h4><label>UPI ID:</label><input type="text" id="profileUpiId" placeholder="yourname@bank" data-lang-key="upiPlaceholder"><label data-lang-key="shopLogoLabel">दुकान का लोगो:</label><input type="file" id="logoUpload" accept="image/jpeg,image/png"><img id="logoPreview" src="" style="max-width: 150px; max-height: 80px; border:1px solid #ccc; padding:5px; margin-top:10px;"></div></div><button id="saveProfileBtn" style="margin-top:20px;" data-lang-key="saveProfile">प्रोफ़ाइल सेव करें</button></div>
        <div id="backup-tab" class="tab-content">
            <h4 data-lang-key="backupRestoreTitle">बैकअप और रिस्टोर</h4>
            <div class="backup-container">
                <p data-lang-key="backupInstructions">अपने सभी डेटा (उत्पाद, ग्राहक, बिल आदि) को एक फ़ाइल के रूप में डाउनलोड करने के लिए 'बैकअप बनाएं' पर क्लिक करें। इस फ़ाइल को सुरक्षित रखें। डेटा वापस पाने के लिए 'बैकअप से रिस्टोर करें' का उपयोग करें।</p>
                <button id="createBackupBtn" data-lang-key="createBackup">बैकअप बनाएं</button>
                <button id="restoreBackupBtn" style="background-color: #27ae60;" data-lang-key="restoreBackup">बैकअप से रिस्टोर करें</button>
                <input type="file" id="restoreFileInput" class="hidden" accept=".json">
            </div>
        </div>
    </div>
    
    <!-- मोडल -->
    <div id="bill-modal" class="modal"><div class="modal-content"><div class="printable-area" id="bill-to-print-container"></div><div class="modal-buttons no-print" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        <button id="sendWhatsAppBtn" title="WhatsApp पर भेजें" style="background-color:#25D366; padding: 8px; line-height: 1; width:auto;">
            <svg fill="white" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.523.074-.797.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.203 5.076 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
        </button>
        <button id="shareBillImageBtn" style="background-color:#f39c12; width:auto;" data-lang-key="shareAsImage">इमेज शेयर करें</button>
        <button id="printBillBtn" style="background-color:#27ae60; width:auto;" data-lang-key="printBill">बिल प्रिंट करें</button>
        <button id="closeBillModalBtn" style="background-color:#e74c3c; width:auto;" data-lang-key="newBill">नया बिल</button>
    </div></div></div>
    <div id="history-modal" class="modal"><div class="modal-content" style="max-width:600px;"><h3 data-lang-key="purchaseHistoryOf">का खरीद इतिहास</h3><div id="historyContainer" style="max-height: 400px; overflow-y: auto;"></div><button id="closeHistoryModalBtn" style="margin-top:20px; background-color:#e74c3c;" data-lang-key="close">बंद करें</button></div></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- अनुवाद ऑब्जेक्ट ---
    const translations = {
        'hi': {
            welcomeTitle: "Welcome Billing App", login: "लॉगिन करें", createAccount: "नया अकाउंट बनाएं", back: "← वापस",
            shopNameLabel: "दुकान का नाम:", emailLabel: "ईमेल:", mobileLabel: "मोबाइल:", passwordLabel: "पासवर्ड:",
            signUp: "साइन अप", emailOrMobileLabel: "ईमेल या मोबाइल:", logout: "लॉगआउट", billingTab: "बिलिंग",
            inventoryTab: "इन्वेंटरी", customersTab: "ग्राहक", profileTab: "प्रोफ़ाइल", backupRestoreTab: "बैकअप/रिस्टोर",
            customerDetails: "ग्राहक का विवरण", customerName: "ग्राहक का नाम:", customerPhone: "ग्राहक का फ़ोन:", customerAddress: "ग्राहक का पता:",
            addItem: "आइटम जोड़ें", productSearch: "उत्पाद खोजें:", quantity: "मात्रा:", addToBill: "बिल में जोड़ें",
            currentBill: "वर्तमान बिल", productColumn: "उत्पाद", quantityColumn: "मात्रा", priceColumn: "मूल्य", totalColumn: "कुल",
            subTotal: "उप-योग (Subtotal):", discount: "डिस्काउंट:", gst: "GST (%):", grandTotal: "कुल देय:",
            generateBill: "बिल बनाएं", addProduct: "नया उत्पाद जोड़ें", productName: "उत्पाद का नाम:", priceLabel: "मूल्य (₹):",
            unitLabel: "इकाई:", stockQuantity: "स्टॉक मात्रा:", addToStock: "स्टॉक में जोड़ें", currentStock: "वर्तमान स्टॉक",
            inStock: "स्टॉक में", printStock: "स्टॉक प्रिंट करें", saveAsPdf: "PDF के रूप में सहेजें", customerList: "ग्राहकों की सूची",
            nameColumn: "नाम", phoneColumn: "फ़ोन", actionColumn: "एक्शन", historyBtn: "इतिहास", shopDetails: "दुकान का विवरण",
            shopAddressLabel: "दुकान का पता:", phoneNumLabel: "फ़ोन नंबर:", emailIdLabel: "ईमेल आईडी:",
            paymentAndLogo: "भुगतान और लोगो", upiPlaceholder: "yourname@bank", shopLogoLabel: "दुकान का लोगो:",
            saveProfile: "प्रोफ़ाइल सेव करें", sendOnWhatsApp: "WhatsApp पर भेजें", printBill: "बिल प्रिंट करें",
            shareAsImage: "इमेज शेयर करें", newBill: "नया बिल", purchaseHistoryOf: "का खरीद इतिहास", close: "बंद करें",
            invalidCredentials: "गलत क्रेडेंशियल।", emailExists: "यह ईमेल आईडी पहले से पंजीकृत है।", signupSuccess: "साइन अप सफल!",
            fillAllFields: "कृपया सभी फ़ील्ड में सही जानकारी दर्ज करें।", productAddedSuccess: "उत्पाद सफलतापूर्वक जोड़ा गया!",
            productUpdatedSuccess: "उत्पाद सफलतापूर्वक अपडेट किया गया!", quantityUpdatedSuccess: "उत्पाद की मात्रा अपडेट कर दी गई है!",
            selectProductFromList: "कृपया सूची से एक उत्पाद चुनें।", stockUnavailable: "स्टॉक में केवल {quantity} {unit} उपलब्ध है!",
            addItemsToBill: "बिल बनाने के लिए आइटम जोड़ें।", customerInfoRequired: "बिल बनाने के लिए ग्राहक का नाम और फ़ोन नंबर आवश्यक है।",
            profileSaved: "प्रोफ़ाइल सेव हो गया!", noBillToShare: "शेयर करने के लिए कोई बिल नहीं है।", preparing: "तैयार हो रहा है...",
            imageCreationFailed: "इमेज बनाने में त्रुटि हुई।", imageDownloaded: "बिल की इमेज डाउनलोड हो गई है। कृपया इसे मैन्युअल रूप से साझा करें।",
            noPurchaseHistory: "इस ग्राहक के लिए कोई खरीद इतिहास नहीं मिला।", billNo: "बिल नं:", date: "तारीख:", total: "कुल:", viewBill: "बिल देखें",
            stockReport: "स्टॉक रिपोर्ट", customer: "ग्राहक:", name: "नाम:", mobile: "मोबाइल:", subTotalBill: "उप-योग:", discountBill: "डिस्काउंट:",
            grandTotalBill: "कुल देय:", scanToPay: "भुगतान के लिए स्कैन करें", visitAgain: "Visit Again!", thanksForShopping: "खरीदारी के लिए धन्यवाद!",
            editBtn: "संपादित करें", deleteBtn: "हटाएं", updateBtn: "अपडेट करें", deleteConfirm: "क्या आप वाकई इस उत्पाद को हटाना चाहते हैं?",
            backupRestoreTitle: "बैकअप और रिस्टोर", backupInstructions: "अपने सभी डेटा (उत्पाद, ग्राहक, बिल आदि) को एक फ़ाइल के रूप में डाउनलोड करने के लिए 'बैकअप बनाएं' पर क्लिक करें। इस फ़ाइल को सुरक्षित रखें। डेटा वापस पाने के लिए 'बैकअप से रिस्टोर करें' का उपयोग करें।",
            createBackup: "बैकअप बनाएं", restoreBackup: "बैकअप से रिस्टोर करें", restoreConfirm: "क्या आप वाकई रिस्टोर करना चाहते हैं? यह सभी मौजूदा डेटा को ओवरराइट कर देगा।",
            backupSuccess: "बैकअप फ़ाइल सफलतापूर्वक बन गई है।", restoreSuccess: "डेटा सफलतापूर्वक रिस्टोर हो गया है।", invalidBackupFile: "अमान्य बैकअप फ़ाइल।"
        },
        'en': {
            welcomeTitle: "Welcome Billing App", login: "Login", createAccount: "Create New Account", back: "← Back",
            shopNameLabel: "Shop Name:", emailLabel: "Email:", mobileLabel: "Mobile:", passwordLabel: "Password:",
            signUp: "Sign Up", emailOrMobileLabel: "Email or Mobile:", logout: "Logout", billingTab: "Billing",
            inventoryTab: "Inventory", customersTab: "Customers", profileTab: "Profile", backupRestoreTab: "Backup/Restore",
            customerDetails: "Customer Details", customerName: "Customer Name:", customerPhone: "Customer Phone:", customerAddress: "Customer Address:",
            addItem: "Add Item", productSearch: "Search Product:", quantity: "Quantity:", addToBill: "Add to Bill",
            currentBill: "Current Bill", productColumn: "Product", quantityColumn: "Quantity", priceColumn: "Price", totalColumn: "Total",
            subTotal: "Subtotal:", discount: "Discount:", gst: "GST (%):", grandTotal: "Grand Total:",
            generateBill: "Generate Bill", addProduct: "Add New Product", productName: "Product Name:", priceLabel: "Price (₹):",
            unitLabel: "Unit:", stockQuantity: "Stock Quantity:", addToStock: "Add to Stock", currentStock: "Current Stock",
            inStock: "In Stock", printStock: "Print Stock", saveAsPdf: "Save as PDF", customerList: "Customer List",
            nameColumn: "Name", phoneColumn: "Phone", actionColumn: "Action", historyBtn: "History", shopDetails: "Shop Details",
            shopAddressLabel: "Shop Address:", phoneNumLabel: "Phone Number:", emailIdLabel: "Email ID:",
            paymentAndLogo: "Payment & Logo", upiPlaceholder: "yourname@bank", shopLogoLabel: "Shop Logo:",
            saveProfile: "Save Profile", sendOnWhatsApp: "Send on WhatsApp", printBill: "Print Bill",
            shareAsImage: "Share as Image", newBill: "New Bill", purchaseHistoryOf: "'s Purchase History", close: "Close",
            invalidCredentials: "Invalid credentials.", emailExists: "This email ID is already registered.", signupSuccess: "Sign up successful!",
            fillAllFields: "Please enter correct information in all fields.", productAddedSuccess: "Product added successfully!",
            productUpdatedSuccess: "Product updated successfully!", quantityUpdatedSuccess: "Product quantity has been updated!",
            selectProductFromList: "Please select a product from the list.", stockUnavailable: "Only {quantity} {unit} available in stock!",
            addItemsToBill: "Add items to create a bill.", customerInfoRequired: "Customer name and phone number are required to generate a bill.",
            profileSaved: "Profile saved!", noBillToShare: "No bill to share.", preparing: "Preparing...",
            imageCreationFailed: "Error creating image.", imageDownloaded: "Bill image has been downloaded. Please share it manually on WhatsApp.",
            noPurchaseHistory: "No purchase history found for this customer.", billNo: "Bill No:", date: "Date:", total: "Total:", viewBill: "View Bill",
            stockReport: "Stock Report", customer: "Customer:", name: "Name:", mobile: "Mobile:", subTotalBill: "Subtotal:", discountBill: "Discount:",
            grandTotalBill: "Grand Total:", scanToPay: "Scan to Pay", visitAgain: "Visit Again!", thanksForShopping: "Thanks for shopping!",
            editBtn: "Edit", deleteBtn: "Delete", updateBtn: "Update", deleteConfirm: "Are you sure you want to delete this product?",
            backupRestoreTitle: "Backup & Restore", backupInstructions: "Click 'Create Backup' to download all your data (products, customers, bills, etc.) as a file. Keep this file safe. Use 'Restore from Backup' to recover your data.",
            createBackup: "Create Backup", restoreBackup: "Restore from Backup", restoreConfirm: "Are you sure you want to restore? This will overwrite all current data.",
            backupSuccess: "Backup file created successfully.", restoreSuccess: "Data restored successfully.", invalidBackupFile: "Invalid backup file."
        },
        'ur': {
            welcomeTitle: "Welcome Billing App", login: "لاگ ان کریں", createAccount: "نیا اکاؤنٹ بنائیں", back: "← واپس",
            shopNameLabel: "دکان کا نام:", emailLabel: "ای میل:", mobileLabel: "موبائل:", passwordLabel: "پاس ورڈ:",
            signUp: "سائن اپ", emailOrMobileLabel: "ای میل یا موبائل:", logout: "لاگ آوٹ", billingTab: "بلنگ",
            inventoryTab: "انوینٹری", customersTab: "صارفین", profileTab: "پروفائل", backupRestoreTab: "بیک اپ/ریسٹور",
            customerDetails: "صارف کی تفصیلات", customerName: "صارف کا نام:", customerPhone: "صارف کا فون:", customerAddress: "صارف کا پتہ:",
            addItem: "آئٹم شامل کریں", productSearch: "پروڈکٹ تلاش کریں:", quantity: "مقدار:", addToBill: "بل میں شامل کریں",
            currentBill: "موجودہ بل", productColumn: "پروڈکٹ", quantityColumn: "مقدار", priceColumn: "قیمت", totalColumn: "کل",
            subTotal: "ذیلی کل:", discount: "رعایت:", gst: "جی ایس ٹی (%):", grandTotal: "کل قابل ادائیگی:",
            generateBill: "بل بنائیں", addProduct: "نیا پروڈکٹ شامل کریں", productName: "پروڈکٹ کا نام:", priceLabel: "قیمت (₹):",
            unitLabel: "یونٹ:", stockQuantity: "اسٹاک کی مقدار:", addToStock: "اسٹاک میں شامل کریں", currentStock: "موجودہ اسٹاک",
            inStock: "اسٹاک میں", printStock: "اسٹاک پرنٹ کریں", saveAsPdf: "پی ڈی ایف کے طور پر محفوظ کریں", customerList: "صارفین کی فہرست",
            nameColumn: "نام", phoneColumn: "فون", actionColumn: "عمل", historyBtn: "تاریخ", shopDetails: "دکان کی تفصیلات",
            shopAddressLabel: "دکان کا پتہ:", phoneNumLabel: "فون نمبر:", emailIdLabel: "ای میل آئی ڈی:",
            paymentAndLogo: "ادائیگی اور لوگو", upiPlaceholder: "yourname@bank", shopLogoLabel: "دکان کا لوگو:",
            saveProfile: "پروفائل محفوظ کریں", sendOnWhatsApp: "WhatsApp پر بھیجیں", printBill: "بل پرنٹ کریں",
            shareAsImage: "تصویر شیئر کریں", newBill: "نیا بل", purchaseHistoryOf: " کی خریداری کی تاریخ", close: "بند کریں",
            invalidCredentials: "غلط اسناد۔", emailExists: "یہ ای میل آئی ڈی پہلے سے رجسٹرڈ ہے۔", signupSuccess: "کامیابی سے سائن اپ!",
            fillAllFields: "براہ کرم تمام خانوں میں صحیح معلومات درج کریں۔", productAddedSuccess: "پروڈکٹ کامیابی سے شامل کیا گیا!",
            productUpdatedSuccess: "پروڈکٹ کامیابی سے اپ ڈیٹ ہو گیا!", quantityUpdatedSuccess: "مصنوعات کی مقدار کو اپ ڈیٹ کر دیا گیا ہے!",
            selectProductFromList: "براہ کرم فہرست سے ایک پروڈکٹ منتخب کریں۔", stockUnavailable: "اسٹاک میں صرف {quantity} {unit} دستیاب ہے!",
            addItemsToBill: "بل بنانے کے لیے آئٹمز شامل کریں۔", customerInfoRequired: "بل بنانے کے लिए صارف کا نام اور फ़ोन नंबर आवश्यक है।",
            profileSaved: "پروفائل محفوظ ہوگیا!", noBillToShare: "شیئر کرنے کے لیے کوئی بل نہیں ہے۔", preparing: "تیار ہو رہا ہے...",
            imageCreationFailed: "تصویر بنانے میں خرابی۔", imageDownloaded: "بل کی تصویر ڈاؤن لوڈ ہو گئی ہے۔ براہ کرم اسے دستی طور پر WhatsApp پر شیئر کریں۔",
            noPurchaseHistory: "اس صارف کے لیے خریداری کی کوئی تاریخ نہیں ملی۔", billNo: "بل نمبر:", date: "تاریخ:", total: "کل:", viewBill: "بل دیکھیں",
            stockReport: "اسٹاک رپورٹ", customer: "صارف:", name: "نام:", mobile: "موبائل:", subTotalBill: "ذیلی کل:", discountBill: "رعایت:",
            grandTotalBill: "کل قابل ادائیگی:", scanToPay: "ادائیگی کے لیے اسکین کریں", visitAgain: "دوبارہ تشریف لائیں!", thanksForShopping: "خریداری کے لئے شکریہ!",
            editBtn: "ترمیم", deleteBtn: "حذف کریں", updateBtn: "اپ ڈیٹ", deleteConfirm: "کیا آپ واقعی اس پروڈکٹ کو حذف کرنا چاہتے ہیں؟",
            backupRestoreTitle: "بیک اپ اور ریسٹور", backupInstructions: "اپنے تمام ڈیٹا (مصنوعات، صارفین، بل، وغیرہ) کو فائل کے طور پر ڈاؤن لوڈ کرنے کے لیے 'بیک اپ بنائیں' پر کلک کریں۔ اس فائل کو محفوظ رکھیں۔ اپنا ڈیٹا بازیافت کرنے کے لیے 'بیک اپ سے بحال کریں' کا استعمال کریں۔",
            createBackup: "بیک اپ بنائیں", restoreBackup: "بیک اپ سے بحال کریں", restoreConfirm: "کیا آپ واقعی بحال کرنا چاہتے ہیں؟ یہ تمام موجودہ ڈیٹا کو اوور رائٹ کر دے گا۔",
            backupSuccess: "بیک اپ فائل کامیابی سے بن گئی۔", restoreSuccess: "ڈیٹا کامیابی سے بحال ہو گیا۔", invalidBackupFile: "غلط بیک اپ فائل۔"
        }
    };
    
    // --- ग्लोबल वेरिएबल्स ---
    let allRetailerData = {}, currentUserEmail = null, currentBillItems = [], billCounter = 1, selectedProductForBill = null, currentLanguage = 'hi', editingProductId = null, currentBillForModal = null;
    const app = {}; window.app = app;
    
    // --- भाषा फंक्शन ---
    const setLanguage = (lang) => {
        if (!translations[lang]) return;
        currentLanguage = lang;
        localStorage.setItem('appLanguage', lang);
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'ur') ? 'rtl' : 'ltr';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            const translation = translations[lang][key];
            if (translation) {
                if (el.placeholder) {
                    el.placeholder = translation;
                } else {
                    el.innerText = translation;
                }
            }
        });
        document.getElementById('language-select').value = lang;
        const whatsappBtn = document.getElementById('sendWhatsAppBtn');
        if (whatsappBtn) {
            whatsappBtn.title = translations[lang].sendOnWhatsApp;
        }
        // UI के डायनामिक हिस्सों को फिर से रेंडर करें
        if (currentUserEmail) {
            renderAllUI();
        }
    };

    // --- हेल्पर और UI फंक्शन ---
    const saveData = () => { localStorage.setItem('allRetailerData', JSON.stringify(allRetailerData)); };
    const loadData = () => { allRetailerData = JSON.parse(localStorage.getItem('allRetailerData')) || {}; billCounter = parseInt(localStorage.getItem('billCounter')) || 1; };
    const showPage = (pageName) => { document.querySelectorAll('.container').forEach(p => p.classList.add('hidden')); document.getElementById(pageName).classList.remove('hidden'); };
    const showTab = (tabName) => {
        document.querySelectorAll('.tab-content, .tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
        document.querySelector(`.tab-link[data-tab='${tabName}']`).classList.add('active');
    };
    
    const renderAllUI = () => {
        if (!currentUserEmail || !allRetailerData[currentUserEmail]) return;
        const retailer = allRetailerData[currentUserEmail];
        document.getElementById('retailerShopName').innerText = retailer.shopDetails.name;
        renderInventoryTable();
        renderProfile();
        renderCustomerTable();
        populateBillingDropdown();
        updateCurrentBillDisplay();
    };
    const renderInventoryTable = () => {
        const inventory = allRetailerData[currentUserEmail]?.inventory || [];
        const lang = translations[currentLanguage];
        document.getElementById('stockTableBody').innerHTML = inventory.map(item => `
            <tr>
                <td>${item.name}</td>
                <td>₹${item.price.toFixed(2)}</td>
                <td>${item.quantity} ${item.unit}</td>
                <td>
                    <button class="action-button edit" onclick="window.app.editProduct(${item.id})">${lang.editBtn}</button>
                    <button class="action-button delete" onclick="window.app.deleteProduct(${item.id})">${lang.deleteBtn}</button>
                </td>
            </tr>`).join('');
    };
    const renderProfile = () => {
        const details = allRetailerData[currentUserEmail].shopDetails;
        document.getElementById('profileShopName').value = details.name; document.getElementById('profileAddress').value = details.address || '';
        document.getElementById('profilePhone').value = details.phone; document.getElementById('profileEmail').value = currentUserEmail;
        document.getElementById('logoPreview').src = details.logo || 'https://via.placeholder.com/150'; document.getElementById('profileUpiId').value = details.upiId || '';
    };
    const renderCustomerTable = () => {
        const customers = allRetailerData[currentUserEmail]?.customers || [];
        const historyBtnText = translations[currentLanguage].historyBtn;
        document.getElementById('customerTableBody').innerHTML = customers.map(c => `<tr><td>${c.name}</td><td>${c.phone}</td><td><button class="action-btn" onclick="window.app.showPurchaseHistory(${c.id})">${historyBtnText}</button></td></tr>`).join('');
    };
    const updateCurrentBillDisplay = () => {
        let subTotal = 0;
        document.getElementById('currentBillBody').innerHTML = currentBillItems.map(item => { subTotal += item.total; return `<tr><td>${item.name}</td><td>${item.quantity} ${item.unit}</td><td>₹${item.price.toFixed(2)}</td><td>₹${item.total.toFixed(2)}</td></tr>`; }).join('');
        document.getElementById('subTotalDisplay').innerText = subTotal.toFixed(2);
        calculateFinalTotal();
    };
    const calculateFinalTotal = () => {
        let subTotal = 0; currentBillItems.forEach(item => subTotal += item.total);
        const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
        const discountType = document.getElementById('discountType').value;
        const gstPercent = parseFloat(document.getElementById('gstInput').value) || 0;
        let discountAmount = (discountType === 'percent') ? (subTotal * discountValue) / 100 : discountValue;
        const totalAfterDiscount = subTotal - discountAmount;
        const gstAmount = (totalAfterDiscount * gstPercent) / 100;
        const finalTotal = totalAfterDiscount + gstAmount;
        document.getElementById('grandTotalDisplay').innerText = finalTotal.toFixed(2);
    };
    const populateBillingDropdown = () => {
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        searchResultsContainer.innerHTML = '';
        const inventory = allRetailerData[currentUserEmail]?.inventory || [];
        const stockText = translations[currentLanguage].inStock;
        inventory.forEach(product => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('search-item');
            itemDiv.innerHTML = `${product.name} <small>(${stockText}: ${product.quantity} ${product.unit})</small>`;
            itemDiv.addEventListener('click', () => {
                document.getElementById('productSearchInput').value = product.name;
                selectedProductForBill = product;
                searchResultsContainer.classList.add('hidden');
            });
            searchResultsContainer.appendChild(itemDiv);
        });
    };

    // --- प्रमाणीकरण और आरंभीकरण ---
    const logout = () => { sessionStorage.removeItem('loggedInUser'); currentUserEmail = null; showPage('welcome-page'); };
    const initializeApp = () => {
        loadData();
        const savedLang = localStorage.getItem('appLanguage') || 'hi';
        setLanguage(savedLang);
        currentUserEmail = sessionStorage.getItem('loggedInUser');
        if (currentUserEmail && allRetailerData[currentUserEmail]) {
            renderAllUI(); showPage('main-app');
        } else {
            logout();
        }
    };
    
    // --- इवेंट हैंडलर्स ---
    const handleLogin = (e) => {
        e.preventDefault();
        const identifier = document.getElementById('loginIdentifier').value.toLowerCase();
        const password = document.getElementById('loginPassword').value;
        const userEmail = Object.keys(allRetailerData).find(email => (email === identifier || allRetailerData[email].shopDetails.phone === identifier) && allRetailerData[email].password === password);
        if (userEmail) { sessionStorage.setItem('loggedInUser', userEmail); initializeApp(); } else { alert(translations[currentLanguage].invalidCredentials); }
    };

    const handleSignup = (e) => {
        e.preventDefault();
        const email = document.getElementById('signupEmail').value.toLowerCase();
        if (allRetailerData[email]) { alert(translations[currentLanguage].emailExists); return; }
        allRetailerData[email] = {
            password: document.getElementById('signupPassword').value,
            shopDetails: { name: document.getElementById('signupShopName').value, phone: document.getElementById('signupPhone').value, address: '', logo: '', upiId: '' },
            inventory: [], customers: [], bills: []
        };
        saveData(); alert(translations[currentLanguage].signupSuccess); e.target.reset(); showPage('login-page');
    };
    
    const handleAddStock = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const name = document.getElementById('productName').value.trim();
        const price = parseFloat(document.getElementById('productPrice').value);
        const quantity = parseFloat(document.getElementById('productQuantity').value);
        const unit = document.getElementById('productUnit').value;
        const lang = translations[currentLanguage];

        if (!name || isNaN(price) || price < 0 || isNaN(quantity) || quantity < 0) {
            alert(lang.fillAllFields);
            return;
        }

        if (editingProductId) {
            const productToUpdate = retailerData.inventory.find(p => p.id === editingProductId);
            if (productToUpdate) {
                productToUpdate.name = name;
                productToUpdate.price = price;
                productToUpdate.quantity = quantity;
                productToUpdate.unit = unit;
                alert(lang.productUpdatedSuccess);
            }
            editingProductId = null;
            document.getElementById('stockSubmitBtn').innerText = lang.addToStock;
        } else {
            const existingProduct = retailerData.inventory.find(item => item.name.toLowerCase() === name.toLowerCase());
            if (existingProduct) {
                existingProduct.quantity += quantity;
                alert(lang.quantityUpdatedSuccess);
            } else {
                if (!Array.isArray(retailerData.inventory)) retailerData.inventory = [];
                retailerData.inventory.push({ id: Date.now(), name, price, quantity, unit });
                alert(lang.productAddedSuccess);
            }
        }
        
        saveData();
        renderInventoryTable();
        e.target.reset();
    };

    const handleAddItemToBill = (e) => {
        e.preventDefault();
        if (!selectedProductForBill) { alert(translations[currentLanguage].selectProductFromList); return; }
        const quantity = parseFloat(document.getElementById('itemQuantity').value);
        if (quantity > selectedProductForBill.quantity) { alert(translations[currentLanguage].stockUnavailable.replace('{quantity}', selectedProductForBill.quantity).replace('{unit}', selectedProductForBill.unit)); return; }
        const existingItem = currentBillItems.find(item => item.id === selectedProductForBill.id);
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.total = existingItem.quantity * existingItem.price;
        } else {
            currentBillItems.push({ ...selectedProductForBill, quantity, total: selectedProductForBill.price * quantity });
        }
        updateCurrentBillDisplay();
        document.getElementById('productSearchInput').value = '';
        selectedProductForBill = null;
        document.getElementById('itemQuantity').value = 1;
    };

    app.editProduct = (productId) => {
        const product = allRetailerData[currentUserEmail].inventory.find(p => p.id === productId);
        if (product) {
            editingProductId = productId;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('productUnit').value = product.unit;
            document.getElementById('stockSubmitBtn').innerText = translations[currentLanguage].updateBtn;
            showTab('inventory');
        }
    };
    
    app.deleteProduct = (productId) => {
        const lang = translations[currentLanguage];
        if (confirm(lang.deleteConfirm)) {
            const retailerData = allRetailerData[currentUserEmail];
            const productIndex = retailerData.inventory.findIndex(p => p.id === productId);
            if (productIndex > -1) {
                retailerData.inventory.splice(productIndex, 1);
                saveData();
                renderInventoryTable();
            }
        }
    };
    
    const handlePrintStock = () => {
        const printContent = document.getElementById('inventoryToPrint').innerHTML;
        const shopName = allRetailerData[currentUserEmail].shopDetails.name;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>${translations[currentLanguage].stockReport} - ${shopName}</title><style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;}.no-print{display:none;}</style></head><body><h1>${translations[currentLanguage].stockReport} - ${shopName}</h1>${printContent}</body></html>`);
        printWindow.document.close();
        printWindow.print();
    };

    const handleSaveStockPdf = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const shopName = allRetailerData[currentUserEmail].shopDetails.name;
        doc.text(`${translations[currentLanguage].stockReport} - ${shopName}`, 14, 15);
        const tableData = (allRetailerData[currentUserEmail].inventory || []).map(p => [p.name, `Rs. ${p.price.toFixed(2)}`, `${p.quantity} ${p.unit}`]);
        doc.autoTable({
            head: [[translations[currentLanguage].productColumn, translations[currentLanguage].priceColumn, translations[currentLanguage].inStock]],
            body: tableData,
            startY: 20,
        });
        doc.save(`${translations[currentLanguage].stockReport}-${Date.now()}.pdf`);
    };
    
    const handleSaveProfile = () => {
        const details = allRetailerData[currentUserEmail].shopDetails;
        details.name = document.getElementById('profileShopName').value;
        details.address = document.getElementById('profileAddress').value;
        details.phone = document.getElementById('profilePhone').value;
        details.upiId = document.getElementById('profileUpiId').value.trim();
        const logoFile = document.getElementById('logoUpload').files[0];
        
        const imageToBs64 = (file, callback) => {
            if (file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => callback(reader.result);
                reader.onerror = () => callback(null);
            } else {
                callback(null);
            }
        };

        imageToBs64(logoFile, (bs64) => { 
            if(bs64) details.logo = bs64;
            saveData(); 
            alert(translations[currentLanguage].profileSaved); 
            renderAllUI();
        });
    };
    
    app.generateBillHTML = (bill, retailer, customer) => {
        const lang = translations[currentLanguage];
        const billTextColor = '#000';
        const billBgColor = '#fff';
        const gstValue = bill.subTotal - bill.discountAmount > 0 ? (100 * bill.gstAmount / (bill.subTotal - bill.discountAmount)).toFixed(2) : 0;
        
        return `<div id="bill-to-print" style="background-color: ${billBgColor}; color: ${billTextColor}; padding: 15px; direction: ${document.documentElement.dir};">
            <div style="text-align:center; font-family:'Courier New';"><img src="${retailer.shopDetails.logo || ''}" style="max-height:80px;"><h3 style="margin:5px 0;">${retailer.shopDetails.name}</h3><p style="margin:2px 0;">${retailer.shopDetails.address}</p><p style="margin:2px 0;">${lang.phoneColumn}: ${retailer.shopDetails.phone}</p><p style="margin:2px 0;">${lang.billNo} ${bill.billNo}</p><p style="margin:2px 0;">${lang.date}: ${bill.date} | ${bill.time}</p></div><hr style="border:1px dashed #333;"><div class="bill-customer-info" style="font-family:'Courier New';"><h4 style="margin:0; text-align:${document.documentElement.dir === 'rtl' ? 'right' : 'left'};">${lang.customer}:</h4><p><strong>${lang.name}:</strong> ${customer.name}</p><p><strong>${lang.mobile}:</strong> ${customer.phone}</p></div><hr style="border:1px dashed #333;"><table style="width:100%; font-size:14px; border-collapse:collapse; font-family:'Courier New';"><thead><tr><th>${lang.productColumn}</th><th>${lang.quantityColumn}</th><th>${lang.totalColumn}</th></tr></thead><tbody>${bill.items.map(item => `<tr><td>${item.name}</td><td>${item.quantity} ${item.unit}</td><td>₹${item.total.toFixed(2)}</td></tr>`).join('')}</tbody></table><hr style="border:1px dashed #333;"><div style="font-family:'Segoe UI';"><div class="bill-summary-row"><span>${lang.subTotalBill}</span><span>₹${bill.subTotal.toFixed(2)}</span></div><div class="bill-summary-row"><span>${lang.discountBill}</span><span>- ₹${bill.discountAmount.toFixed(2)}</span></div><div class="bill-summary-row"><span>GST (${gstValue}%):</span><span>+ ₹${bill.gstAmount.toFixed(2)}</span></div><div class="bill-summary-row grand-total" style="border-top-color: #333;"><span>${lang.grandTotalBill}</span><span>₹${bill.total.toFixed(2)}</span></div></div><p style="text-align:center;font-weight:bold;">${lang.scanToPay}</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(`upi://pay?pa=${retailer.shopDetails.upiId}&pn=${encodeURIComponent(retailer.shopDetails.name)}&am=${bill.total.toFixed(2)}&cu=INR&tn=BillNo${bill.billNo}`)}" alt="UPI QR Code" style="display:block;margin:15px auto;width:160px;height:160px;"><div style="text-align:center;margin-top:20px;"><p>${lang.visitAgain} ${lang.thanksForShopping}</p></div>
        </div>`;
    };

    const getOrCreateCustomer = (name, phone, address) => {
        const retailer = allRetailerData[currentUserEmail];
        if (!Array.isArray(retailer.customers)) { retailer.customers = []; }
        let customer = retailer.customers.find(c => c.phone === phone);
        if (customer) { 
            customer.name = name; 
            customer.address = address;
        } else { 
            customer = { id: Date.now(), name, phone, address }; 
            retailer.customers.push(customer); 
        }
        return customer;
    };
    
    const handleGenerateBill = () => {
        if (currentBillItems.length === 0) { alert(translations[currentLanguage].addItemsToBill); return; }
        const retailer = allRetailerData[currentUserEmail];
        const customerName = document.getElementById('billingCustomerName').value.trim();
        const customerPhone = document.getElementById('billingCustomerPhone').value.trim();
        const customerAddress = document.getElementById('billingCustomerAddress').value.trim();

        if (!customerPhone || !customerName) { alert(translations[currentLanguage].customerInfoRequired); return; }
        
        const customerForBill = getOrCreateCustomer(customerName, customerPhone, customerAddress);
        renderCustomerTable(); 

        let subTotal = 0; currentBillItems.forEach(item => subTotal += item.total);
        const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
        const discountType = document.getElementById('discountType').value;
        const gstPercent = parseFloat(document.getElementById('gstInput').value) || 0;
        let discountAmount = (discountType === 'percent') ? (subTotal * discountValue) / 100 : discountValue;
        const totalAfterDiscount = subTotal - discountAmount;
        const gstAmount = (totalAfterDiscount * gstPercent) / 100;
        const finalTotal = totalAfterDiscount + gstAmount;

        const today = new Date();
        const billDate = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
        const billTime = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}:${String(today.getSeconds()).padStart(2, '0')}`;
        
        if (!Array.isArray(retailer.bills)) retailer.bills = [];
        const newBill = { billNo: billCounter, customerId: customerForBill.id, date: billDate, time: billTime, items: JSON.parse(JSON.stringify(currentBillItems)), subTotal, discountAmount, gstAmount, total: finalTotal };
        retailer.bills.push(newBill);
        
        currentBillForModal = newBill; // वर्तमान बिल को शेयरिंग के लिए सेट करें

        currentBillItems.forEach(item => { retailer.inventory.find(p => p.id === item.id).quantity -= item.quantity; });
        
        const billModalContent = document.getElementById('bill-to-print-container');
        billModalContent.innerHTML = app.generateBillHTML(newBill, retailer, customerForBill);
        
        saveData();
        renderInventoryTable();
        document.getElementById('bill-modal').style.display = 'block';
    };

    app.showPurchaseHistory = (customerId) => {
        const retailer = allRetailerData[currentUserEmail];
        const customer = retailer.customers.find(c => c.id == customerId);
        const customerBills = retailer.bills.filter(b => b.customerId == customerId).reverse();
        
        const historyTitle = document.querySelector('#history-modal h3');
        historyTitle.innerHTML = `<span id="historyCustomerName">${customer.name}</span> ${translations[currentLanguage].purchaseHistoryOf}`;

        const container = document.getElementById('historyContainer');
        const lang = translations[currentLanguage];
        
        if (customerBills.length === 0) {
            container.innerHTML = `<p>${lang.noPurchaseHistory}</p>`;
        } else {
            container.innerHTML = customerBills.map(bill => `
                <div class="history-item">
                    <p><strong>${lang.billNo}</strong> ${bill.billNo} | <strong>${lang.date}:</strong> ${bill.date} | <strong>${lang.total}:</strong> ₹${bill.total.toFixed(2)}</p>
                    <div class="history-item-actions">
                         <button onclick="app.reprintBill(${bill.billNo})" style="background-color:#27ae60;">${lang.viewBill}</button>
                    </div>
                </div>
            `).join('');
        }
        
        document.getElementById('history-modal').style.display = 'block';
    };
    
    app.reprintBill = (billNo) => {
        const retailer = allRetailerData[currentUserEmail];
        const bill = retailer.bills.find(b => b.billNo == billNo);
        const customer = retailer.customers.find(c => c.id == bill.customerId);

        if (bill && customer) {
            currentBillForModal = bill; // रीप्रिंट बिल को शेयरिंग के लिए सेट करें
            document.getElementById('bill-to-print-container').innerHTML = app.generateBillHTML(bill, retailer, customer);
            document.getElementById('history-modal').style.display = 'none';
            document.getElementById('bill-modal').style.display = 'block';
            document.getElementById('closeBillModalBtn').dataset.isReprint = "true";
        }
    };

    // --- बैकअप और रिस्टोर फंक्शन ---
    const handleCreateBackup = () => {
        const lang = translations[currentLanguage];
        try {
            const backupData = {
                allRetailerData: JSON.parse(localStorage.getItem('allRetailerData')),
                billCounter: parseInt(localStorage.getItem('billCounter')) || 1
            };
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            link.download = `billing-app-backup-${date}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            alert(lang.backupSuccess);
        } catch (error) {
            console.error('Backup failed:', error);
            alert('Backup creation failed.');
        }
    };

    const handleRestoreBackup = (event) => {
        const lang = translations[currentLanguage];
        if (!confirm(lang.restoreConfirm)) {
            event.target.value = ''; // Reset file input
            return;
        }
        const file = event.target.files[0];
        if (file && file.type === "application/json") {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (backupData && backupData.allRetailerData && backupData.billCounter) {
                        localStorage.setItem('allRetailerData', JSON.stringify(backupData.allRetailerData));
                        localStorage.setItem('billCounter', backupData.billCounter);
                        alert(lang.restoreSuccess);
                        initializeApp(); // रिफ्रेश करें
                    } else {
                        alert(lang.invalidBackupFile);
                    }
                } catch (error) {
                    console.error('Restore failed:', error);
                    alert(lang.invalidBackupFile);
                } finally {
                    event.target.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        } else {
            alert(lang.invalidBackupFile);
            event.target.value = ''; // Reset file input
        }
    };

    const attachAllEventListeners = () => {
        document.getElementById('goToLoginBtn').addEventListener('click', () => showPage('login-page'));
        document.getElementById('goToSignUpBtn').addEventListener('click', () => showPage('signup-page'));
        document.getElementById('loginBackBtn').addEventListener('click', () => showPage('welcome-page'));
        document.getElementById('signupBackBtn').addEventListener('click', () => showPage('welcome-page'));
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('appTabsContainer').addEventListener('click', (e) => { if (e.target.matches('.tab-link')) showTab(e.target.dataset.tab); });
        
        document.getElementById('language-select').addEventListener('change', (e) => setLanguage(e.target.value));

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('signupForm').addEventListener('submit', handleSignup);
        document.getElementById('stockForm').addEventListener('submit', handleAddStock);
        document.getElementById('addItemForm').addEventListener('submit', handleAddItemToBill);
        document.getElementById('printStockBtn').addEventListener('click', handlePrintStock);
        document.getElementById('saveStockPdfBtn').addEventListener('click', handleSaveStockPdf);
        document.getElementById('saveProfileBtn').addEventListener('click', handleSaveProfile);
        document.getElementById('generateBillBtn').addEventListener('click', handleGenerateBill);

        // बैकअप/रिस्टोर इवेंट्स
        document.getElementById('createBackupBtn').addEventListener('click', handleCreateBackup);
        document.getElementById('restoreBackupBtn').addEventListener('click', () => document.getElementById('restoreFileInput').click());
        document.getElementById('restoreFileInput').addEventListener('change', handleRestoreBackup);
        
        
        // --- CUSTOMER SEARCH LOGIC ---
        const customerSearchInput = document.getElementById('billingCustomerName');
        const customerSearchResultsContainer = document.getElementById('customerSearchResultsContainer');

        customerSearchInput.addEventListener('input', () => {
            const searchTerm = customerSearchInput.value.toLowerCase().trim();
            customerSearchResultsContainer.innerHTML = ''; 
            if (searchTerm.length === 0) {
                customerSearchResultsContainer.classList.add('hidden');
                return;
            }

            const customers = allRetailerData[currentUserEmail]?.customers || [];
            const matches = customers.filter(c => c.name.toLowerCase().includes(searchTerm));

            if (matches.length > 0) {
                matches.forEach(customer => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-item';
                    itemDiv.textContent = `${customer.name} - ${customer.phone}`;
                    itemDiv.onclick = () => {
                        document.getElementById('billingCustomerName').value = customer.name;
                        document.getElementById('billingCustomerPhone').value = customer.phone;
                        document.getElementById('billingCustomerAddress').value = customer.address || '';
                        customerSearchResultsContainer.classList.add('hidden');
                    };
                    customerSearchResultsContainer.appendChild(itemDiv);
                });
                customerSearchResultsContainer.classList.remove('hidden');
            } else {
                customerSearchResultsContainer.classList.add('hidden');
            }
        });

        // --- PRODUCT SEARCH LOGIC ---
        const searchInput = document.getElementById('productSearchInput');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            selectedProductForBill = null; searchResultsContainer.innerHTML = '';
            if (searchTerm.length === 0) { searchResultsContainer.classList.add('hidden'); return; }
            const matches = (allRetailerData[currentUserEmail]?.inventory || []).filter(p => p.name.toLowerCase().includes(searchTerm) && p.quantity > 0);
            if (matches.length > 0) {
                const stockText = translations[currentLanguage].inStock;
                matches.forEach(product => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-item';
                    itemDiv.innerHTML = `${product.name} <small>(${stockText}: ${product.quantity} ${product.unit})</small>`;
                    itemDiv.onclick = () => {
                        searchInput.value = product.name; selectedProductForBill = product;
                        searchResultsContainer.classList.add('hidden');
                    };
                    searchResultsContainer.appendChild(itemDiv);
                });
                searchResultsContainer.classList.remove('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                searchResultsContainer.classList.add('hidden');
                customerSearchResultsContainer.classList.add('hidden');
            }
        });
        
        document.getElementById('closeBillModalBtn').addEventListener('click', (e) => {
            document.getElementById('bill-modal').style.display = 'none';
            if (e.target.dataset.isReprint !== "true") {
                billCounter++;
                localStorage.setItem('billCounter', billCounter);
                currentBillItems = [];
                updateCurrentBillDisplay();
                document.getElementById('customerDetailsForm').reset();
                document.getElementById('billSummary').querySelectorAll('input, select').forEach(i => {
                    if (i.type === 'number') i.value = 0;
                    if (i.id === 'discountType') i.value = 'percent';
                });
                calculateFinalTotal();
            }
            e.target.dataset.isReprint = "false";
            currentBillForModal = null; // मोडल बंद होने पर बिल क्लियर करें
        });
        
        document.getElementById('closeHistoryModalBtn').addEventListener('click', () => {
            document.getElementById('history-modal').style.display = 'none';
        });

        document.getElementById('sendWhatsAppBtn').addEventListener('click', () => {
            const lang = translations[currentLanguage];
            if (!currentBillForModal) {
                alert(lang.noBillToShare);
                return;
            }

            const bill = currentBillForModal;
            const retailer = allRetailerData[currentUserEmail];
            const customer = retailer.customers.find(c => c.id == bill.customerId);

            if (!retailer || !customer) {
                alert(lang.noBillToShare);
                return;
            }

            const shopName = retailer.shopDetails.name;
            let message = `*${shopName}*\n\n`;
            message += `*${lang.customer}:* ${customer.name}\n`;
            message += `*${lang.mobile}:* ${customer.phone}\n\n`;
            message += `*${lang.billNo}:* ${bill.billNo}\n`;
            message += `*${lang.date}:* ${bill.date} ${bill.time}\n`;
            message += `----------------------------------\n`;
            message += bill.items.map(item =>
                `${item.name} (${item.quantity} ${item.unit}) - ₹${item.total.toFixed(2)}`
            ).join('\n');
            message += `\n----------------------------------\n`;
            message += `${lang.subTotalBill} ₹${bill.subTotal.toFixed(2)}\n`;
            message += `${lang.discountBill} -₹${bill.discountAmount.toFixed(2)}\n`;
            const gstValue = bill.subTotal - bill.discountAmount > 0 ? (100 * bill.gstAmount / (bill.subTotal - bill.discountAmount)).toFixed(2) : 0;
            message += `GST (${gstValue}%): +₹${bill.gstAmount.toFixed(2)}\n\n`;
            message += `*${lang.grandTotalBill}* *₹${bill.total.toFixed(2)}*\n\n`;
            message += `${lang.visitAgain} ${lang.thanksForShopping}`;

            const encodedMessage = encodeURIComponent(message);
            const customerPhone = customer.phone.replace(/[^0-9]/g, '');
            const whatsappUrl = `https://wa.me/${customerPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        });

        document.getElementById('shareBillImageBtn').addEventListener('click', () => {
            const billElement = document.getElementById('bill-to-print');
            const lang = translations[currentLanguage];
            if (!billElement) { alert(lang.noBillToShare); return; }

            const button = document.getElementById('shareBillImageBtn');
            const originalText = button.innerText;
            button.innerText = lang.preparing;
            button.disabled = true;

            html2canvas(billElement, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                canvas.toBlob(function(blob) {
                    const file = new File([blob], 'bill.png', { type: 'image/png' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: lang.currentBill,
                            text: lang.customerDetails
                        })
                        .finally(() => { button.innerText = originalText; button.disabled = false; setLanguage(currentLanguage); });
                    } else {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = 'bill.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        alert(lang.imageDownloaded);
                        button.innerText = originalText; button.disabled = false; setLanguage(currentLanguage);
                    }
                }, 'image/png');
            }).catch(err => {
                console.error("Oops, something went wrong!", err);
                alert(lang.imageCreationFailed);
                button.innerText = originalText; button.disabled = false; setLanguage(currentLanguage);
            });
        });

        document.getElementById('printBillBtn').addEventListener('click', () => { window.print(); });

        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('change', function() {
            if (this.checked) { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); } 
            else { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); }
        });

        if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); themeToggle.checked = true; }
    };

    // --- ऐप शुरू करें ---
    attachAllEventListeners();
    initializeApp();
});
</script>

</body>
</html>