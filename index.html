<!DOCTYPE html>
<html lang="hi" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1418151912-161119191816 121118111011</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style id="dynamic-print-style"></style>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #fff;
            --text-color: #2c3e50;
            --border-color: #ccc;
            --input-bg: #fff;
            --primary-color: #3498db;
            --shadow-color: rgba(0,0,0,0.1);
            --balance-due-bg: rgba(231, 76, 60, 0.1);
            --balance-due-text: #e74c3c;
            --balance-payable-bg: rgba(243, 156, 18, 0.1);
            --balance-payable-text: #f39c12;
        }
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --input-bg: #2c2c2c;
            --primary-color: #4a90e2;
            --shadow-color: rgba(255,255,255,0.1);
            --balance-due-bg: rgba(231, 76, 60, 0.2);
            --balance-due-text: #e85a4f;
            --balance-payable-bg: rgba(243, 156, 18, 0.2);
            --balance-payable-text: #f39c12;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1100px; margin: 20px auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
        .form-container { max-width: 500px; }
        .hidden { display: none; }
        h1, h2, h3, h4 { color: var(--text-color); text-align: center; margin-top: 0; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        h4, h5 { text-align: left; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; text-align: left; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color); }
        button { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .action-button { width: auto; padding: 5px 10px; font-size: 14px; margin-right: 5px; }
        .action-button.edit { background-color: #f39c12; }
        .action-button.delete { background-color: #e74c3c; }
        .action-button.view { background-color: #27ae60; }
        .action-button.print { background-color: #9b59b6; }
        .app-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-link.active { border-bottom-color: var(--primary-color); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .main-layout { display: grid; gap: 30px; grid-template-columns: 1fr 1.5fr; }
        .customer-details-grid { display: grid; gap: 20px; grid-template-columns: 1fr 1fr; }
        @media (max-width: 768px) { .main-layout, .profile-layout, .customer-details-grid { grid-template-columns: 1fr; } }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .data-table th, .data-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        .data-table tfoot th { text-align: right; }
        .data-table .credit-col { color: #27ae60; } .data-table .debit-col { color: #e74c3c; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--container-bg); margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; font-family: 'Segoe UI', sans-serif; border-radius: 8px; }
        body.dark-mode .modal-content { border-color: #555; }
        .bill-summary-row { display: flex; justify-content: space-between; font-size: 1.1em; padding: 5px 0; }
        .bill-summary-row.grand-total { font-weight: bold; font-size: 1.3em; border-top: 2px solid var(--text-color); margin-top: 10px; padding-top: 10px;}
        .search-container { position: relative; }
        .search-results { position: absolute; width: 100%; border: 1px solid var(--border-color); background-color: var(--container-bg); z-index: 99; max-height: 200px; overflow-y: auto; }
        .search-item { padding: 10px; cursor: pointer; } .search-item:hover { background-color: rgba(0,0,0,0.1); }
        body.dark-mode .search-item:hover { background-color: rgba(255,255,255,0.1); }
        .history-item { border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .history-item-actions button { width: auto; font-size: 12px; padding: 6px 10px; margin-top: 5px; margin-right: 10px; }
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: flex-end; margin-left: 20px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .backup-container { padding: 20px; text-align: center; border: 2px dashed var(--border-color); border-radius: 8px; }
        .backup-container button { width: auto; max-width: 250px; }
        .report-section { border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .report-section button { width: auto; font-size: 14px; padding: 8px 15px; margin-right: 10px; }
        .forgot-password { text-align: right; margin-top: -10px; margin-bottom: 15px; }
        .forgot-password a { color: var(--primary-color); text-decoration: none; font-size: 0.9em; }
        .purchase-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: flex-end;}
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .dashboard-card { background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px var(--shadow-color); text-align: center; }
        .dashboard-card h5 { border: none; font-size: 1.1em; }
        .dashboard-card p { font-size: 1.8em; font-weight: bold; margin: 10px 0 0 0; }
        .dashboard-card .profit { color: #27ae60; }
        .dashboard-card .loss { color: #e74c3c; }
        #image-to-crop { display: block; max-width: 100%; }
        #print-preview-content { border: 1px solid var(--border-color); padding: 10px; margin-top: 15px; overflow: auto; resize: vertical; min-height: 200px; max-height: 50vh; background-color: var(--bg-color); }
        .print-options { display: flex; justify-content: center; gap: 20px; margin: 15px 0; align-items: center; }
        .print-options label { margin: 0; display: flex; align-items: center; gap: 5px; }
        .preview-a4 { width: 100%; height: auto; }
        .preview-80mm { width: 80mm; margin: 0 auto; }
        .preview-58mm { width: 58mm; margin: 0 auto; }
        .chart-container { background: var(--input-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 4px var(--shadow-color); }
        
        .dashboard-top-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .dashboard-top-charts .chart-container { height: 280px; display: flex; flex-direction: column; }
        .dashboard-top-charts .chart-container canvas { flex-grow: 1; min-height: 0; max-height: 100%; }
        .dashboard-grid, .top-products-container { margin-top: 30px; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .radio-group label { font-weight: normal; }
        #purchase-tab, #purchase-tab input, #purchase-tab select, #purchase-tab textarea { font-family: 'Segoe UI', sans-serif; }
        .profile-image-upload { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin-top: 10px; }
        .profile-image-upload img { max-width: 150px; max-height: 80px; border: 1px solid var(--border-color); padding: 5px; }
        #item-details-calculator, #purchase-item-calculator { border: 1px solid var(--border-color); padding: 15px; margin-top: 15px; border-radius: 5px; }
        .item-calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-calc-grid label { margin-bottom: 5px; }
        .item-calc-grid input { margin-bottom: 5px; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; }
        .sidebar { position: fixed; top: 0; right: -450px; width: 400px; max-width: 90%; height: 100%; background-color: var(--container-bg); box-shadow: -2px 0 8px rgba(0,0,0,0.15); z-index: 1002; transition: right 0.3s ease-in-out; overflow-y: auto; padding: 20px; padding-top: 50px; box-sizing: border-box; }
        .sidebar.open { right: 0; }
        .close-sidebar-btn { position: absolute; top: 10px; right: 15px; font-size: 2.5rem; font-weight: bold; line-height: 1; color: var(--text-color); background: transparent; border: none; cursor: pointer; padding: 0; width: auto; margin: 0; }
        .cashflow-in { color: #27ae60; font-weight: bold; }
        .cashflow-out { color: #e74c3c; font-weight: bold; }
        #sell-inventory-list-container { max-height: 400px; overflow-y: auto; margin-top: 20px; }
        .balance-display { text-align: right; font-size: 1.2em; padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .balance-due { background-color: var(--balance-due-bg); color: var(--balance-due-text); }
        .balance-payable { background-color: var(--balance-payable-bg); color: var(--balance-payable-text); }
        .whatsapp-reminder-btn { background-color: #25D366 !important; width: auto !important; font-size: 12px !important; padding: 6px 10px !important; margin-left: 10px; }
        .inventory-filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 20px; }
        .inventory-filters > div { display: flex; gap: 10px; align-items: center; }
        .inventory-filters label { margin-bottom: 0; font-weight: normal; }
        .column-toggles { border-left: 1px solid var(--border-color); padding-left: 15px; }

        @media print {
             body > *:not(.printable-area-for-print) { display: none !important; }
            .printable-area-for-print { display: block !important; position: absolute; left: 0; top: 0; margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div class="printable-area-for-print"></div>
    <!-- 141312 101916 -->
    <div id="welcome-page" class="container form-container">
        <div style="text-align: center;">
            <img src="logo.png" alt="App Logo" style="max-width: 150px; margin-bottom: 20px;">
        </div>
        <h2 style="border:none;">Welcome Billing App</h2>
        <div style="text-align:center;">
            <button id="goToLoginBtn" data-lang-key="login">1811111118 19161910</button>
            <button id="goToSignUpBtn" data-lang-key="createAccount">181510 131910171019 1218101310</button>
        </div>
    </div>
    <div id="signup-page" class="container form-container hidden"><button class="back-btn" id="signupBackBtn" data-lang-key="back">← 11101014</button><h2 data-lang-key="createAccount">181510 131910171019 1218101310</h2><form id="signupForm"><label data-lang-key="shopNameLabel">1613191018 1910 181014:</label><input type="text" id="signupShopName" required><label data-lang-key="emailLabel">16141918:</label><input type="email" id="signupEmail" required><label data-lang-key="mobileLabel">141312101518:</label><input type="tel" id="signupPhone" required><label data-lang-key="passwordLabel">10101411161511:</label><input type="password" id="signupPassword" required><button type="submit" data-lang-key="signUp">14101518 1310</button></form></div>
    <div id="login-page" class="container form-container hidden"><button class="back-btn" id="loginBackBtn" data-lang-key="back">← 11101014</button><h2 data-lang-key="login">1811111118 19161910</h2><form id="loginForm"><label data-lang-key="emailOrMobileLabel">16141918 1510 141312101518:</label><input type="text" id="loginIdentifier" required><label data-lang-key="passwordLabel">10101411161511:</label><input type="password" id="loginPassword" required><div class="forgot-password"><a href="#" id="forgotPasswordLink" data-lang-key="forgotPassword">10101411161511 131418 1113?</a></div><button type="submit" data-lang-key="login">1811111118 19161910</button></form></div>
    
    <div id="reset-password-page" class="container form-container hidden">
        <button class="back-btn" id="resetBackBtn" data-lang-key="back">← 11101014</button>
        <h2 data-lang-key="resetPasswordTitle">10101411161511 1612141919 19161910</h2>
        <form id="resetPasswordForm">
            <p data-lang-key="enterRegisteredEmail" style="text-align:left; border:none; margin-bottom:10px; font-size:0.9em;">13101810 10101612191514 16141918 16161516 1916191018</p>
            <label data-lang-key="emailLabel">16141918:</label>
            <input type="email" id="resetEmail" required>
            <button type="button" id="verifyEmailBtn" data-lang-key="verifyEmail">16141918 1414151510101114 19161910</button>
            <div id="newPasswordSection" class="hidden" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top:20px;">
                <p data-lang-key="enterRegisteredMobile" style="text-align:left; border:none; margin-bottom:10px; font-size:0.9em;">1015141018 1414151510101114 19161819 1919 181113 13101810 10101612191514 141312101518 18101216 16161516 1916191018</p>
                <label data-lang-key="mobileLabel">141312101518:</label>
                <input type="tel" id="resetPhone" required>
                <label data-lang-key="newPassword">181510 10101411161511:</label>
                <input type="password" id="resetNewPassword" required>
                <label data-lang-key="confirmPassword">10101411161511 1912 101313151911 19161910:</label>
                <input type="password" id="resetConfirmPassword" required>
                <button type="submit" id="resetPasswordBtn" data-lang-key="resetPasswordBtnText">10101411161511 1612141919 19161910</button>
            </div>
        </form>
    </div>

    <!-- 1413101515 131015181219191218 -->
    <div id="main-app" class="container hidden">
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
            <select id="language-select" style="width: auto; padding: 5px; margin-right: 15px;">
                <option value="hi">1511101612</option>
                <option value="en">English</option>
            </select>
            <button id="headerSettingsBtn" title="Settings" style="width: auto; margin-left: 20px; background: transparent; border: none; cursor: pointer; padding: 5px; line-height: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px" fill="var(--text-color)"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </div>
        <h2 id="retailerShopName"></h2>
        <hr>
        <div class="app-tabs" id="appTabsContainer">
            <span class="tab-link active" data-tab="dashboard" data-lang-key="dashboardTab">1110121213161511</span>
            <span class="tab-link" data-tab="sell" data-lang-key="sellTab">121119151612</span>
            <span class="tab-link" data-tab="estimate" data-lang-key="estimateTab">1314151912141919</span>
            <span class="tab-link" data-tab="purchase" data-lang-key="purchaseTab">10161216</span>
            <span class="tab-link" data-tab="inventory" data-lang-key="inventoryTab">151815111910191612</span>
            <span class="tab-link" data-tab="cashflow" data-lang-key="cashFlowTab">191012 11151813</span>
            <span class="tab-link" data-tab="expenses" data-lang-key="expensesTab">1016151419</span>
            <span class="tab-link" data-tab="suppliers" data-lang-key="suppliersTab">141014161514111916151410</span>
            <span class="tab-link" data-tab="customers" data-lang-key="customersTab">111516101519</span>
            <span class="tab-link" data-tab="reports" data-lang-key="reportsTab">161110131615191514</span>
            <span class="tab-link" data-tab="profile" data-lang-key="profileTab">101516131118101518</span>
            <span class="tab-link" data-tab="backup" data-lang-key="backupRestoreTab">1210191310/16111415191316</span>
        </div>
        
        <!-- 1110121213161511 191012 -->
        <div id="dashboard-tab" class="tab-content active">
             <div class="dashboard-top-charts">
                 <div class="chart-container">
                    <h4 data-lang-key="salesReportTitle">121119151612</h4>
                     <canvas id="salesChart"></canvas>
                 </div>
                 <div class="chart-container">
                    <h4 data-lang-key="purchaseReportTitle">10161216</h4>
                     <canvas id="purchaseChart"></canvas>
                 </div>
                 <div class="chart-container">
                     <h4 data-lang-key="profitAndLoss">181013 1816 15101811</h4>
                     <canvas id="profitLossChart"></canvas>
                 </div>
            </div>
             <div class="dashboard-grid">
                <div class="dashboard-card"><h5 data-lang-key="totalSales">191318 121119151612</h5><p style="color: #27ae60;" id="totalSalesDisplay">640.00</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalPurchases">191318 10161216</h5><p style="color: #e74c3c;" id="totalPurchasesDisplay">640.00</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalExpenses">191318 10161514</h5><p class="loss" id="totalExpensesDisplay">640.00</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalBillsGenerated">191318 121118</h5><p id="totalBillsDisplay">0</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalStockValuePurchase">191318 1415191119 1414181515 (10161216)</h5><p id="totalStockValuePurchaseDisplay">640.00</p></div>
                <div class="dashboard-card"><h5 data-lang-key="totalStockValueSale">191318 1415191119 1414181515 (121119151612)</h5><p id="totalStockValueSaleDisplay">640.00</p></div>
            </div>
             <div class="chart-container top-products-container">
                <h4 data-lang-key="topSellingProducts">14121419 161515101610 1211191819 11101819 171415101016</h4>
                <table class="data-table"><thead><tr><th data-lang-key="productColumn">171415101016</th><th data-lang-key="quantitySold">12111912 151316 141014151610</th></tr></thead><tbody id="topSellingTableBody"></tbody></table>
            </div>
        </div>
        
        <!-- 141918 191012 (UPDATED) -->
        <div id="sell-tab" class="tab-content">
             <div class="main-layout">
                <div>
                    <h4 data-lang-key="customerDetails">111516101519 1910 1111111613</h4>
                    <form id="customerDetailsForm">
                        <div class="customer-details-grid">
                            <div class="search-container"><label data-lang-key="customerName">111516101519 1910 181014:</label><input type="text" id="billingCustomerName" autocomplete="off"><div id="customerSearchResultsContainer" class="search-results hidden"></div></div>
                            <div><label data-lang-key="customerPhone">111516101519 1910 11181318:</label><input type="tel" id="billingCustomerPhone" required></div>
                        </div>
                        <label data-lang-key="customerAddress">111516101519 1910 101410:</label><textarea id="billingCustomerAddress" rows="1"></textarea>
                    </form>
                    <hr style="margin:20px 0;">
                    <h4 data-lang-key="addItem">14151914 161311181910</h4>
                     <div class="radio-group">
                        <label><input type="radio" name="itemType" value="product" checked> <span data-lang-key="product">171415101016</span></label>
                        <label><input type="radio" name="itemType" value="service"> <span data-lang-key="service">141615111114</span></label>
                    </div>
                    <div id="product-fields">
                         <div class="search-container"><label data-lang-key="addProductLabel">171415101016 1013161910:</label><input type="text" id="productSearchInput" autocomplete="off"><div id="searchResultsContainer" class="search-results hidden"></div></div>
                         <div id="item-details-calculator" class="hidden">
                             <h5 id="calculatorProductName"></h5>
                             <div class="item-calc-grid">
                                <div><label data-lang-key="quantity">141014151610:</label><input type="number" id="calcQuantity" value="1" min="0.01" step="0.01"></div>
                                <div><label data-lang-key="unitLabel">15191016:</label><input type="text" id="calcUnit" readonly></div>
                                <div><label data-lang-key="basePrice">121914 101516101514 (64):</label><input type="number" id="calcBasePrice" min="0" step="0.01"></div>
                                <div><label data-lang-key="gstPercent">GST (%):</label><input type="number" id="calcGstPercent" min="0" step="0.01" value="0"></div>
                             </div>
                             <div><label data-lang-key="totalPrice">191318 1414181515/15191016 (64):</label><input type="number" id="calcTotalPrice" min="0" step="0.01"></div>
                             <p><strong><span data-lang-key="lineTotal">191318:</span> 64<span id="calcLineTotal">0.00</span></strong></p>
                             <button type="button" id="addItemToBillBtn" data-lang-key="addToBill">121118 141910 161311181910</button>
                         </div>
                    </div>
                     <div id="service-fields" class="hidden">
                         <label data-lang-key="serviceDescription">141615111114 1111111613:</label><input type="text" id="serviceDescriptionInput">
                         <label data-lang-key="serviceCharge">141615111114 1410161516 (64):</label><input type="number" id="serviceChargeInput" min="0">
                         <div class="radio-group" style="margin-bottom: 10px;">
                            <label><input type="radio" name="serviceGstType" value="without_gst" checked> <span data-lang-key="withoutGst">12111810 GST</span></label>
                            <label><input type="radio" name="serviceGstType" value="with_gst"> <span data-lang-key="withGst">GST 14151114</span></label>
                         </div>
                         <div id="service-gst-field-container" class="hidden" style="margin-bottom: 15px;">
                            <label data-lang-key="gstPercent">GST (%):</label>
                            <input type="number" id="serviceGstPercent" min="0" step="0.01" value="0">
                         </div>
                        <button type="button" id="addServiceToBillBtn" data-lang-key="addToBill">121118 141910 161311181910</button>
                    </div>

                </div>
                <div>
                    <h4 data-lang-key="currentBill">11161514141018 121118</h4>
                    <table class="data-table"><thead><tr><th data-lang-key="productColumn">171415101016/141615111114</th><th data-lang-key="quantityColumn">141014151610</th><th data-lang-key="priceColumn">1414181515</th><th data-lang-key="totalColumn">191318</th></tr></thead><tbody id="currentBillBody"></tbody></table>
                    <div style="text-align:right; margin-top:15px;" id="billSummary">
                        <div class="bill-summary-row"><span data-lang-key="subTotal">1710-151311 (Subtotal):</span><span>64<span id="subTotalDisplay">0.00</span></span></div>
                        <div class="bill-summary-row"><span data-lang-key="totalGst">191318 GST:</span><span>+ 64<span id="totalGstDisplay">0.00</span></span></div>
                        <div class="bill-summary-row" style="align-items:center;"><label for="discountInput" style="margin:0; text-align:right; margin-right:10px;" data-lang-key="discount">111114151910171019:</label><div style="display:flex; width: 60%;"><input type="number" id="discountInput" style="width: 70%; margin:0;" value="0"><select id="discountType" style="width: 30%; margin:0; padding:10px 5px;"><option value="percent">%</option><option value="fixed">64</option></select></div></div>
                        <div class="bill-summary-row grand-total"><span data-lang-key="grandTotal">191318 161915:</span><span>64<span id="grandTotalDisplay">0.00</span></span></div>
                    </div>
                    <button id="generateBillBtn" style="margin-top: 20px;" data-lang-key="generateBill">121118 1218101310</button>
                    <div style="margin-top: 30px;">
                        <h4 data-lang-key="recentSales">151018 1912 121119151612</h4>
                        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                            <label data-lang-key="fromDate" style="width:auto; margin-bottom:0;">1419:</label>
                            <input type="date" id="salesHistoryFromDate" style="width:150px; margin-bottom:0;">
                            <label data-lang-key="toDate" style="width:auto; margin-bottom:0;">1419:</label>
                            <input type="date" id="salesHistoryToDate" style="width:150px; margin-bottom:0;">
                        </div>
                        <div id="tabSellHistoryContainer" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1314151912141919 191012 -->
        <div id="estimate-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="customerDetails">111516101519 1910 1111111613</h4>
                    <form id="estimateCustomerDetailsForm">
                        <div class="customer-details-grid">
                            <div class="search-container"><label data-lang-key="customerName">111516101519 1910 181014:</label><input type="text" id="estimateCustomerName" autocomplete="off"><div id="estimateCustomerSearchResultsContainer" class="search-results hidden"></div></div>
                            <div><label data-lang-key="customerPhone">111516101519 1910 11181318:</label><input type="tel" id="estimateCustomerPhone" required></div>
                        </div>
                        <label data-lang-key="customerAddress">111516101519 1910 101410:</label><textarea id="estimateCustomerAddress" rows="1"></textarea>
                    </form>
                    <hr style="margin:20px 0;">
                    <h4 data-lang-key="addItem">14151914 161311181910</h4>
                    <div class="search-container"><label data-lang-key="addProductLabel">171415101016 1013161910:</label><input type="text" id="estimateProductSearchInput" autocomplete="off"><div id="estimateSearchResultsContainer" class="search-results hidden"></div></div>
                    <div id="estimate-item-details-calculator" class="hidden">
                         <h5 id="estimateCalculatorProductName"></h5>
                         <div class="item-calc-grid">
                            <div><label data-lang-key="quantity">141014151610:</label><input type="number" id="estimateCalcQuantity" value="1" min="0.01" step="0.01"></div>
                            <div><label data-lang-key="unitLabel">15191016:</label><input type="text" id="estimateCalcUnit" readonly></div>
                         </div>
                         <div><label data-lang-key="priceLabel">121119151612 1414181515/15191016 (64):</label><input type="number" id="estimateCalcPrice" min="0" step="0.01"></div>
                         <p><strong><span data-lang-key="lineTotal">191318:</span> 64<span id="estimateCalcLineTotal">0.00</span></strong></p>
                         <button type="button" id="addItemToEstimateBtn" data-lang-key="addToEstimate">1314151912141919 141910 161311181910</button>
                    </div>
                </div>
                <div>
                    <h4 data-lang-key="currentEstimate">11161514141018 1314151912141919</h4>
                    <table class="data-table"><thead><tr><th data-lang-key="productColumn">171415101016</th><th data-lang-key="quantityColumn">141014151610</th><th data-lang-key="priceColumn">1414181515</th><th data-lang-key="totalColumn">191318</th></tr></thead><tbody id="currentEstimateBody"></tbody></table>
                    <div style="text-align:right; margin-top:15px;" id="estimateSummary">
                        <div class="bill-summary-row grand-total"><span data-lang-key="grandTotal">191318 151311:</span><span>64<span id="estimateGrandTotalDisplay">0.00</span></span></div>
                    </div>
                    <button id="generateEstimateBtn" style="margin-top: 20px;" data-lang-key="generateEstimate">1314151912141919 1218101310</button>
                </div>
            </div>
        </div>
        
        <!-- 10161216 191012 -->
        <div id="purchase-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="purchaseEntryTitle">1816 10161216 101516111113151911</h4>
                    <form id="addPurchaseItemForm">
                         <fieldset id="supplier-details-fieldset">
                            <h5 data-lang-key="supplierDetails" style="border:none;">141014161514111916151410 1111111613</h5>
                            <div class="customer-details-grid">
                                <div class="search-container">
                                    <label data-lang-key="supplierName">141014161514111916151410 1910 181014:</label>
                                    <input type="text" id="purchaseSupplierName" required autocomplete="off">
                                    <div id="supplierPurchaseSearchResultsContainer" class="search-results hidden"></div>
                                </div>
                                <div>
                                    <label data-lang-key="supplierPhone">141014161514111916151410 1910 11181318:</label>
                                    <input type="tel" id="purchaseSupplierPhone" required>
                                </div>
                            </div>
                            <label data-lang-key="supplierAddressLabel">141014161514111916151410 1910 101410:</label>
                            <textarea id="purchaseSupplierAddress" rows="1"></textarea>

                            <div class="purchase-form-grid">
                                <div>
                                    <label data-lang-key="purchaseBillNo">10161216 121118 18101216:</label>
                                    <input type="text" id="purchaseBillNo">
                                </div>
                                <div>
                                    <label data-lang-key="purchaseBillDate">121118 1912 1410161210:</label>
                                    <input type="date" id="purchaseBillDate">
                                </div>
                            </div>
                         </fieldset>

                        <hr style="margin:20px 0;">
                        <h5 data-lang-key="addProductToPurchase" style="border:none;">10161216 141910 171415101016 161311181910</h5>
                        
                        <div class="purchase-form-grid">
                           <div>
                                <label data-lang-key="productName">171415101016 1910 181014</label>
                                <input type="text" id="purchaseProductName" required>
                           </div>
                           <div>
                                <label data-lang-key="hsnSac">HSN/SAC:</label>
                                <input type="text" id="purchaseHsnSac">
                           </div>
                        </div>
                        
                        <div id="purchase-item-calculator">
                            <h5 data-lang-key="purchasePriceDetails" style="border:none; margin-top:0;">10161216 1414181515 1111111613</h5>
                            <div class="radio-group" style="margin-bottom:10px;">
                                <label><input type="radio" name="gstType" value="without_gst" checked> <span data-lang-key="withoutGst">12111810 GST</span></label>
                                <label><input type="radio" name="gstType" value="with_gst"> <span data-lang-key="withGst">GST 14151114</span></label>
                            </div>
                            <div class="item-calc-grid">
                                <div>
                                    <label data-lang-key="basePrice">121914 101516101514/1514181119 (64)</label>
                                    <input type="number" id="purchaseBasePrice" required min="0.01" step="0.01">
                                </div>
                                <div id="gst-field-container" class="hidden">
                                    <label data-lang-key="gstPercent">GST (%)</label>
                                    <input type="number" id="purchaseGstPercent" min="0" step="0.01" value="0">
                                </div>
                            </div>
                            <div>
                                <label data-lang-key="totalPurchasePrice">191318 10161216 1414181515/1514181119 (64)</label>
                                <input type="number" id="purchaseTotalPrice" required min="0.01" step="0.01">
                            </div>

                            <hr style="margin:15px 0;">
                            <h5 data-lang-key="sellingPriceDetails" style="border:none;">121119151612 1414181515 1111111613</h5>
                            
                            <div class="purchase-form-grid" style="align-items: flex-end;">
                                <div>
                                    <label data-lang-key="profitMargin">181013 14101615161118</label>
                                    <input type="number" id="purchaseProfitMarginValue" value="0" min="0" step="0.01">
                                </div>
                                <div>
                                    <select id="purchaseProfitMarginType" style="margin-bottom: 0;">
                                        <option value="percent">%</option>
                                        <option value="fixed">64</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label data-lang-key="sellingPriceLabel">121119151612 1414181515/1514181119 (64)</label>
                                <input type="number" id="purchaseSellingPrice" required min="0.01" step="0.01" readonly>
                            </div>
                        </div>

                        <div class="purchase-form-grid" style="margin-top:15px;">
                            <div>
                                <label data-lang-key="quantity">141014151610</label>
                                <input type="number" id="purchaseQuantity" required min="0.01" step="0.01">
                            </div>
                            <div>
                                <label data-lang-key="unitLabel">15191016</label>
                                <select id="purchaseUnit">
                                    <option>Pcs</option><option>Kg</option><option>Gm</option>
                                    <option>Ltr</option><option>Mtr</option>
                                </select>
                            </div>
                        </div>
                         <button type="submit" id="purchaseSubmitBtn" style="margin-top: 10px;" data-lang-key="addToPurchaseAndInventory">10161216 16111911161511 19161910 1816 1415191119 141910 161311181910</button>
                    </form>
                </div>
                <div>
                     <h4 data-lang-key="recentPurchases">151018 1912 10161216</h4>
                      <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                        <label data-lang-key="fromDate" style="width:auto; margin-bottom:0;">1419:</label>
                        <input type="date" id="purchaseHistoryFromDate" style="width:150px; margin-bottom:0;">
                        <label data-lang-key="toDate" style="width:auto; margin-bottom:0;">1419:</label>
                        <input type="date" id="purchaseHistoryToDate" style="width:150px; margin-bottom:0;">
                    </div>
                     <p data-lang-key="selectSupplierToViewHistory" style="text-align:center; font-style:italic;">141014161514111916151410 1912 141312 10161216 1619101819 1919 181113 '141014161514111916151410' 191012 1016 1610131018</p>
                     <div id="tabPurchaseHistoryContainer" style="max-height: 450px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- 151815111910191612 191012 (UPDATED) -->
        <div id="inventory-tab" class="tab-content">
            <h4 data-lang-key="currentStock">11161514141018 1415191119</h4>
            <div class="inventory-filters">
                <input type="text" id="inventorySearchInput" placeholder="171415101016 1013161910..." style="width: 200px; margin-bottom:0;">
                <div>
                    <label data-lang-key="fromDate">1419:</label>
                    <input type="date" id="inventoryFromDate" style="width: 150px; margin-bottom:0;">
                    <label data-lang-key="toDate">1419:</label>
                    <input type="date" id="inventoryToDate" style="width: 150px; margin-bottom:0;">
                </div>
                <div class="column-toggles">
                    <label><input type="checkbox" class="column-toggle" data-col="1" checked> 1415191119</label>
                    <label><input type="checkbox" class="column-toggle" data-col="2" checked> 10161216 1414181515</label>
                    <label><input type="checkbox" class="column-toggle" data-col="3" checked> 121119151612 1414181515</label>
                    <label><input type="checkbox" class="column-toggle" data-col="4" checked> 191318 10161216</label>
                    <label><input type="checkbox" class="column-toggle" data-col="5" checked> 191318 121119151612</label>
                </div>
            </div>
            <div id="inventoryToPrint">
                <div style="overflow-x:auto;">
                    <table class="data-table" id="stockTable">
                        <thead>
                            <tr>
                                <th data-col-name="productColumn" data-lang-key="productColumn">171415101016</th>
                                <th data-col-name="inStock" data-lang-key="inStock">1415191119 141910</th>
                                <th data-col-name="purchasePrice" data-lang-key="purchasePrice">10161216 1414181515/1514181119</th>
                                <th data-col-name="priceLabel" data-lang-key="priceLabel">121119151612 1414181515/1514181119</th>
                                <th data-col-name="purchaseValue" data-lang-key="purchaseValue">191318 10161216 1414181515</th>
                                <th data-col-name="saleValue" data-lang-key="saleValue">191318 121119151612 1414181515</th>
                                <th data-col-name="actionColumn" data-lang-key="actionColumn">1319151218</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody"></tbody>
                        <tfoot id="stockTableFooter"></tfoot>
                    </table>
                </div>
            </div>
             <div style="display:flex; gap:15px; margin-top:20px;" class="no-print">
                    <button id="printStockBtn" data-lang-key="printStock">1415191119 101516111019 19161910</button>
                    <button id="saveStockPdfBtn" data-lang-key="saveAsPdf">PDF 1919 161410 141910 141519161910</button>
                </div>
        </div>

        <!-- 191012 11151813 191012 (NEW) -->
        <div id="cashflow-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addCashFlowTitle">1816 191012 131019151612</h4>
                    <form id="addCashFlowForm">
                        <label data-lang-key="transactionType">181918-161918 1910 101516191016:</label>
                        <select id="cashFlowType">
                            <option value="in" data-lang-key="cashIn">191012-1518 (161410)</option>
                            <option value="out" data-lang-key="cashOut">191012-141719 (181119101412)</option>
                        </select>
                        <label data-lang-key="amountColumn">16101211 (64):</label>
                        <input type="number" id="cashFlowAmount" min="0.01" step="0.01" required>
                        <div class="search-container">
                            <label data-lang-key="associatedParty">14101210171114 101016151912 (111516101519/141014161514111916151410):</label>
                            <input type="text" id="cashFlowPartySearch" autocomplete="off" placeholder="111516101519/141014161514111916151410 1013161910...">
                            <input type="hidden" id="cashFlowPartyId">
                             <div id="cashFlowSearchResultsContainer" class="search-results hidden"></div>
                        </div>
                        <label data-lang-key="paymentMode">131311141018 1910 1416121910:</label>
                        <select id="cashFlowPaymentMode">
                            <option value="Cash" data-lang-key="cash">181916</option>
                            <option value="Online" data-lang-key="online">151818101518</option>
                            <option value="Check" data-lang-key="check">141919</option>
                            <option value="QR" data-lang-key="qr">QR</option>
                        </select>
                        <label data-lang-key="dateColumn">1410161210:</label>
                        <input type="date" id="cashFlowDate" required>
                        <label data-lang-key="notes">1813191514:</label>
                        <textarea id="cashFlowNotes" rows="2" placeholder="121118 18101216, 131311141018 1910 1111111613, 141611"></textarea>
                        <button type="submit" data-lang-key="addEntry">131019151612 161311181910</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="cashFlowSummary">191012 11151813 141016101012</h4>
                    <div class="dashboard-grid" style="margin-top:0;">
                        <div class="dashboard-card"><h5 data-lang-key="totalCashIn">191318 161410</h5><p class="cashflow-in" id="totalCashInDisplay">640.00</p></div>
                        <div class="dashboard-card"><h5 data-lang-key="totalCashOut">191318 181119101412</h5><p class="cashflow-out" id="totalCashOutDisplay">640.00</p></div>
                        <div class="dashboard-card"><h5 data-lang-key="netBalance">181919 121018191014</h5><p id="netBalanceDisplay">640.00</p></div>
                    </div>
                    <h4 data-lang-key="cashFlowHistory" style="margin-top:20px;">191012 11151813 151411151014</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="dateColumn">1410161210</th>
                                <th data-lang-key="descriptionColumn">1111111613</th>
                                <th data-lang-key="paymentMode">131311141018 1910 1416121910</th>
                                <th data-lang-key="amountColumn">16101211</th>
                            </tr>
                        </thead>
                        <tbody id="cashFlowTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 10161514 191012 -->
        <div id="expenses-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addExpenseTitle">181510 10161514 161311181910</h4>
                    <form id="addExpenseForm">
                        <label data-lang-key="expenseDescription">10161514 1910 1111111613:</label>
                        <input type="text" id="expenseDescription" required>
                        <label data-lang-key="expenseAmount">16101211 (64):</label>
                        <input type="number" id="expenseAmount" min="0.01" step="0.01" required>
                         <label data-lang-key="expenseDate">10161514 1912 1410161210:</label>
                        <input type="date" id="expenseDate" required>
                        <button type="submit" data-lang-key="addExpenseBtn">10161514 161311181910</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="expenseListTitle">101615141310 1912 14141412</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="descriptionColumn">1111111613</th>
                                <th data-lang-key="amountColumn">16101211</th>
                                <th data-lang-key="dateColumn">1410161210</th>
                                <th data-lang-key="actionColumn">1319151218</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="suppliers-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addSupplier">181510 141014161514111916151410 161311181910</h4>
                    <form id="addSupplierForm">
                        <label data-lang-key="supplierName">141014161514111916151410 1910 181014:</label>
                        <input type="text" id="supplierName" required>
                        <label data-lang-key="supplierPhone">141014161514111916151410 1910 11181318:</label>
                        <input type="tel" id="supplierPhone" required>
                        <label data-lang-key="supplierAddress">141014161514111916151410 1910 101410:</label>
                        <textarea id="supplierAddress" rows="2"></textarea>
                        <label data-lang-key="gstinLabel">GST 18101216:</label>
                        <input type="text" id="supplierGstin">
                        <button type="submit" id="supplierSubmitBtn" data-lang-key="addSupplierBtn">141014161514111916151410 161311181910</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="supplierList">1410141615141119161514101710 1912 14141412</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="nameColumn">181014</th>
                                <th data-lang-key="phoneColumn">11181318</th>
                                <th data-lang-key="actionColumn">1319151218</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="customers-tab" class="tab-content">
            <div class="main-layout">
                <div>
                    <h4 data-lang-key="addCustomer">181510 111516101519 161311181910</h4>
                    <form id="addCustomerForm">
                        <label data-lang-key="customerName">111516101519 1910 181014:</label>
                        <input type="text" id="addCustomerName" required>
                        <label data-lang-key="customerPhone">111516101519 1910 11181318:</label>
                        <input type="tel" id="addCustomerPhone" required>
                        <label data-lang-key="customerAddress">111516101519 1910 101410:</label>
                        <textarea id="addCustomerAddress" rows="2"></textarea>
                        <label data-lang-key="gstinLabel">GST 18101216:</label>
                        <input type="text" id="addCustomerGstin">
                        <button type="submit" id="customerSubmitBtn" data-lang-key="addCustomerBtn">111516101519 161311181910</button>
                    </form>
                </div>
                <div>
                    <h4 data-lang-key="customerList">1115161015191310 1912 14141412</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-lang-key="nameColumn">181014</th>
                                <th data-lang-key="phoneColumn">11181318</th>
                                <th data-lang-key="actionColumn">1319151218</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="reports-tab" class="tab-content">
            <h4 data-lang-key="downloadReportsTitle">161110131615191514 11101718181311 19161910</h4>
            <div class="report-section">
                <h5 data-lang-key="salesReportTitle">121119151612 16111013161519</h5>
                <p data-lang-key="salesReportDesc" style="border:none; margin-bottom:15px; text-align:left;">1319 14111511 14121410 1919 13121416 141312 1211181310 1912 11111415141514 14141412 11101718181311 1916191018</p>
                <div style="display: flex; flex-wrap:wrap; gap: 15px; align-items: center; margin-bottom: 15px;">
                     <label data-lang-key="fromDate" style="width:auto; margin-bottom:0;">1419:</label>
                     <input type="date" id="salesReportFromDate" style="width:150px; margin-bottom:0;">
                     <label data-lang-key="toDate" style="width:auto; margin-bottom:0;">1419:</label>
                     <input type="date" id="salesReportToDate" style="width:150px; margin-bottom:0;">
                </div>
                <button id="downloadSalesPdfBtn" data-lang-key="downloadAsPdf">PDF 141910 11101718181311 19161910</button>
                <button id="downloadSalesCsvBtn" data-lang-key="downloadAsCsv">CSV 141910 11101718181311 19161910</button>
            </div>
             <div class="report-section">
                <h5 data-lang-key="purchaseReportTitle">10161216 16111013161519</h5>
                <p data-lang-key="purchaseReportDesc" style="border:none; margin-bottom:15px; text-align:left;">1319 14111511 14121410 1919 13121416 141312 10161216 1912 11111415141514 14141412 11101718181311 1916191018</p>
                <div style="display: flex; flex-wrap:wrap; gap: 15px; align-items: center; margin-bottom: 15px;">
                     <label data-lang-key="fromDate" style="width:auto; margin-bottom:0;">1419:</label>
                     <input type="date" id="purchaseReportFromDate" style="width:150px; margin-bottom:0;">
                     <label data-lang-key="toDate" style="width:auto; margin-bottom:0;">1419:</label>
                     <input type="date" id="purchaseReportToDate" style="width:150px; margin-bottom:0;">
                </div>
                <button id="downloadPurchasePdfBtn" data-lang-key="downloadAsPdf">PDF 141910 11101718181311 19161910</button>
                <button id="downloadPurchaseCsvBtn" data-lang-key="downloadAsCsv">CSV 141910 11101718181311 19161910</button>
            </div>
             <div class="report-section">
                <h5 data-lang-key="stockReportTitle">1415191119 16111013161519</h5>
                <p data-lang-key="stockReportDesc" style="border:none; margin-bottom:15px; text-align:left;">11161514141018 141910 171018121517 141312 1714151010161310 1912 14141412 11101718181311 1916191018</p>
                <button id="downloadStockReportPdfBtn" data-lang-key="downloadAsPdf">PDF 141910 11101718181311 19161910</button>
                 <button id="downloadStockReportCsvBtn" data-lang-key="downloadAsCsv">CSV 141910 11101718181311 19161910</button>
            </div>
             <div class="report-section">
                <h5 data-lang-key="customerListTitle">111516101519 14141412 16111013161519</h5>
                <p data-lang-key="customerListDesc" style="border:none; margin-bottom:15px; text-align:left;">13101819 141312 10101612191514 1115161015191310 1912 14141412 11101718181311 1916191018</p>
                <button id="downloadCustomersPdfBtn" data-lang-key="downloadAsPdf">PDF 141910 11101718181311 19161910</button>
                 <button id="downloadCustomersCsvBtn" data-lang-key="downloadAsCsv">CSV 141910 11101718181311 19161910</button>
            </div>
        </div>

        <div id="backup-tab" class="tab-content">
            <h4 data-lang-key="backupRestoreTitle">1210191310 1816 16111415191316</h4>
            <div class="backup-container">
                <p data-lang-key="backupInstructions">13101819 141312 11191910 (171415101016, 111516101519, 121118 141611) 1913 1319 1118101518 1919 161410 141910 11101718181311 19161819 1919 181113 '1210191310 1218101310' 1016 1915181119 1916191018 1514 1118101518 1913 1413161915131114 1610191018 11191910 11101014 10101819 1919 181113 '1210191310 1419 16111415191316 19161910' 1910 1710151311 1916191018</p>
                <button id="createBackupBtn" data-lang-key="createBackup">1210191310 1218101310</button>
                <button id="restoreBackupBtn" style="background-color: #27ae60;" data-lang-key="restoreBackup">1210191310 1419 16111415191316 19161910</button>
                <input type="file" id="restoreFileInput" class="hidden" accept=".json">
            </div>
        </div>

        <!-- Profile Sidebar -->
        <div id="sidebar-overlay" class="hidden"></div>
        <div id="profile-sidebar" class="sidebar">
            <button id="closeProfileSidebarBtn" class="close-sidebar-btn">×</button>
            <div class="profile-layout" style="grid-template-columns: 1fr; gap: 30px;">
                <div>
                    <h4 data-lang-key="shopDetails">1613191018 1910 1111111613</h4>
                    <label data-lang-key="shopNameLabel">1613191018 1910 181014:</label><input type="text" id="profileShopName">
                    <label data-lang-key="shopAddressLabel">1613191018 1910 101410:</label><textarea id="profileAddress" rows="3"></textarea>
                    <label data-lang-key="phoneNumLabel">11181318 18101216:</label><input type="tel" id="profilePhone">
                    <label data-lang-key="emailIdLabel">16141918 14161112:</label><input type="email" id="profileEmail" readonly>
                    <label data-lang-key="gstinLabel">161213141912 18101216:</label><input type="text" id="profileGstin">
                </div>
                <div>
                    <h4 data-lang-key="paymentAndLogo">131311141018 1816 18131113</h4>
                    <label>UPI ID:</label><input type="text" id="profileUpiId" placeholder="yourname@bank" data-lang-key="upiPlaceholder">
                    <div class="profile-image-upload">
                        <label data-lang-key="shopLogoLabel">1613191018 1910 18131113:</label>
                        <input type="file" class="image-upload-input" id="logoUpload" data-target="logo" accept="image/jpeg,image/png">
                        <img id="logoPreview" src="" alt="Logo Preview">
                    </div>
                     <div class="profile-image-upload">
                        <label data-lang-key="signature">151415141019151316:</label>
                        <input type="file" class="image-upload-input" id="signatureUpload" data-target="signature" accept="image/jpeg,image/png">
                        <img id="signaturePreview" src="" alt="Signature Preview">
                    </div>
                     <div class="profile-image-upload">
                        <label data-lang-key="stamp">14151910141510:</label>
                        <input type="file" class="image-upload-input" id="stampUpload" data-target="stamp" accept="image/jpeg,image/png">
                        <img id="stampPreview" src="" alt="Stamp Preview">
                    </div>
                </div>
            </div>
            <div>
                <h4 data-lang-key="settingsTitle">1419191110111514</h4>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                    <label for="theme-toggle-sidebar" style="margin-bottom: 0;" data-lang-key="darkModeLabel">1110161519 141311</label>
                    <div class="theme-switch-wrapper" style="margin-left: 0;">
                        <label class="theme-switch" for="theme-toggle-sidebar">
                            <input type="checkbox" id="theme-toggle-sidebar">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <button id="saveProfileBtn" style="margin-top:20px;" data-lang-key="saveProfile">101516131118101518 141911 19161910</button>
            <button id="logoutBtnSidebar" style="margin-top:10px; background-color: #e74c3c;" data-lang-key="logout">181111141719</button>
        </div>
    </div>
    
    <!-- 121118 14131118 -->
    <div id="bill-modal" class="modal"><div class="modal-content"><div class="printable-area" id="bill-to-print-container"></div>
        <div id="ad-placeholder-in-modal" style="text-align:center; margin: 15px 0;"></div>
    <div class="modal-buttons no-print" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        <button id="sendWhatsAppBtn" title="WhatsApp 1016 1319161910" style="background-color:#25D366; padding: 8px; line-height: 1; width:auto;">
            <svg fill="white" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.523.074-.797.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.203 5.076 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
        </button>
        <button id="shareBillImageBtn" style="background-color:#f39c12; width:auto;" data-lang-key="shareAsImage">15141916 12191516 19161910</button>
        <button id="printBillBtn" style="background-color:#27ae60; width:auto;" data-lang-key="printBill">121118 101516111019 19161910</button>
        <button id="closeBillModalBtn" style="background-color:#e74c3c; width:auto;" data-lang-key="close">121016 19161910</button>
    </div></div></div>
    <div id="history-modal" class="modal"><div class="modal-content" style="max-width:800px;"><h3 id="history-modal-title">151411151014</h3><div id="historyContainer" style="max-height: 500px; overflow-y: auto;"></div><button id="closeHistoryModalBtn" style="margin-top:20px; background-color:#e74c3c;" data-lang-key="close">121016 19161910</button></div></div>
    
    <!-- 101516111019 1015161211151514 14131118 -->
    <div id="print-preview-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h4 data-lang-key="printPreviewTitle">101516111019 1015161211151514</h4>
            <div class="print-options">
                <strong data-lang-key="paperSize">10191016 14101516:</strong>
                <label><input type="radio" name="paper-size" value="a4" checked> A4</label>
                <label><input type="radio" name="paper-size" value="80mm"> 80mm</label>
                <label><input type="radio" name="paper-size" value="58mm"> 58mm</label>
            </div>
            <div id="print-preview-content" class="preview-a4"></div>
            <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                <button id="execute-print-btn" data-lang-key="printNow" style="width: auto;">131312 101516111019 19161910</button>
                <button id="close-print-preview-btn" style="background-color:#e74c3c; width: auto;" data-lang-key="cancel">16161516 19161910</button>
            </div>
        </div>
    </div>

    <!-- 18131113 1915161110 14131118 -->
    <div id="cropper-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h4 data-lang-key="cropImageTitle">18131113 1915161110 19161910</h4>
            <div>
                <img id="image-to-crop" src="" style="max-width: 100%;">
            </div>
            <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                <button id="crop-and-save-btn" data-lang-key="cropBtn" style="width: auto;">1915161110 19161910 1816 141911 19161910</button>
                <button id="close-cropper-modal-btn" style="background-color:#e74c3c; width: auto;" data-lang-key="cancel">16161516 19161910</button>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 20px; font-family: 'Segoe UI', sans-serif; color: var(--text-color);">
        Powered by Upendra K Chaudhary
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 131813111016 1512151619191519 ---
    const translations = {
        'hi': {
            login: "1811111118 19161910", createAccount: "181510 131910171019 1218101310", back: "← 11101014", shopNameLabel: "1613191018 1910 181014:", emailLabel: "16141918:", 
            mobileLabel: "141312101518:", passwordLabel: "10101411161511:", signUp: "14101518 1310", emailOrMobileLabel: "16141918 1510 141312101518:", logout: "181111141719", 
            dashboardTab: "1110121213161511", sellTab: "121119151612", purchaseTab: "10161216", inventoryTab: "151815111910191612", expensesTab: "1016151419", 
            customersTab: "111516101519", suppliersTab: "141014161514111916151410", profileTab: "101516131118101518", backupRestoreTab: "1210191310/16111415191316",
            reportsTab: "161110131615191514", estimateTab: "1314151912141919", customerDetails: "111516101519 1910 1111111613", customerName: "111516101519 1910 181014:", 
            customerPhone: "111516101519 1910 11181318:", customerAddress: "111516101519 1910 101410:", addItem: "14151914 161311181910", addProductLabel: "171415101016 1013161910:", 
            quantity: "141014151610:", addToBill: "121118 141910 161311181910", currentBill: "11161514141018 121118", productColumn: "171415101016/141615111114", 
            quantityColumn: "141014151610", priceColumn: "1414181515", totalColumn: "191318", rateColumn: "1616", subTotal: "1710-151311 (Subtotal):", 
            discount: "111114151910171019:", gst: "GST", grandTotal: "191318 151311:", generateBill: "121118 1218101310", productName: "171415101016 1910 181014:",
            priceLabel: "121119151612 1414181515/1514181119", unitLabel: "15191016:", currentStock: "11161514141018 1415191119", inStock: "1415191119 141910", 
            printStock: "1415191119 101516111019 19161910", saveAsPdf: "PDF 141910 141911 19161910", customerList: "1115161015191310 1912 14141412", nameColumn: "181014", 
            phoneColumn: "11181318", actionColumn: "1319151218", historyBtn: "151411151014", shopDetails: "1613191018 1910 1111111613", 
            shopAddressLabel: "1613191018 1910 101410:", phoneNumLabel: "11181318 18101216:", emailIdLabel: "16141918 14161112:", paymentAndLogo: "131311141018 1816 18131113", 
            upiPlaceholder: "yourname@bank", shopLogoLabel: "1613191018 1910 18131113:", saveProfile: "101516131118101518 141911 19161910", 
            sendOnWhatsApp: "WhatsApp 1016 1319161910", printBill: "121118 101516111019 19161910", shareAsImage: "15141916 12191516 19161910", close: "121016 19161910",
            invalidCredentials: "131410181515 1610181910161218 1915101510 10131811 101516151014 1916191018", emailExists: "1515 16141918 14161112 10151819 1419 10101612191514 151018", 
            signupSuccess: "14101518 1310 141118! 1312 1410 1811111118 1916 14191419 15101018", fillAllFields: "1915101510 141312 141112151519 111812181511 1316191018", 
            productAddedSuccess: "171415101016 1411181410101416151119 1613111810 111510!", productUpdatedSuccess: "171415101016 1411181410101416151119 1310111919 19111510 111510!",
            selectProductFromList: "1915101510 14141412 1419 1319 171415101016 141318191018", 
            stockUnavailable: "1415191119 141910 19191118 {quantity} {unit} 171018121517 1510!", addItemsToBill: "121118 1218101819 1919 181113 14151914 16131118191018", 
            customerInfoRequired: "121118 1218101819 1919 181113 111516101519 1910 181014 1816 11181318 18101216 141112151519 151018", profileSaved: "101516131118101518 1411181410101416151119 141911 1513 111510!", 
            noBillToShare: "12191516 19161819 1919 181113 191316 121118 18151210 151018", preparing: "1410151016 1513 161510 1510...", imageCreationFailed: "15141916 1218101819 141910 141516131911 15131618",
            imageDownloaded: "121118 1912 15141916 11101718181311 1513 1116 151018 1915101510 151419 1410181515131318 161410 1419 14101710 1916191018", noPurchaseHistory: "1514 141014161514111916151410 1919 181113 191316 10161216 151411151014 18151210 1411181018", 
            noSalesHistory: "1514 111516101519 1919 181113 191316 121119151612 151411151014 18151210 1411181018", billNo: "121118 1810:", date: "1410161210:", total: "191318:", 
            viewBill: "121118 1619101910", stockReport: "1415191119 16111013161519", customer: "111516101519:", name: "181014:", mobile: "141312101518:", 
            subTotalBill: "1710-151311:", discountBill: "111114151910171019:", grandTotalBill: "191318 161915:", scanToPay: "131311141018 1919 181113 1415191018 19161910",
            visitAgain: "Visit Again!", thanksForShopping: "10161216101612 1919 181113 17181515111016!", editBtn: "13111119", deleteBtn: "1111181219", 
            updateBtn: "1310111919", deleteConfirm: "19151510 1410 11101916 151419 1519101810 1410151419 151010?", backupRestoreTitle: "1210191310 1816 16111415191316",
            backupInstructions: "13101819 141312 11191910 1913 1319 1118101518 1919 161410 141910 11101718181311 19161819 1919 181113 '1210191310 1218101310' 1016 1915181119 1916191018 11191910 11101014 10101819 1919 181113 '1210191310 1419 16111415191316 19161910' 1910 1710151311 1916191018",
            createBackup: "1210191310 1218101310", restoreBackup: "1210191310 1419 16111415191316 19161910", restoreConfirm: "19151510 1410 11101916 11191910 16111415191316 19161810 1410151419 151010? 1515 14101919 11161514141018 11191910 1913 121618 1619111018",
            backupSuccess: "1210191310 1118101518 1411181410101416151119 1218 1116 151018", restoreSuccess: "11191910 1411181410101416151119 16111415191316 1513 111510 151018", invalidBackupFile: "131410181515 1210191310 111810151818",
            topSellingProducts: "14121419 161515101610 1211191819 11101819 171415101016", quantitySold: "12111912 151316 141014151610", totalExpenses: "191318 10161514", 
            downloadReportsTitle: "161110131615191514 11101718181311 19161910", salesReportTitle: "121119151612 16111013161519", stockReportTitle: "1415191119 16111013161519", 
            customerListTitle: "111516101519 14141412 16111013161519", salesReportDesc: "1319 14111511 14121410 1919 13121416 141312 1211181310 1912 11111415141514 14141412 11101718181311 1916191018", 
            stockReportDesc: "11161514141018 141910 171018121517 141312 1714151010161310 1912 14141412 11101718181311 1916191018", customerListDesc: "13101819 141312 10101612191514 1115161015191310 1912 14141412 11101718181311 1916191018",
            fromDate: "1419:", toDate: "1419:", downloadAsPdf: "PDF 141910 11101718181311 19161910", downloadAsCsv: "CSV 141910 11101718181311 19161910",
            noDataFound: "1415181114 14121410 1919 181113 191316 11191910 18151210 1411181018", forgotPassword: "10101411161511 131418 1113?", resetPasswordTitle: "10101411161511 1612141919 19161910",
            verifyEmail: "16141918 1414151510101114 19161910", enterRegisteredEmail: "13101810 10101612191514 16141918 16161516 1916191018", 
            enterRegisteredMobile: "1015141018 1414151510101114 19161819 1919 181113 13101810 10101612191514 141312101518 18101216 16161516 1916191018", newPassword: "181510 10101411161511", 
            confirmPassword: "10101411161511 1912 101313151911 19161910", resetPasswordBtnText: "10101411161511 1612141919 19161910", emailNotFound: "1515 16141918 10101612191514 18151210 151018",
            verificationFailed: "141312101518 18101216 141918 18151210 1010141018", passwordsDoNotMatch: "10101411161511 141918 18151210 1010141918", 
            passwordResetSuccess: "10101411161511 1411181410101416151119 1612141919 1513 111510! 1312 1410 1811111118 1916 14191419 15101018", addSupplier: "181510 141014161514111916151410 161311181910",
            supplierName: "141014161514111916151410 1910 181014:", supplierPhone: "141014161514111916151410 1910 11181318:", supplierAddress: "141014161514111916151410 1910 101410:", 
            addSupplierBtn: "141014161514111916151410 161311181910", supplierList: "1410141615141119161514101710 1912 14141412", viewPurchasesBtn: "10161216 1619101910", 
            confirmDeleteSupplier: "19151510 1410 11101916 1514 141014161514111916151410 1913 1519101810 1410151419 151010?", purchaseEntryTitle: "1816 10161216 101516111113151911",
            addProductToPurchase: "10161216 141910 171415101016 161311181910", purchasePrice: "10161216 1414181515/1514181119", addToPurchaseAndInventory: "10161216 16111911161511 19161910 1816 1415191119 141910 161311181910",
            purchaseHistoryTitle: "141014161514111916151410 1910 10161216 151411151014", purchaseDate: "10161216 1912 1410161210", purchaseItems: "1016121619 1113 14151914",
            noPurchaseEntries: "1514 141014161514111916151410 1919 181113 191316 10161216 101516111113151911 18151210 151018", gstinLabel: "GST 18101216:", gstinBill: "161213141912 18101216:",
            addCustomer: "181510 111516101519 161311181910", addCustomerBtn: "111516101519 161311181910", customerAddedSuccess: "111516101519 1411181410101416151119 1613111810 111510!",
            cropImageTitle: "15141916 1915161110 19161910", cropBtn: "1915161110 19161910 1816 141911 19161910", cancel: "16161516 19161910", supplierDetails: "141014161514111916151410 1111111613",
            basePrice: "121914 101516101514/1514181119 (64)", gstPercent: "GST (%):", recentPurchases: "151018 1912 10161216",
            selectSupplierToViewHistory: "141014161514111916151410 1912 141312 10161216 1619101819 1919 181113 '141014161514111916151410' 191012 1016 1610131018",
            addExpenseTitle: "181510 10161514 161311181910", expenseDescription: "10161514 1910 1111111613:", expenseAmount: "16101211 (64):",
            expenseDate: "10161514 1912 1410161210:", addExpenseBtn: "10161514 161311181910", expenseListTitle: "101615141310 1912 14141412",
            descriptionColumn: "1111111613", amountColumn: "16101211", dateColumn: "1410161210", expenseAddedSuccess: "10161514 1411181410101416151119 1613111810 11151018",

            printPreviewTitle: "101516111019 1015161211151514", paperSize: "10191016 14101516:", printNow: "131312 101516111019 19161910", totalSales: "191318 121119151612",
            totalPurchases: "191318 10161216", profitAndLoss: "181013 1816 15101811", product: "171415101016", service: "141615111114", serviceDescription: "141615111114 1111111613:",
            serviceCharge: "141615111114 1410161516 (64):", withoutGst: "12111810 GST", withGst: "GST 14151114", printPurchaseNote: "10161216 181319 101516111019 19161910",
            signature: "151415141019151316:", stamp: "14151910141510:", authorizedSignatory: "131711191514 1514151410191513161916151410", purchaseReportTitle: "10161216 16111013161519",
            purchaseReportDesc: "1319 14111511 14121410 1919 13121416 141312 10161216 1912 11111415141514 14141412 11101718181311 1916191018", supplierAddressLabel: "141014161514111916151410 1910 101410:",
            purchaseId: "10161216 14161112", totalPrice: "191318 1414181515/15191016 (64):", lineTotal: "191318:", sellingPriceLabel: "121119151612 1414181515/1514181119 (64)",
            totalGst: "191318 GST:", purchaseBillNo: "10161216 121118 18101216:", settingsTitle: "1419191110111514", darkModeLabel: "1110161519 141311",
            purchaseBillDate: "121118 1912 1410161210:", hsnSac: "HSN/SAC:", purchasePriceDetails: "10161216 1414181515 1111111613",
            totalPurchasePrice: "191318 10161216 1414181515/1514181119 (64)", sellingPriceDetails: "121119151612 1414181515 1111111613", profitMargin: "14101615161118", margin: "14101615161118",
            cashFlowTab: "191012 11151813", addCashFlowTitle: "1816 191012 131019151612", transactionType: "181918-161918 101516191016", cashIn: "191012-1518 (161410)",
            cashOut: "191012-141719 (181119101412)", associatedParty: "14101210171114 101016151912 (111516101519/141014161514111916151410)", notes: "1813191514 (1111111613)",
            addEntry: "131019151612 161311181910", cashFlowSummary: "191012 11151813 141016101012", totalCashIn: "191318 161410", totalCashOut: "191318 181119101412",
            netBalance: "181919 121018191014", cashFlowHistory: "191012 11151813 151411151014", confirmDeleteCustomer: "19151510 1410 11101916 1514 111516101519 1913 1519101810 1410151419 151010?",
            confirmDeleteBill: "19151510 1410 11101916 1514 121118 1913 1519101810 1410151419 151010? 1515 191516111510 1415191119 1913 11101014 16131118 1619111218",
            confirmDeletePurchase: "19151510 1410 11101916 1514 10161216 1913 1519101810 1410151419 151010? 1515 191516111510 1415191119 1913 1414101513161114 1916 1619111218",
            cashFlowLedger: "191012 11151813 18191616", paymentMode: "131311141018 1910 1416121910", online: "151818101518", check: "141919", qr: "QR", cash: "181916",
            recentSales: "151018 1912 121119151612", stockItemUpdated: "1415191119 14151914 1411181410101416151119 1310111919 19111510 111510!", debit: "1119121119 (Debit)", credit: "19151619111119 (Credit)",
            balance: "121018191014", receivable: "1219101510 (Receivable)", payable: "161915 (Payable)", addPayment: "131311141018 161311181910",
            paymentReceived: "131311141018 10151610101514 151314", paymentMade: "131311141018 19111510 111510", sendReminder: "1611141015101116 1319161910", 
            reminderMessage: "1015161115 {customerName},\n14101919 10101419 1910 191318 1219101510 64{balance} 151018 1915101510 16181516 1419 16181516 131311141018 1916191018\n17181515111016,\n{shopName}",
            currentEstimate: "11161514141018 1314151912141919", addToEstimate: "1314151912141919 141910 161311181910", generateEstimate: "1314151912141919 1218101310",
            estimateNo: "1314151912141919 1810:", estimateDate: "1314151912141919 1410161210:",
            totalStockValuePurchase: "191318 1415191119 1414181515 (10161216)", totalStockValueSale: "191318 1415191119 1414181515 (121119151612)",
            purchaseValue: "191318 10161216 1414181515", saleValue: "191318 121119151612 1414181515", totalStock: "191318 151311"
        },
        'en': {
            login: "Login", createAccount: "Create New Account", back: "← Back", shopNameLabel: "Shop Name:", emailLabel: "Email:",
            mobileLabel: "Mobile:", passwordLabel: "Password:", signUp: "Sign Up", emailOrMobileLabel: "Email or Mobile:", logout: "Logout",
            dashboardTab: "Dashboard", sellTab: "Sell", purchaseTab: "Purchase", inventoryTab: "Inventory", expensesTab: "Expenses",
            customersTab: "Customers", suppliersTab: "Suppliers", profileTab: "Profile", backupRestoreTab: "Backup/Restore",
            reportsTab: "Reports", estimateTab: "Estimate", customerDetails: "Customer Details", customerName: "Customer Name:",
            customerPhone: "Customer Phone:", customerAddress: "Customer Address:", addItem: "Add Item", addProductLabel: "Search Product:",
            quantity: "Quantity:", addToBill: "Add to Bill", currentBill: "Current Bill", productColumn: "Product/Service",
            quantityColumn: "Qty", priceColumn: "Price", totalColumn: "Total", rateColumn: "Rate", subTotal: "Subtotal:",
            discount: "Discount:", gst: "GST", grandTotal: "Grand Total:", generateBill: "Generate Bill", productName: "Product Name:",
            priceLabel: "Selling Price/Unit", unitLabel: "Unit:", currentStock: "Current Stock", inStock: "In Stock",
            printStock: "Print Stock", saveAsPdf: "Save as PDF", customerList: "Customer List", nameColumn: "Name",
            phoneColumn: "Phone", actionColumn: "Action", historyBtn: "History", shopDetails: "Shop Details", shopAddressLabel: "Shop Address:",
            phoneNumLabel: "Phone Number:", emailIdLabel: "Email ID:", paymentAndLogo: "Payment & Logo", upiPlaceholder: "yourname@bank",
            shopLogoLabel: "Shop Logo:", saveProfile: "Save Profile", sendOnWhatsApp: "Send on WhatsApp", printBill: "Print Bill",
            shareAsImage: "Share as Image", close: "Close", invalidCredentials: "Invalid credentials.", emailExists: "This email ID is already registered.",
            signupSuccess: "Sign up successful!", fillAllFields: "Please enter correct information in all fields.", productAddedSuccess: "Product added successfully!",
            productUpdatedSuccess: "Product updated successfully!", selectProductFromList: "Please select a product from the list.",
            stockUnavailable: "Only {quantity} {unit} available in stock!", addItemsToBill: "Add items to create a bill.",
            customerInfoRequired: "Customer name and phone number are required to generate a bill.", profileSaved: "Profile saved!",
            noBillToShare: "No bill to share.", preparing: "Preparing...", imageCreationFailed: "Error creating image.",
            imageDownloaded: "Bill image has been downloaded. Please share it manually.", noPurchaseHistory: "No purchase history found for this supplier.",
            noSalesHistory: "No sales history found for this customer.", billNo: "Bill No:", date: "Date:", total: "Total:",
            viewBill: "View Bill", stockReport: "Stock Report", customer: "Customer:", name: "Name:", mobile: "Mobile:",
            subTotalBill: "Subtotal:", discountBill: "Discount:", grandTotalBill: "Grand Total:", scanToPay: "Scan to Pay",
            visitAgain: "Visit Again!", thanksForShopping: "Thanks for shopping!", editBtn: "Edit", deleteBtn: "Delete",
            updateBtn: "Update", deleteConfirm: "Are you sure you want to delete this item?", backupRestoreTitle: "Backup & Restore",
            backupInstructions: "Click 'Create Backup' to download all your data. Use 'Restore from Backup' to recover your data.",
            createBackup: "Create Backup", restoreBackup: "Restore from Backup", restoreConfirm: "Are you sure you want to restore? This will overwrite all current data.",
            backupSuccess: "Backup file created successfully.", restoreSuccess: "Data restored successfully.", invalidBackupFile: "Invalid backup file.",
            topSellingProducts: "Top Selling Products", quantitySold: "Quantity Sold", totalExpenses: "Total Expenses",
            downloadReportsTitle: "Download Reports", salesReportTitle: "Sales Report", stockReportTitle: "Stock Report", customerListTitle: "Customer List Report",
            salesReportDesc: "Download a detailed list of all bills within a date range.", stockReportDesc: "Download a list of all products currently in stock.",
            customerListDesc: "Download a list of all your registered customers.", fromDate: "From:", toDate: "To:", downloadAsPdf: "Download as PDF",
            downloadAsCsv: "Download as CSV", noDataFound: "No data found for the selected range.", forgotPassword: "Forgot Password?",
            resetPasswordTitle: "Reset Password", verifyEmail: "Verify Email", enterRegisteredEmail: "Enter your registered email.",
            enterRegisteredMobile: "Enter your registered mobile number to verify.", newPassword: "New Password", confirmPassword: "Confirm Password",
            resetPasswordBtnText: "Reset Password", emailNotFound: "This email is not registered.", verificationFailed: "Mobile number does not match.",
            passwordsDoNotMatch: "Passwords do not match.", passwordResetSuccess: "Password reset successfully! You can now log in.",
            addSupplier: "Add New Supplier", supplierName: "Supplier Name:", supplierPhone: "Supplier Phone:", supplierAddress: "Supplier Address:",
            addSupplierBtn: "Add Supplier", supplierList: "Supplier List", viewPurchasesBtn: "View Purchases",
            confirmDeleteSupplier: "Are you sure you want to delete this supplier?", purchaseEntryTitle: "New Purchase Entry",
            addProductToPurchase: "Add Product to Purchase", purchasePrice: "Purchase Price/Unit", addToPurchaseAndInventory: "Record Purchase & Add to Stock",
            purchaseHistoryTitle: "Purchase History of Supplier", purchaseDate: "Purchase Date", purchaseItems: "Purchased Items",
            noPurchaseEntries: "No purchase entries for this supplier.", gstinLabel: "GST Number:", gstinBill: "GSTIN:",
            addCustomer: "Add New Customer", addCustomerBtn: "Add Customer", customerAddedSuccess: "Customer added successfully!",
            cropImageTitle: "Crop Image", cropBtn: "Crop & Save", cancel: "Cancel", supplierDetails: "Supplier Details",
            basePrice: "Base Price/Unit (64)", gstPercent: "GST (%):", recentPurchases: "Recent Purchases",
            selectSupplierToViewHistory: "Go to the 'Suppliers' tab to see all purchases for a supplier.", addExpenseTitle: "Add New Expense",
            expenseDescription: "Expense Description:", expenseAmount: "Amount (64):", expenseDate: "Expense Date:", addExpenseBtn: "Add Expense",
            expenseListTitle: "Expense List", descriptionColumn: "Description", amountColumn: "Amount", dateColumn: "Date",
            expenseAddedSuccess: "Expense added successfully.", printPreviewTitle: "Print Preview", paperSize: "Paper Size:",
            printNow: "Print Now", totalSales: "Total Sales", totalPurchases: "Total Purchases", profitAndLoss: "Profit & Loss",
            product: "Product", service: "Service", serviceDescription: "Service Description:", serviceCharge: "Service Charge (64):",
            withoutGst: "Without GST", withGst: "With GST", printPurchaseNote: "Print Purchase Note", signature: "Signature:",
            stamp: "Stamp:", authorizedSignatory: "Authorized Signatory", purchaseReportTitle: "Purchase Report",
            purchaseReportDesc: "Download a detailed list of all purchases within a date range.", supplierAddressLabel: "Supplier Address:",
            purchaseId: "Purchase ID", totalPrice: "Total Price/Unit (64):", lineTotal: "Total:", sellingPriceLabel: "Selling Price/Unit (64)",
            totalGst: "Total GST:", purchaseBillNo: "Purchase Bill No:", settingsTitle: "Settings", darkModeLabel: "Dark Mode",
            purchaseBillDate: "Bill Date:", hsnSac: "HSN/SAC:", purchasePriceDetails: "Purchase Price Details",
            totalPurchasePrice: "Total Purchase Price/Unit (64)", sellingPriceDetails: "Selling Price Details", profitMargin: "Margin",
            margin: "Margin", cashFlowTab: "Cash Flow", addCashFlowTitle: "New Cash Entry", transactionType: "Transaction Type",
            cashIn: "Cash-In", cashOut: "Cash-Out", associatedParty: "Associated Party (Customer/Supplier)", notes: "Notes (Description)",
            addEntry: "Add Entry", cashFlowSummary: "Cash Flow Summary", totalCashIn: "Total Cash-In", totalCashOut: "Total Cash-Out",
            netBalance: "Net Balance", cashFlowHistory: "Cash Flow History", confirmDeleteCustomer: "Are you sure you want to delete this customer?",
            confirmDeleteBill: "Are you sure you want to delete this bill? This action will restore the stock.",
            confirmDeletePurchase: "Are you sure you want to delete this purchase entry? This action will adjust the stock.",
            cashFlowLedger: "Cash Flow Ledger", paymentMode: "Payment Mode", online: "Online", check: "Check", qr: "QR", cash: "Cash",
            recentSales: "Recent Sales", stockItemUpdated: "Stock item updated successfully!", debit: "Debit", credit: "Credit",
            balance: "Balance", receivable: "Receivable", payable: "Payable", addPayment: "Add Payment",
            paymentReceived: "Payment Received", paymentMade: "Payment Made", sendReminder: "Send Reminder",
            reminderMessage: "Dear {customerName},\nThis is a friendly reminder regarding your outstanding balance of 64{balance}.\nPlease clear the dues at the earliest.\nThank you,\n{shopName}",
            currentEstimate: "Current Estimate", addToEstimate: "Add to Estimate", generateEstimate: "Generate Estimate",
            estimateNo: "Estimate No:", estimateDate: "Estimate Date:",
            totalStockValuePurchase: "Total Stock Value (Purchase)", totalStockValueSale: "Total Stock Value (Sale)",
            purchaseValue: "Total Purchase Value", saleValue: "Total Sale Value", totalStock: "Total"
        }
    };
    
    // --- 111518131218 111916111312181514 ---
    let allRetailerData = {}, currentUserEmail = null, currentBillItems = [], billCounter = 1, productForCalculator = null, currentLanguage = 'hi', editingInventoryItemId = null, currentBillForModal = null, editingSupplierId = null, editingCustomerId = null, editingBillId = null, editingPurchaseId = null, editingCashFlowId = null, lastActiveTab = 'dashboard';
    let cropper, currentCropTarget;
    let salesChart, purchaseChart, profitLossChart;
    let currentEstimateItems = [], estimateCounter = 1;
    const app = {}; window.app = app;
    const appLink = "https://billing-app-nu.vercel.app/";
    
    // --- 13101310 111019151218 ---
    const setLanguage = (lang) => {
        if (!translations[lang]) return;
        currentLanguage = lang;
        localStorage.setItem('appLanguage', lang);
        document.documentElement.lang = lang;
        document.documentElement.dir = 'ltr'; 
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            const translation = translations[lang][key];
            if (translation) {
                if (el.placeholder) { el.placeholder = translation; } 
                else if (el.tagName === 'SPAN' || el.tagName === 'BUTTON' || el.tagName === 'H2' || el.tagName === 'H4' || el.tagName === 'H5' || el.tagName === 'P' || el.tagName === 'LABEL' || el.tagName === 'TH' || el.tagName === 'A' || el.tagName === 'STRONG') {
                    el.innerText = translation;
                }
            }
        });
        document.getElementById('language-select').value = lang;
        if (currentUserEmail) { renderAllUI(); }
    };

    // --- 151918151016 1816 UI 111019151218 ---
    const saveData = () => { localStorage.setItem('allRetailerData', JSON.stringify(allRetailerData)); };
    const loadData = () => { allRetailerData = JSON.parse(localStorage.getItem('allRetailerData')) || {}; billCounter = parseInt(localStorage.getItem('billCounter')) || 1; estimateCounter = parseInt(localStorage.getItem('estimateCounter')) || 1; };
    const showPage = (pageName) => { 
        document.querySelectorAll('.container').forEach(p => p.classList.add('hidden')); 
        document.getElementById(pageName).classList.remove('hidden');
        if (pageName === 'reset-password-page') {
             document.getElementById('resetPasswordForm').reset();
             document.getElementById('newPasswordSection').classList.add('hidden');
             document.getElementById('resetEmail').disabled = false;
             document.getElementById('verifyEmailBtn').disabled = false;
        }
    };

    const closeProfileSidebar = () => {
        document.getElementById('profile-sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').classList.add('hidden');
        showTab(lastActiveTab);
    };

    const showTab = (tabName) => {
        if (tabName === 'profile') return;
        document.getElementById('profile-sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').classList.add('hidden');

        document.querySelectorAll('.tab-content, .tab-link').forEach(el => el.classList.remove('active'));
        
        const tabContent = document.getElementById(`${tabName}-tab`);
        const tabLink = document.querySelector(`.tab-link[data-tab='${tabName}']`);
        
        if(tabContent) tabContent.classList.add('active');
        if(tabLink) tabLink.classList.add('active');
        
        lastActiveTab = tabName;
        
        if (tabName === 'dashboard') renderDashboard();
        if (tabName === 'inventory') renderInventoryTable();
        if (tabName === 'reports') {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salesReportToDate').value = today;
            document.getElementById('purchaseReportToDate').value = today;
        } else if (tabName === 'purchase') {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseHistoryToDate').value = today;
            document.getElementById('purchaseBillDate').valueAsDate = new Date();
            renderPurchaseHistory(); 
        } else if (tabName === 'expenses') {
            document.getElementById('expenseDate').valueAsDate = new Date();
        } else if (tabName === 'cashflow') {
            renderCashFlow();
        } else if (tabName === 'sell') {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salesHistoryToDate').value = today;
            renderRecentSales();
        }
    };

    const calculateStockValues = () => {
        const inventory = allRetailerData[currentUserEmail]?.inventory || [];
        let totalPurchaseValue = 0;
        let totalSaleValue = 0;

        inventory.forEach(item => {
            totalPurchaseValue += (item.purchasePrice || 0) * item.quantity;
            totalSaleValue += (item.price || 0) * item.quantity;
        });

        return { totalPurchaseValue, totalSaleValue };
    };
    
    const renderDashboard = () => {
        const retailer = allRetailerData[currentUserEmail];
        if (!retailer) return;

        const bills = retailer.bills || [];
        const purchaseEntries = retailer.purchaseEntries || [];
        const expenses = retailer.expenses || [];
        
        const totalSales = bills.reduce((sum, bill) => sum + bill.total, 0);
        const totalPurchases = purchaseEntries.reduce((sum, entry) => sum + (entry.item.totalPrice * entry.item.quantity), 0);
        const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const totalBills = bills.length;
        
        const salesData = {};
        bills.forEach(bill => { bill.items.forEach(item => { if(item.type === 'product') { salesData[item.name] = (salesData[item.name] || 0) + item.quantity; } }); });
        const sortedProducts = Object.entries(salesData).sort((a, b) => b[1] - a[1]);

        document.getElementById('totalSalesDisplay').innerText = `64${totalSales.toFixed(2)}`;
        document.getElementById('totalPurchasesDisplay').innerText = `64${totalPurchases.toFixed(2)}`;
        document.getElementById('totalExpensesDisplay').innerText = `64${totalExpenses.toFixed(2)}`;
        document.getElementById('totalBillsDisplay').innerText = totalBills;
        
        const { totalPurchaseValue, totalSaleValue } = calculateStockValues();
        document.getElementById('totalStockValuePurchaseDisplay').innerText = `64${totalPurchaseValue.toFixed(2)}`;
        document.getElementById('totalStockValueSaleDisplay').innerText = `64${totalSaleValue.toFixed(2)}`;
        
        const topSellingTableBody = document.getElementById('topSellingTableBody');
        topSellingTableBody.innerHTML = sortedProducts.slice(0, 5).map(([name, quantity]) => `<tr><td>${name}</td><td>${quantity.toFixed(2)}</td></tr>`).join('');
        
        renderSalesChart(bills);
        renderPurchaseChart(purchaseEntries);
        renderProfitLossChart(totalSales, totalPurchases, totalExpenses);
    };

    const renderSalesChart = (bills) => {
        const labels = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString(currentLanguage, {month: 'short'}));
        const data = new Array(12).fill(0);

        bills.forEach(bill => {
            const [d, m, y] = bill.date.split('-');
            const month = parseInt(m, 10) - 1;
            if(month >= 0 && month < 12 && new Date().getFullYear() == y) data[month] += bill.total;
        });

        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ 
                    label: translations[currentLanguage].totalSales, 
                    data: data, 
                    borderColor: 'rgba(39, 174, 96, 1)',
                    backgroundColor: 'rgba(39, 174, 96, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    };
    
    const renderPurchaseChart = (purchases) => {
        const labels = Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString(currentLanguage, {month: 'short'}));
        const data = new Array(12).fill(0);

        purchases.forEach(p => {
            const purchaseDate = new Date(p.date);
            const month = purchaseDate.getMonth();
            if(month >= 0 && month < 12 && purchaseDate.getFullYear() == new Date().getFullYear()) {
                data[month] += (p.item.totalPrice * p.item.quantity);
            }
        });

        const ctx = document.getElementById('purchaseChart').getContext('2d');
        if (purchaseChart) purchaseChart.destroy();
        purchaseChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ 
                    label: translations[currentLanguage].totalPurchases, 
                    data: data, 
                    backgroundColor: 'rgba(231, 76, 60, 0.7)', 
                    borderColor: 'rgba(231, 76, 60, 1)', 
                    borderWidth: 1 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    };

    const renderProfitLossChart = (totalSales, totalPurchases, totalExpenses) => {
        const cogs = totalPurchases;
        let netProfit = totalSales - cogs - totalExpenses;
        let data, labels, colors;

        if (netProfit < 0) {
            data = [totalSales, Math.abs(netProfit)];
            labels = ['191318 121119151612', '191318 15101811'];
            colors = ['rgba(74, 144, 226, 0.8)', 'rgba(217, 30, 24, 0.8)'];
        } else {
            data = [cogs, totalExpenses, netProfit];
            labels = ['12191419 1113 141018 1912 18101114', '10161114101818 11151515', '1213161517 181013'];
            colors = ['rgba(243, 156, 18, 0.8)', 'rgba(231, 76, 60, 0.8)', 'rgba(39, 174, 96, 0.8)'];
        }
        
        const ctx = document.getElementById('profitLossChart').getContext('2d');
        if(profitLossChart) profitLossChart.destroy();
        profitLossChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{ data: data, backgroundColor: colors }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    };

    const renderAllUI = () => {
        if (!currentUserEmail || !allRetailerData[currentUserEmail]) return;
        const retailer = allRetailerData[currentUserEmail];
        document.getElementById('retailerShopName').innerText = retailer.shopDetails.name;
        renderInventoryTable();
        renderSupplierTable();
        renderProfile();
        renderCustomerTable();
        renderExpensesTable();
        updateCurrentBillDisplay();
        renderDashboard();
        renderPurchaseHistory();
        renderCashFlow();
        renderRecentSales();
    };
    const renderInventoryTable = () => {
        const retailerData = allRetailerData[currentUserEmail];
        if (!retailerData) return;
        let inventory = retailerData.inventory || [];
        const purchaseEntries = retailerData.purchaseEntries || [];
        const lang = translations[currentLanguage];

        // Get filter values
        const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase();
        const fromDateStr = document.getElementById('inventoryFromDate').value;
        const toDateStr = document.getElementById('inventoryToDate').value;
        
        // Apply text search filter
        if (searchTerm) {
            inventory = inventory.filter(item => item.name.toLowerCase().includes(searchTerm));
        }

        // Apply date filter
        if (fromDateStr && toDateStr) {
            const fromDate = new Date(fromDateStr);
            const toDate = new Date(toDateStr);
            toDate.setHours(23, 59, 59, 999);

            inventory = inventory.filter(item => {
                const latestPurchase = purchaseEntries
                    .filter(p => p.item.name.toLowerCase() === item.name.toLowerCase())
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                if (!latestPurchase) return false;
                
                const purchaseDate = new Date(latestPurchase.purchaseBillDate || latestPurchase.date);
                return purchaseDate >= fromDate && purchaseDate <= toDate;
            });
        }
        
        let totalPurchaseValue = 0;
        let totalSaleValue = 0;

        document.getElementById('stockTableBody').innerHTML = inventory.map(item => {
            const purchasePrice = item.purchasePrice || 0;
            const sellingPrice = item.price || 0;
            const itemPurchaseValue = purchasePrice * item.quantity;
            const itemSaleValue = sellingPrice * item.quantity;
            totalPurchaseValue += itemPurchaseValue;
            totalSaleValue += itemSaleValue;

            return `
            <tr>
                <td data-col-name="productColumn">${item.name}</td>
                <td data-col-name="inStock">${item.quantity} ${item.unit}</td>
                <td data-col-name="purchasePrice">64${purchasePrice.toFixed(2)}</td>
                <td data-col-name="priceLabel">64${sellingPrice.toFixed(2)}</td>
                <td data-col-name="purchaseValue">64${itemPurchaseValue.toFixed(2)}</td>
                <td data-col-name="saleValue">64${itemSaleValue.toFixed(2)}</td>
                <td data-col-name="actionColumn">
                    <button class="action-button edit" onclick="window.app.editStockItem(${item.id})">${lang.editBtn}</button>
                    <button class="action-button delete" onclick="window.app.deleteProduct(${item.id})">${lang.deleteBtn}</button>
                </td>
            </tr>`;
        }).join('');

        const footer = document.getElementById('stockTableFooter');
        if (inventory.length > 0) {
            footer.innerHTML = `
                <tr>
                    <th data-col-name="productColumn"></th>
                    <th data-col-name="inStock"></th>
                    <th data-col-name="purchasePrice"></th>
                    <th data-col-name="priceLabel" style="text-align:right;">${lang.totalStock}:</th>
                    <th data-col-name="purchaseValue">64${totalPurchaseValue.toFixed(2)}</th>
                    <th data-col-name="saleValue">64${totalSaleValue.toFixed(2)}</th>
                    <th data-col-name="actionColumn"></th>
                </tr>
            `;
        } else {
            footer.innerHTML = '';
        }

        // Apply column visibility
        document.querySelectorAll('.column-toggle').forEach(toggle => {
            const colIndex = toggle.dataset.col;
            const isVisible = toggle.checked;
            document.querySelectorAll(`#stockTable th:nth-child(${parseInt(colIndex) + 1}), #stockTable td:nth-child(${parseInt(colIndex) + 1}), #stockTable tfoot th:nth-child(${parseInt(colIndex) + 1})`).forEach(cell => {
                cell.style.display = isVisible ? '' : 'none';
            });
        });
    };


    const renderSupplierTable = () => {
        const suppliers = allRetailerData[currentUserEmail]?.suppliers || [];
        const lang = translations[currentLanguage];
        document.getElementById('supplierTableBody').innerHTML = suppliers.map(s => `
            <tr>
                <td>${s.name}</td>
                <td>${s.phone}</td>
                <td>
                    <button class="action-button view" onclick="window.app.showPurchaseHistoryForSupplier(${s.id})">${lang.historyBtn}</button>
                    <button class="action-button edit" onclick="window.app.editSupplier(${s.id})">${lang.editBtn}</button>
                    <button class="action-button delete" onclick="window.app.deleteSupplier(${s.id})">${lang.deleteBtn}</button>
                </td>
            </tr>`).join('');
    };

    const renderProfile = () => {
        const details = allRetailerData[currentUserEmail].shopDetails;
        document.getElementById('profileShopName').value = details.name; document.getElementById('profileAddress').value = details.address || '';
        document.getElementById('profilePhone').value = details.phone; document.getElementById('profileEmail').value = currentUserEmail;
        document.getElementById('profileGstin').value = details.gstin || '';
        document.getElementById('logoPreview').src = details.logo || 'https://via.placeholder.com/150'; 
        document.getElementById('signaturePreview').src = details.signature || 'https://via.placeholder.com/150x80';
        document.getElementById('stampPreview').src = details.stamp || 'https://via.placeholder.com/150x80';
        document.getElementById('profileUpiId').value = details.upiId || '';
    };

    const renderCustomerTable = () => {
        const customers = allRetailerData[currentUserEmail]?.customers || [];
        const lang = translations[currentLanguage];
        document.getElementById('customerTableBody').innerHTML = customers.map(c => `
            <tr>
                <td>${c.name}</td>
                <td>${c.phone}</td>
                <td>
                    <button class="action-button view" onclick="window.app.showSalesHistoryForCustomer(${c.id})">${lang.historyBtn}</button>
                    <button class="action-button edit" onclick="window.app.editCustomer(${c.id})">${lang.editBtn}</button>
                    <button class="action-button delete" onclick="window.app.deleteCustomer(${c.id})">${lang.deleteBtn}</button>
                </td>
            </tr>`).join('');
    };
    
    const updateCurrentBillDisplay = () => {
        let subTotal = 0;
        document.getElementById('currentBillBody').innerHTML = currentBillItems.map(item => { 
            subTotal += item.total; 
            return `<tr>
                        <td>${item.name}</td>
                        <td>${item.type === 'product' ? (item.quantity + ' ' + item.unit) : '-'}</td>
                        <td>64${item.price.toFixed(2)}</td>
                        <td>64${item.total.toFixed(2)}</td>
                    </tr>`; 
        }).join('');
        calculateFinalTotal();
    };

    const calculateFinalTotal = () => {
        const subTotal = currentBillItems.reduce((sum, item) => sum + (item.basePrice * item.quantity), 0);
        const totalGst = currentBillItems.reduce((sum, item) => sum + (item.gstAmount * item.quantity), 0);
        
        document.getElementById('subTotalDisplay').innerText = subTotal.toFixed(2);
        document.getElementById('totalGstDisplay').innerText = totalGst.toFixed(2);
        
        const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
        const discountType = document.getElementById('discountType').value;
        
        let discountAmount = (discountType === 'percent') ? (subTotal * discountValue) / 100 : discountValue;
        
        const finalTotal = subTotal + totalGst - discountAmount;
        document.getElementById('grandTotalDisplay').innerText = finalTotal.toFixed(2);
    };

    // --- 10151614101312191613 1816 1416101312191613 ---
    const logout = () => { sessionStorage.removeItem('loggedInUser'); currentUserEmail = null; showPage('welcome-page'); };
    const initializeApp = () => {
        loadData();
        const savedLang = localStorage.getItem('appLanguage') || 'hi';
        setLanguage(savedLang);
        currentUserEmail = sessionStorage.getItem('loggedInUser');
        if (currentUserEmail && allRetailerData[currentUserEmail]) {
            renderAllUI(); 
            showPage('main-app'); 
            showTab('dashboard');
        } else {
            logout();
        }
    };
    
    const downloadCsv = (filename, headers, data) => {
        const csvRows = [headers.join(','), ...data.map(row => row.map(val => `"${String(val ?? '').replace(/"/g, '""')}"`).join(','))];
        const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = filename;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
    };

    // --- 1511191019 1510101118161514 ---
    const handleLogin = (e) => {
        e.preventDefault();
        const identifier = document.getElementById('loginIdentifier').value.toLowerCase();
        const password = document.getElementById('loginPassword').value;
        const userEmail = Object.keys(allRetailerData).find(email => (email === identifier || allRetailerData[email].shopDetails.phone === identifier) && allRetailerData[email].password === password);
        if (userEmail) { sessionStorage.setItem('loggedInUser', userEmail); initializeApp(); } else { alert(translations[currentLanguage].invalidCredentials); }
    };

    const handleSignup = (e) => {
        e.preventDefault();
        const email = document.getElementById('signupEmail').value.toLowerCase();
        if (allRetailerData[email]) { alert(translations[currentLanguage].emailExists); return; }
        allRetailerData[email] = {
            password: document.getElementById('signupPassword').value,
            shopDetails: { name: document.getElementById('signupShopName').value, phone: document.getElementById('signupPhone').value, address: '', logo: '', upiId: '', gstin: '', signature:'', stamp:'' },
            inventory: [], customers: [], bills: [], suppliers: [], purchaseEntries: [], expenses: [], cashFlow: [], estimates: []
        };
        saveData(); alert(translations[currentLanguage].signupSuccess); e.target.reset(); showPage('login-page');
    };
    
    app.deleteProduct = (productId) => {
        if (confirm(translations[currentLanguage].deleteConfirm)) {
            const retailerData = allRetailerData[currentUserEmail];
            retailerData.inventory = retailerData.inventory.filter(p => p.id !== productId);
            saveData(); 
            renderAllUI();
        }
    };
    
    const handlePrintStock = () => {
        const printContent = document.getElementById('inventoryToPrint').innerHTML;
        const shopName = allRetailerData[currentUserEmail].shopDetails.name;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>${translations[currentLanguage].stockReport} - ${shopName}</title><style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;}.no-print{display:none;}</style></head><body><h1>${translations[currentLanguage].stockReport} - ${shopName}</h1>${printContent}</body></html>`);
        printWindow.document.close();
        printWindow.print();
    };

    const handleSaveStockPdf = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const shopName = allRetailerData[currentUserEmail].shopDetails.name;
        const lang = translations[currentLanguage];
        doc.text(`${lang.stockReport} - ${shopName}`, 14, 15);
        const { totalPurchaseValue, totalSaleValue } = calculateStockValues();
        const tableData = (allRetailerData[currentUserEmail].inventory || []).map(p => [
            p.name, 
            `${p.quantity} ${p.unit}`,
            `64${(p.purchasePrice || 0).toFixed(2)}`,
            `64${(p.price || 0).toFixed(2)}`,
            `64${((p.purchasePrice || 0) * p.quantity).toFixed(2)}`,
            `64${((p.price || 0) * p.quantity).toFixed(2)}`
        ]);
        tableData.push(['','','','', '','']); // Spacer
        tableData.push([
            { content: lang.totalStock, styles: { halign: 'right', fontStyle: 'bold' }, colSpan: 4 },
            { content: `64${totalPurchaseValue.toFixed(2)}`, styles: { fontStyle: 'bold' } },
            { content: `64${totalSaleValue.toFixed(2)}`, styles: { fontStyle: 'bold' } }
        ]);

        doc.autoTable({ 
            head: [[lang.productColumn, lang.inStock, lang.purchasePrice, lang.priceLabel, lang.purchaseValue, lang.saleValue]], 
            body: tableData, 
            startY: 20 
        });
        doc.save(`${lang.stockReport}-${Date.now()}.pdf`);
    };
    
    const handleSaveProfile = () => {
        const details = allRetailerData[currentUserEmail].shopDetails;
        Object.assign(details, { 
            name: document.getElementById('profileShopName').value, 
            address: document.getElementById('profileAddress').value, 
            phone: document.getElementById('profilePhone').value, 
            upiId: document.getElementById('profileUpiId').value.trim(),
            gstin: document.getElementById('profileGstin').value.trim(),
            logo: document.getElementById('logoPreview').src,
            signature: document.getElementById('signaturePreview').src,
            stamp: document.getElementById('stampPreview').src
        });
        saveData(); 
        alert(translations[currentLanguage].profileSaved); 
        renderAllUI();
    };
    
    const loadNativeAdAfterBill = () => {
        const adPlaceholder = document.getElementById('ad-placeholder-in-modal'); if (!adPlaceholder) return; 
        adPlaceholder.innerHTML = `<div id="container-4602f664803407cfda1aae472a65c04e"></div>`;
        const oldScript = document.querySelector('script[src*="pl27251273.profitableratecpm.com"]'); if (oldScript) oldScript.remove();
        const adScript = document.createElement('script');
        Object.assign(adScript, { async: true, 'data-cfasync': false, src: '//pl27251273.profitableratecpm.com/4602f664803407cfda1aae472a65c04e/invoke.js' });
        document.head.appendChild(adScript);
    };

    app.generateBillHTML = (bill, retailer, customer) => {
        const lang = translations[currentLanguage];
        return `<div id="bill-to-print" style="background-color: #fff; color: #000; padding: 15px; font-family:'Courier New', monospace; direction: ${document.documentElement.dir};">
            <div style="text-align:center;">
                <img src="${retailer.shopDetails.logo || ''}" style="max-height:80px; margin-bottom: 5px;">
                <h3 style="margin:5px 0; font-weight:bold;">${retailer.shopDetails.name}</h3>
                <p style="margin:2px 0; font-size: 12px;">${retailer.shopDetails.address}</p>
                ${retailer.shopDetails.gstin ? `<p style="margin:2px 0; font-size: 12px;">${lang.gstinBill} ${retailer.shopDetails.gstin}</p>` : ''}
                <p style="margin:2px 0; font-size: 12px;">${lang.phoneColumn}: ${retailer.shopDetails.phone}</p>
                <hr style="border:1px dashed #333; margin: 8px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                    <span>${lang.billNo} ${bill.billNo}</span>
                    <span>${lang.date}: ${bill.date} ${bill.time}</span>
                </div>
            </div>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <div class="bill-customer-info" style="font-size: 12px;">
                <p style="margin:2px 0;"><strong>${lang.customer}:</strong> ${customer.name}, ${customer.phone}</p>
                 ${customer.gstin ? `<p style="margin:2px 0; font-size: 12px;"><strong>${lang.gstinBill}</strong> ${customer.gstin}</p>` : ''}
            </div>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <table style="width:100%; font-size:12px; border-collapse:collapse;">
                <thead><tr><th style="text-align:left; padding: 2px;">${lang.productColumn}</th><th style="text-align:center; padding: 2px;">${lang.quantityColumn}</th><th style="text-align:right; padding: 2px;">${lang.rateColumn}</th><th style="text-align:center; padding: 2px;">${lang.gst}</th><th style="text-align:right; padding: 2px;">${lang.totalColumn}</th></tr></thead>
                <tbody>${bill.items.map(item => `<tr><td style="text-align:left; padding: 2px;">${item.name}</td><td style="text-align:center; padding: 2px;">${item.type === 'product' ? (item.quantity + ' ' + item.unit) : '-'}</td><td style="text-align:right; padding: 2px;">64${item.price.toFixed(2)}</td><td style="text-align:center; padding: 2px;">${item.gstPercent ? item.gstPercent.toFixed(2) + '%' : '-'}</td><td style="text-align:right; padding: 2px;">64${item.total.toFixed(2)}</td></tr>`).join('')}</tbody>
            </table>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <div style="font-size: 13px;">
                <div style="display:flex; justify-content:space-between;"><span>${lang.subTotalBill}</span><span>64${bill.subTotal.toFixed(2)}</span></div>
                 <div style="display:flex; justify-content:space-between;"><span>${lang.totalGst}</span><span>+ 64${bill.totalGst.toFixed(2)}</span></div>
                <div style="display:flex; justify-content:space-between;"><span>${lang.discountBill}</span><span>- 64${bill.discountAmount.toFixed(2)}</span></div>
                <hr style="border-top:1px solid #333; margin: 5px 0;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size: 15px;"><span>${lang.grandTotalBill}</span><span>64${bill.total.toFixed(2)}</span></div>
            </div>
             ${retailer.shopDetails.upiId ? `<div style="text-align:center; margin-top:10px;"><p style="font-weight:bold; margin: 5px 0;">${lang.scanToPay}</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(`upi://pay?pa=${retailer.shopDetails.upiId}&pn=${encodeURIComponent(retailer.shopDetails.name)}&am=${bill.total.toFixed(2)}&cu=INR&tn=BillNo${bill.billNo}`)}" alt="UPI QR Code" style="display:block;margin:5px auto;width:120px;height:120px;"></div>` : ''}
             <div style="display: flex; justify-content: space-between; margin-top: 40px; padding-top: 10px; border-top: 1px dashed #333;">
                <div style="text-align: center;">
                    ${retailer.shopDetails.signature ? `<img src="${retailer.shopDetails.signature}" style="height: 40px;"/>` : ''}
                    <p style="margin: 0; font-size: 12px;">(${lang.authorizedSignatory})</p>
                </div>
                <div style="text-align: center;">
                     ${retailer.shopDetails.stamp ? `<img src="${retailer.shopDetails.stamp}" style="height: 50px;"/>` : ''}
                </div>
            </div>
            <div style="text-align:center;margin-top:15px; font-size: 12px;"><p style="margin:0;">${lang.visitAgain} ${lang.thanksForShopping}</p></div>
        </div>`;
    };

    const getOrCreateCustomer = (name, phone, address) => {
        const retailer = allRetailerData[currentUserEmail];
        let customer = retailer.customers.find(c => c.phone === phone);
        if (customer) { Object.assign(customer, { name, address }); } 
        else { customer = { id: Date.now(), name, phone, address, gstin: '' }; retailer.customers.push(customer); }
        return customer;
    };
    
    const handleGenerateBill = () => {
        if (currentBillItems.length === 0) { alert(translations[currentLanguage].addItemsToBill); return; }
        const retailer = allRetailerData[currentUserEmail];
        const customerName = document.getElementById('billingCustomerName').value.trim();
        const customerPhone = document.getElementById('billingCustomerPhone').value.trim();
        if (!customerPhone || !customerName) { alert(translations[currentLanguage].customerInfoRequired); return; }
        
        const subTotal = currentBillItems.reduce((sum, item) => sum + (item.basePrice * item.quantity), 0);
        const totalGst = currentBillItems.reduce((sum, item) => sum + (item.gstAmount * item.quantity), 0);
        const discountValue = parseFloat(document.getElementById('discountInput').value) || 0;
        const discountType = document.getElementById('discountType').value;
        const discountAmount = (discountType === 'percent') ? (subTotal * discountValue) / 100 : discountValue;
        const finalTotal = subTotal + totalGst - discountAmount;

        const customerForBill = getOrCreateCustomer(customerName, customerPhone, document.getElementById('billingCustomerAddress').value.trim());

        if (editingBillId) { // Update existing bill
            const billToUpdate = retailer.bills.find(b => b.billNo === editingBillId);
            if(billToUpdate) {
                // Revert old stock change
                billToUpdate.items.forEach(oldItem => {
                    if (oldItem.type === 'product') {
                        const inventoryItem = retailer.inventory.find(p => p.id === oldItem.id);
                        if (inventoryItem) inventoryItem.quantity += oldItem.quantity;
                    }
                });
                // Remove old cash flow entry
                const oldCashFlowIndex = retailer.cashFlow.findIndex(cf => cf.notes === `Bill No: ${billToUpdate.billNo}`);
                if (oldCashFlowIndex > -1) retailer.cashFlow.splice(oldCashFlowIndex, 1);

                billToUpdate.items = JSON.parse(JSON.stringify(currentBillItems));
                billToUpdate.subTotal = subTotal;
                billToUpdate.totalGst = totalGst;
                billToUpdate.discountAmount = discountAmount;
                billToUpdate.total = finalTotal;
            }
             document.getElementById('generateBillBtn').innerText = translations[currentLanguage].generateBill;
             editingBillId = null;
        } else { // Create new bill
            const today = new Date();
            const pad = (n) => n.toString().padStart(2, '0');
            const billId = `${today.getFullYear()}${pad(today.getMonth() + 1)}${pad(today.getDate())}${pad(today.getHours())}${pad(today.getMinutes())}${pad(today.getSeconds())}-${billCounter++}`;
            const billDate = `${pad(today.getDate())}-${pad(today.getMonth() + 1)}-${today.getFullYear()}`;
            const billTime = `${pad(today.getHours())}:${pad(today.getMinutes())}`;
            const newBill = { billNo: billId, customerId: customerForBill.id, date: billDate, time: billTime, items: JSON.parse(JSON.stringify(currentBillItems)), subTotal, totalGst, discountAmount, total: finalTotal };
            retailer.bills.push(newBill);
            currentBillForModal = newBill;
            document.getElementById('bill-to-print-container').innerHTML = app.generateBillHTML(newBill, retailer, customerForBill);
            loadNativeAdAfterBill();
            document.getElementById('bill-modal').style.display = 'block';
        }
        
        // Add cash flow entry for the sale (Debit to customer)
        if (!Array.isArray(retailer.cashFlow)) retailer.cashFlow = [];
        retailer.cashFlow.push({
            id: Date.now(), type: 'debit_customer', amount: finalTotal, partyId: `customer-${customerForBill.id}`,
            date: new Date().toISOString(), notes: `Bill No: ${editingBillId || currentBillForModal.billNo}`
        });

        // Apply new stock change
        currentBillItems.forEach(item => { 
            if (item.type === 'product') {
                const inventoryItem = retailer.inventory.find(p => p.id === item.id);
                if(inventoryItem) inventoryItem.quantity -= item.quantity; 
            }
        });

        saveData();
        renderAllUI();
        resetBillForm();
    };

    const resetBillForm = () => {
        currentBillItems = [];
        editingBillId = null;
        document.getElementById('customerDetailsForm').reset();
        document.querySelector('input[name="itemType"][value="product"]').checked = true;
        document.getElementById('product-fields').classList.remove('hidden');
        document.getElementById('service-fields').classList.add('hidden');
        document.getElementById('discountInput').value = 0;
        document.getElementById('generateBillBtn').innerText = translations[currentLanguage].generateBill;
        updateCurrentBillDisplay();
        resetItemCalculator();
        document.getElementById('serviceDescriptionInput').value = '';
        document.getElementById('serviceChargeInput').value = '';
        document.querySelector('input[name="serviceGstType"][value="without_gst"]').checked = true;
        document.getElementById('serviceGstPercent').value = 0;
        document.getElementById('service-gst-field-container').classList.add('hidden');
    };


    app.showSalesHistoryForCustomer = (customerId) => {
        const retailer = allRetailerData[currentUserEmail];
        const customer = retailer.customers.find(c => c.id == customerId);
        const customerBills = (retailer.bills || []).filter(b => b.customerId == customerId).reverse();
        const lang = translations[currentLanguage];
        document.getElementById('history-modal-title').innerText = `${customer.name} - ${lang.historyBtn}`;
        
        const billsHtml = customerBills.length > 0 ? customerBills.map(bill => `
            <div class="history-item">
                <p><strong>${lang.billNo}</strong> ${bill.billNo} | <strong>${lang.date}:</strong> ${bill.date} | <strong>${lang.total}:</strong> 64${bill.total.toFixed(2)}</p>
                <div class="history-item-actions">
                    <button onclick="app.reprintBill('${bill.billNo}')" class="action-button view">${lang.viewBill}</button>
                    <button onclick="app.editBill('${bill.billNo}')" class="action-button edit">${lang.editBtn}</button>
                    <button onclick="app.deleteBill('${bill.billNo}')" class="action-button delete">${lang.deleteBtn}</button>
                </div>
            </div>`).join('') : `<p>${lang.noSalesHistory}</p>`;

        const container = document.getElementById('historyContainer');
        container.innerHTML = `<h4>${lang.salesReportTitle}</h4>${billsHtml}` + generatePartyCashFlowHTML('customer', customerId, customer.name);
        
        document.getElementById('history-modal').style.display = 'block';
    };
    
    app.deleteBill = (billNo) => {
        if (confirm(translations[currentLanguage].confirmDeleteBill)) {
            const retailerData = allRetailerData[currentUserEmail];
            const billIndex = retailerData.bills.findIndex(b => b.billNo === billNo);
            if (billIndex === -1) return;

            const billToDelete = retailerData.bills[billIndex];
            
            // Restore stock
            billToDelete.items.forEach(item => {
                if (item.type === 'product') {
                    const inventoryItem = retailerData.inventory.find(p => p.id === item.id);
                    if (inventoryItem) inventoryItem.quantity += item.quantity;
                }
            });
            
            // Delete associated cash flow entry
            const cashFlowIndex = retailerData.cashFlow.findIndex(cf => cf.notes === `Bill No: ${billNo}`);
            if (cashFlowIndex > -1) retailerData.cashFlow.splice(cashFlowIndex, 1);

            const customerId = billToDelete.customerId;
            retailerData.bills.splice(billIndex, 1);
            saveData();
            app.showSalesHistoryForCustomer(customerId); // Refresh modal content
            renderAllUI();
        }
    };
    
    app.editBill = (billNo) => {
        const retailer = allRetailerData[currentUserEmail];
        const bill = retailer.bills.find(b => b.billNo == billNo);
        const customer = retailer.customers.find(c => c.id == bill.customerId);
        if(!bill || !customer) return;

        editingBillId = billNo;
        
        document.getElementById('billingCustomerName').value = customer.name;
        document.getElementById('billingCustomerPhone').value = customer.phone;
        document.getElementById('billingCustomerAddress').value = customer.address || '';
        
        currentBillItems = JSON.parse(JSON.stringify(bill.items));
        
        const subTotal = bill.subTotal;
        const discountAmount = bill.discountAmount;
        if(bill.discountType === 'percent') {
            document.getElementById('discountType').value = 'percent';
            document.getElementById('discountInput').value = subTotal > 0 ? ((discountAmount * 100) / subTotal).toFixed(2) : 0;
        } else {
            document.getElementById('discountType').value = 'fixed';
            document.getElementById('discountInput').value = discountAmount;
        }

        updateCurrentBillDisplay();
        document.getElementById('generateBillBtn').innerText = translations[currentLanguage].updateBtn;
        document.getElementById('history-modal').style.display = 'none';
        showTab('sell');
    };

    app.reprintBill = (billNo) => {
        const retailer = allRetailerData[currentUserEmail];
        const bill = retailer.bills.find(b => b.billNo == billNo);
        const customer = retailer.customers.find(c => c.id == bill.customerId);
        if (bill && customer) {
            currentBillForModal = bill;
            document.getElementById('bill-to-print-container').innerHTML = app.generateBillHTML(bill, retailer, customer);
            if(document.getElementById('history-modal').style.display === 'block') document.getElementById('history-modal').style.display = 'none';
            loadNativeAdAfterBill();
            document.getElementById('bill-modal').style.display = 'block';
            document.getElementById('closeBillModalBtn').dataset.isReprint = "true";
        }
    };

    const handleCreateBackup = () => {
        try {
            const backupData = { allRetailerData: allRetailerData, billCounter: billCounter, estimateCounter: estimateCounter };
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `billing-app-backup-${new Date().toISOString().slice(0, 10)}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            alert(translations[currentLanguage].backupSuccess);
        } catch (error) { console.error('Backup failed:', error); alert('Backup creation failed.'); }
    };

    const handleRestoreBackup = (event) => {
        const lang = translations[currentLanguage];
        if (!confirm(lang.restoreConfirm)) { event.target.value = ''; return; }
        const file = event.target.files[0];
        if (file && file.type === "application/json") {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (backupData && backupData.allRetailerData) {
                        localStorage.setItem('allRetailerData', JSON.stringify(backupData.allRetailerData));
                        if(backupData.billCounter) localStorage.setItem('billCounter', backupData.billCounter);
                        if(backupData.estimateCounter) localStorage.setItem('estimateCounter', backupData.estimateCounter);
                        alert(lang.restoreSuccess);
                        initializeApp();
                    } else { alert(lang.invalidBackupFile); }
                } catch (error) { console.error('Restore failed:', error); alert(lang.invalidBackupFile); } 
                finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        } else { alert(lang.invalidBackupFile); event.target.value = ''; }
    };
    
    // --- 10101411161511 1612141919 1510101118161514 ---
    const handleVerifyEmail = () => {
        const email = document.getElementById('resetEmail').value.toLowerCase();
        const lang = translations[currentLanguage];
        if (allRetailerData[email]) {
            document.getElementById('newPasswordSection').classList.remove('hidden');
            document.getElementById('resetEmail').disabled = true;
            document.getElementById('verifyEmailBtn').disabled = true;
        } else {
            alert(lang.emailNotFound);
        }
    };
    
    const handleResetPassword = (e) => {
        e.preventDefault();
        const email = document.getElementById('resetEmail').value.toLowerCase();
        const phone = document.getElementById('resetPhone').value;
        const newPassword = document.getElementById('resetNewPassword').value;
        const confirmPassword = document.getElementById('resetConfirmPassword').value;
        const lang = translations[currentLanguage];

        if (newPassword !== confirmPassword) {
            alert(lang.passwordsDoNotMatch);
            return;
        }
        if (!newPassword) {
             alert(lang.fillAllFields);
             return;
        }

        const userData = allRetailerData[email];
        if (userData && userData.shopDetails.phone === phone) {
            userData.password = newPassword;
            saveData();
            alert(lang.passwordResetSuccess);
            showPage('login-page');
        } else {
            alert(lang.verificationFailed);
        }
    };

    // --- 141014161514111916151410 111019151218 ---
    const getOrCreateSupplier = (name, phone, address) => {
        const retailer = allRetailerData[currentUserEmail];
        let supplier = retailer.suppliers.find(s => s.phone === phone);
        if (supplier) {
            if (supplier.name !== name) { supplier.name = name; } 
            if (address) { supplier.address = address; }
        } else {
            supplier = { id: Date.now(), name, phone, address: address || '', gstin: '' }; 
            if (!Array.isArray(retailer.suppliers)) retailer.suppliers = [];
            retailer.suppliers.push(supplier);
        }
        renderSupplierTable(); 
        return supplier;
    };
    const handleAddSupplier = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const name = document.getElementById('supplierName').value.trim();
        const phone = document.getElementById('supplierPhone').value.trim();
        const address = document.getElementById('supplierAddress').value.trim();
        const gstin = document.getElementById('supplierGstin').value.trim();
        const lang = translations[currentLanguage];
        if (!name || !phone) { alert(lang.fillAllFields); return; }

        if (editingSupplierId) {
            const supplier = retailerData.suppliers.find(s => s.id === editingSupplierId);
            if(supplier) Object.assign(supplier, { name, phone, address, gstin });
            document.getElementById('supplierSubmitBtn').innerText = lang.addSupplierBtn;
            editingSupplierId = null;
        } else {
            if (!Array.isArray(retailerData.suppliers)) retailerData.suppliers = [];
            if (retailerData.suppliers.some(s => s.phone === phone)) {
                alert("1514 11181318 18101216 11101810 141014161514111916151410 10151819 1419 1414161416 151018");
                return;
            }
            retailerData.suppliers.push({ id: Date.now(), name, phone, address, gstin });
        }
        saveData();
        renderSupplierTable();
        e.target.reset();
    };

    app.editSupplier = (supplierId) => {
        const supplier = allRetailerData[currentUserEmail].suppliers.find(s => s.id === supplierId);
        if (supplier) {
            editingSupplierId = supplierId;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierAddress').value = supplier.address || '';
            document.getElementById('supplierGstin').value = supplier.gstin || '';
            document.getElementById('supplierSubmitBtn').innerText = translations[currentLanguage].updateBtn;
            showTab('suppliers');
        }
    };

    app.deleteSupplier = (supplierId) => {
        if(confirm(translations[currentLanguage].confirmDeleteSupplier)) {
            const retailerData = allRetailerData[currentUserEmail];
            retailerData.suppliers = retailerData.suppliers.filter(s => s.id !== supplierId);
            saveData();
            renderAllUI();
        }
    };
    
    // --- 111516101519 111019151218 ---
    const handleAddCustomer = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const name = document.getElementById('addCustomerName').value.trim();
        const phone = document.getElementById('addCustomerPhone').value.trim();
        const address = document.getElementById('addCustomerAddress').value.trim();
        const gstin = document.getElementById('addCustomerGstin').value.trim();
        const lang = translations[currentLanguage];
        if (!name || !phone) { alert(lang.fillAllFields); return; }

        if (editingCustomerId) {
            const customer = retailerData.customers.find(c => c.id === editingCustomerId);
            if (customer) { Object.assign(customer, { name, phone, address, gstin }); }
            document.getElementById('customerSubmitBtn').innerText = lang.addCustomerBtn;
            editingCustomerId = null;
        } else {
            if (!Array.isArray(retailerData.customers)) retailerData.customers = [];
            if (retailerData.customers.some(c => c.phone === phone)) {
                 alert("1514 11181318 18101216 11101810 111516101519 10151819 1419 1414161416 151018");
                 return;
            }
            retailerData.customers.push({ id: Date.now(), name, phone, address, gstin });
            alert(lang.customerAddedSuccess);
        }
        saveData();
        renderCustomerTable();
        e.target.reset();
    };

    app.editCustomer = (customerId) => {
        const customer = allRetailerData[currentUserEmail].customers.find(c => c.id === customerId);
        if (customer) {
            editingCustomerId = customerId;
            document.getElementById('addCustomerName').value = customer.name;
            document.getElementById('addCustomerPhone').value = customer.phone;
            document.getElementById('addCustomerAddress').value = customer.address || '';
            document.getElementById('addCustomerGstin').value = customer.gstin || '';
            document.getElementById('customerSubmitBtn').innerText = translations[currentLanguage].updateBtn;
            showTab('customers');
        }
    };

    app.deleteCustomer = (customerId) => {
        if (confirm(translations[currentLanguage].confirmDeleteCustomer)) {
            const retailerData = allRetailerData[currentUserEmail];
            retailerData.customers = retailerData.customers.filter(c => c.id !== customerId);
            saveData();
            renderCustomerTable();
        }
    };

    // --- 10161216 111019151218 ---
    const calculatePurchasePrices = (source) => {
        const gstType = document.querySelector('input[name="gstType"]:checked').value;
        const basePriceEl = document.getElementById('purchaseBasePrice');
        const gstPercentEl = document.getElementById('purchaseGstPercent');
        const totalPriceEl = document.getElementById('purchaseTotalPrice');
        const profitValueEl = document.getElementById('purchaseProfitMarginValue');
        const profitTypeEl = document.getElementById('purchaseProfitMarginType');
        const sellingPriceEl = document.getElementById('purchaseSellingPrice');

        let basePrice = parseFloat(basePriceEl.value) || 0;
        let gstPercent = (gstType === 'with_gst') ? (parseFloat(gstPercentEl.value) || 0) : 0;
        let totalPrice = parseFloat(totalPriceEl.value) || 0;

        if (source === 'base' || source === 'gst') {
            totalPrice = basePrice * (1 + (gstPercent / 100));
            if(totalPrice > 0) totalPriceEl.value = totalPrice.toFixed(2);
        } else if (source === 'total') {
            basePrice = totalPrice / (1 + (gstPercent / 100));
            if(basePrice > 0) basePriceEl.value = basePrice.toFixed(2);
        }
        
        let profitValue = parseFloat(profitValueEl.value) || 0;
        let profitType = profitTypeEl.value;
        let finalSellingPrice = 0;
        
        const purchasePriceForProfitCalc = parseFloat(totalPriceEl.value) || 0;

        if (profitType === 'percent') {
            finalSellingPrice = purchasePriceForProfitCalc * (1 + (profitValue / 100));
        } else {
            finalSellingPrice = purchasePriceForProfitCalc + profitValue;
        }
        if(finalSellingPrice > 0) sellingPriceEl.value = finalSellingPrice.toFixed(2);
    };

    const renderPurchaseHistory = () => {
        const fromDateStr = document.getElementById('purchaseHistoryFromDate').value;
        const toDateStr = document.getElementById('purchaseHistoryToDate').value;

        const retailerData = allRetailerData[currentUserEmail];
        const container = document.getElementById('tabPurchaseHistoryContainer');
        const lang = translations[currentLanguage];
        const suppliers = retailerData.suppliers || [];

        let entries = retailerData.purchaseEntries || [];

        if (fromDateStr && toDateStr) {
            const fromDate = new Date(fromDateStr); fromDate.setHours(0,0,0,0);
            const toDate = new Date(toDateStr); toDate.setHours(23,59,59,999);
            entries = entries.filter(e => {
                const entryDate = new Date(e.purchaseBillDate || e.date);
                return entryDate >= fromDate && entryDate <= toDate;
            });
        }
        
        entries = entries.slice().reverse(); 

        if(entries.length === 0) {
            container.innerHTML = `<p>${lang.noPurchaseEntries}</p>`;
            return;
        }

        container.innerHTML = entries.map(entry => {
            const supplier = suppliers.find(s => s.id === entry.supplierId);
            const totalCost = (entry.item.totalPrice || 0) * (entry.item.quantity || 0);
            return `
            <div class="history-item">
                <p><strong>${lang.supplierName}</strong> ${supplier ? supplier.name : 'N/A'} | <strong>${lang.purchaseDate}:</strong> ${new Date(entry.purchaseBillDate || entry.date).toLocaleDateString()}</p>
                <p><strong>${lang.purchaseBillNo}:</strong> ${entry.purchaseBillNo || 'N/A'}</p>
                <p><strong>${lang.purchaseItems}:</strong> ${entry.item.name} (${entry.item.quantity} ${entry.item.unit}) @ 64${totalCost.toFixed(2)}</p>
                 <div class="history-item-actions">
                    <button onclick="app.editPurchase(${entry.id})" class="action-button edit">${lang.editBtn}</button>
                    <button onclick="app.deletePurchase(${entry.id})" class="action-button delete">${lang.deleteBtn}</button>
                </div>
            </div>
        `}).join('');
    };
    
    app.showPurchaseHistoryForSupplier = (supplierId) => {
        const retailer = allRetailerData[currentUserEmail];
        const supplier = retailer.suppliers.find(s => s.id == supplierId);
        const entries = (retailer.purchaseEntries || []).filter(e => e.supplierId == supplierId).reverse();
        
        document.getElementById('history-modal-title').innerText = `${supplier.name} ${translations[currentLanguage].historyBtn}`;
        const container = document.getElementById('historyContainer');
        const lang = translations[currentLanguage];
        
        const purchasesHtml = entries.length > 0 ? entries.map(entry => `
            <div class="history-item">
                <p><strong>${lang.purchaseDate}:</strong> ${new Date(entry.purchaseBillDate || entry.date).toLocaleString()}</p>
                ${entry.purchaseBillNo ? `<p><strong>${lang.purchaseBillNo}:</strong> ${entry.purchaseBillNo}</p>` : ''}
                <p><strong>${lang.purchaseItems}:</strong> ${entry.item.name} (${entry.item.quantity} ${entry.item.unit})</p>
                <p><strong>Total Cost:</strong> 64${((entry.item.totalPrice || 0) * (entry.item.quantity || 0)).toFixed(2)}</p>
                 <div class="history-item-actions">
                    <button onclick="app.showPurchaseSlipPreview(${entry.id})" class="action-button print">${lang.printPurchaseNote}</button>
                    <button onclick="app.editPurchase(${entry.id})" class="action-button edit" disabled>${lang.editBtn}</button>
                    <button onclick="app.deletePurchase(${entry.id}, ${supplierId})" class="action-button delete">${lang.deleteBtn}</button>
                </div>
            </div>
        `).join('') : `<p>${lang.noPurchaseHistory}</p>`;

        container.innerHTML = `<h4>${lang.purchaseReportTitle}</h4>${purchasesHtml}` + generatePartyCashFlowHTML('supplier', supplierId);
        
        document.getElementById('history-modal').style.display = 'block';
    };
    
    app.deletePurchase = (purchaseId, supplierId) => {
        if (confirm(translations[currentLanguage].confirmDeletePurchase)) {
            const retailerData = allRetailerData[currentUserEmail];
            const purchaseIndex = retailerData.purchaseEntries.findIndex(p => p.id === purchaseId);
            if (purchaseIndex === -1) return;

            const purchaseToDelete = retailerData.purchaseEntries[purchaseIndex];
            
            // Adjust stock
            const inventoryItem = retailerData.inventory.find(p => p.name.toLowerCase() === purchaseToDelete.item.name.toLowerCase());
            if (inventoryItem) {
                inventoryItem.quantity -= purchaseToDelete.item.quantity;
                if (inventoryItem.quantity < 0) inventoryItem.quantity = 0; // Prevent negative stock
            }
            
            // Delete associated cash flow entry
            const cashFlowIndex = retailerData.cashFlow.findIndex(cf => cf.notes === `Purchase No: ${purchaseId}`);
            if(cashFlowIndex > -1) retailerData.cashFlow.splice(cashFlowIndex, 1);

            retailerData.purchaseEntries.splice(purchaseIndex, 1);
            saveData();
            if (supplierId) {
                app.showPurchaseHistoryForSupplier(supplierId); // Refresh modal if open
            }
            renderAllUI();
        }
    };


    const handleAddPurchaseEntry = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        
        const productName = document.getElementById('purchaseProductName').value.trim();
        const hsnSac = document.getElementById('purchaseHsnSac').value.trim();
        const quantity = parseFloat(document.getElementById('purchaseQuantity').value);
        const unit = document.getElementById('purchaseUnit').value;

        const basePrice = parseFloat(document.getElementById('purchaseBasePrice').value);
        const gstPercent = parseFloat(document.getElementById('purchaseGstPercent').value) || 0;
        const totalPrice = parseFloat(document.getElementById('purchaseTotalPrice').value);
        const profitMarginValue = parseFloat(document.getElementById('purchaseProfitMarginValue').value) || 0;
        const profitMarginType = document.getElementById('purchaseProfitMarginType').value;
        const sellingPrice = parseFloat(document.getElementById('purchaseSellingPrice').value);
        
        if (editingInventoryItemId) {
            const itemToUpdate = retailerData.inventory.find(item => item.id === editingInventoryItemId);
            if(itemToUpdate) {
                itemToUpdate.name = productName;
                itemToUpdate.purchasePrice = totalPrice;
                itemToUpdate.price = sellingPrice;
                itemToUpdate.gstPercent = gstPercent;
                itemToUpdate.profitMarginValue = profitMarginValue;
                itemToUpdate.profitMarginType = profitMarginType;
            }
            saveData();
            alert(lang.stockItemUpdated);
            resetPurchaseForm();
            showTab('inventory');
            return;
        }

        const supplierName = document.getElementById('purchaseSupplierName').value.trim();
        const supplierPhone = document.getElementById('purchaseSupplierPhone').value.trim();
        const supplierAddress = document.getElementById('purchaseSupplierAddress').value.trim();
        const purchaseBillNo = document.getElementById('purchaseBillNo').value.trim();
        const purchaseBillDate = document.getElementById('purchaseBillDate').value;
        
        if (!supplierName || !supplierPhone || !productName || isNaN(basePrice) || basePrice <= 0 || isNaN(totalPrice) || totalPrice <= 0 || isNaN(sellingPrice) || sellingPrice <= 0 || isNaN(quantity) || quantity <= 0) {
            alert(lang.fillAllFields); return;
        }
        
        const purchaseItemObject = {
            name: productName, hsnSac: hsnSac || '', unit, quantity,
            basePrice, gstPercent, totalPrice,
            profitMarginValue, profitMarginType, sellingPrice
        };
        
        const supplier = getOrCreateSupplier(supplierName, supplierPhone, supplierAddress);
        if (!Array.isArray(retailerData.purchaseEntries)) retailerData.purchaseEntries = [];
        
        const purchaseEntryId = Date.now();
        retailerData.purchaseEntries.push({
            id: purchaseEntryId,
            supplierId: supplier.id,
            date: new Date().toISOString(),
            purchaseBillNo,
            purchaseBillDate,
            item: purchaseItemObject
        });

        // Add cash flow entry for purchase (Credit to supplier)
        if (!Array.isArray(retailerData.cashFlow)) retailerData.cashFlow = [];
        const purchaseAmount = totalPrice * quantity;
        retailerData.cashFlow.push({
            id: Date.now(), type: 'credit_supplier', amount: purchaseAmount, partyId: `supplier-${supplier.id}`,
            date: new Date().toISOString(), notes: `Purchase No: ${purchaseEntryId}`
        });

        let inventoryItem = retailerData.inventory.find(item => item.name.toLowerCase() === productName.toLowerCase());
        if (inventoryItem) {
            inventoryItem.quantity += quantity;
            inventoryItem.price = sellingPrice;
            inventoryItem.purchasePrice = totalPrice;
            inventoryItem.gstPercent = gstPercent;
            inventoryItem.profitMarginValue = profitMarginValue;
            inventoryItem.profitMarginType = profitMarginType;
        } else {
            retailerData.inventory.push({ 
                id: Date.now(), 
                name: productName, 
                price: sellingPrice, 
                quantity, 
                unit,
                purchasePrice: totalPrice,
                gstPercent: gstPercent,
                profitMarginValue: profitMarginValue,
                profitMarginType: profitMarginType
            });
        }

        saveData();
        renderAllUI();
        resetPurchaseForm();
    };
    
    app.editPurchase = (purchaseId) => {
        alert("Purchase entry editing is not directly supported. Please delete the entry, which will adjust the stock, and create a new one. You can edit the product details from the inventory tab.");
    };

    const resetPurchaseForm = () => {
        document.getElementById('addPurchaseItemForm').reset();
        document.getElementById('purchaseBillDate').valueAsDate = new Date();
        document.getElementById('supplier-details-fieldset').disabled = false;
        document.getElementById('purchaseQuantity').disabled = false;
        document.getElementById('purchaseUnit').disabled = false;
        const submitBtn = document.getElementById('purchaseSubmitBtn');
        submitBtn.innerText = translations[currentLanguage].addToPurchaseAndInventory;
        submitBtn.dataset.langKey = 'addToPurchaseAndInventory';
        editingInventoryItemId = null;
    };
    
    app.editStockItem = (itemId) => {
        const retailer = allRetailerData[currentUserEmail];
        const item = retailer.inventory.find(i => i.id === itemId);
        if (!item) return;

        editingInventoryItemId = itemId;
        showTab('purchase');

        document.getElementById('supplier-details-fieldset').disabled = true;
        document.getElementById('purchaseQuantity').disabled = true;
        document.getElementById('purchaseUnit').disabled = true;

        document.getElementById('purchaseProductName').value = item.name;
        document.getElementById('purchaseHsnSac').value = item.hsnSac || '';

        const gstPercent = item.gstPercent || 0;
        const totalPrice = item.purchasePrice || 0;
        const basePrice = totalPrice / (1 + (gstPercent / 100));
        
        if (gstPercent > 0) {
            document.querySelector('input[name="gstType"][value="with_gst"]').checked = true;
            document.getElementById('gst-field-container').classList.remove('hidden');
        } else {
            document.querySelector('input[name="gstType"][value="without_gst"]').checked = true;
            document.getElementById('gst-field-container').classList.add('hidden');
        }

        document.getElementById('purchaseBasePrice').value = basePrice.toFixed(2);
        document.getElementById('purchaseGstPercent').value = gstPercent;
        document.getElementById('purchaseTotalPrice').value = totalPrice.toFixed(2);
        
        document.getElementById('purchaseProfitMarginValue').value = item.profitMarginValue || 0;
        document.getElementById('purchaseProfitMarginType').value = item.profitMarginType || 'percent';
        document.getElementById('purchaseSellingPrice').value = item.price.toFixed(2);
        
        document.getElementById('purchaseQuantity').value = item.quantity;
        document.getElementById('purchaseUnit').value = item.unit;
        
        const submitBtn = document.getElementById('purchaseSubmitBtn');
        submitBtn.innerText = translations[currentLanguage].updateBtn;
        submitBtn.removeAttribute('data-lang-key');
    };
    
    const generatePurchaseSlipHTML = (purchaseEntry) => {
        const retailer = allRetailerData[currentUserEmail];
        const supplier = retailer.suppliers.find(s => s.id === purchaseEntry.supplierId);
        const item = purchaseEntry.item;
        const totalCost = item.totalPrice * item.quantity;
        const lang = translations[currentLanguage];

        return `<div style="background-color: #fff; color: #000; padding: 15px; font-family:'Courier New', monospace;">
            <div style="text-align:center;">
                <h3 style="margin:5px 0; font-weight:bold;">${lang.purchaseReportTitle}</h3>
                <p style="margin:2px 0; font-size: 12px;">${retailer.shopDetails.name}</p>
                 <hr style="border:1px dashed #333; margin: 8px 0;">
            </div>
            <p><strong>${lang.purchaseId}:</strong> ${purchaseEntry.id}</p>
            ${purchaseEntry.purchaseBillNo ? `<p><strong>${lang.purchaseBillNo}:</strong> ${purchaseEntry.purchaseBillNo}</p>`:''}
            <p><strong>${lang.purchaseDate}:</strong> ${new Date(purchaseEntry.date).toLocaleString()}</p>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <h4>${lang.supplierDetails}</h4>
            <p><strong>${lang.name}:</strong> ${supplier.name}</p>
            <p><strong>${lang.phoneColumn}:</strong> ${supplier.phone}</p>
            <p><strong>${lang.address}:</strong> ${supplier.address || 'N/A'}</p>
            ${supplier.gstin ? `<p><strong>${lang.gstinLabel}:</strong> ${supplier.gstin}</p>`:''}
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <h4>${lang.purchaseItems}</h4>
            <table style="width:100%; font-size:12px; border-collapse:collapse;">
                 <thead><tr><th style="text-align:left;">${lang.productColumn}</th><th style="text-align:center;">${lang.quantity}</th><th style="text-align:right;">${lang.purchasePrice}</th><th style="text-align:right;">${lang.total}</th></tr></thead>
                 <tbody>
                    <tr>
                        <td>${item.name}</td>
                        <td style="text-align:center;">${item.quantity} ${item.unit}</td>
                        <td style="text-align:right;">64${item.totalPrice.toFixed(2)}</td>
                        <td style="text-align:right;">64${totalCost.toFixed(2)}</td>
                    </tr>
                 </tbody>
            </table>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <div style="text-align:right; font-weight:bold; font-size: 15px;">
                <span>${lang.grandTotal}:</span><span>64${totalCost.toFixed(2)}</span>
            </div>
        </div>`;
    };
    
    app.showPurchaseSlipPreview = (purchaseId) => {
        const purchase = allRetailerData[currentUserEmail].purchaseEntries.find(p => p.id === purchaseId);
        if(!purchase) return;
        
        const modal = document.getElementById('print-preview-modal');
        const contentDiv = document.getElementById('print-preview-content');
        contentDiv.innerHTML = generatePurchaseSlipHTML(purchase);
        
        document.querySelector('input[name="paper-size"][value="a4"]').checked = true;
        contentDiv.className = 'preview-a4';
        
        document.getElementById('history-modal').style.display = 'none';
        modal.style.display = 'block';
    };


    // --- 10161514 111019151218 ---
    const renderExpensesTable = () => {
        const expenses = allRetailerData[currentUserEmail]?.expenses || [];
        const lang = translations[currentLanguage];
        const tableBody = document.getElementById('expensesTableBody');
        tableBody.innerHTML = expenses.slice().reverse().map(exp => `
            <tr>
                <td>${exp.description}</td>
                <td>64${exp.amount.toFixed(2)}</td>
                <td>${exp.date}</td>
                <td>
                    <button class="action-button delete" onclick="window.app.deleteExpense(${exp.id})">${lang.deleteBtn}</button>
                </td>
            </tr>
        `).join('');
    };

    const handleAddExpense = (e) => {
        e.preventDefault();
        const retailerData = allRetailerData[currentUserEmail];
        const description = document.getElementById('expenseDescription').value.trim();
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const date = document.getElementById('expenseDate').value;
        const lang = translations[currentLanguage];

        if (!description || isNaN(amount) || amount <= 0 || !date) {
            alert(lang.fillAllFields);
            return;
        }

        if (!Array.isArray(retailerData.expenses)) retailerData.expenses = [];
        
        retailerData.expenses.push({ id: Date.now(), description, amount, date });
        saveData();
        renderExpensesTable();
        renderDashboard();
        alert(lang.expenseAddedSuccess);
        e.target.reset();
        document.getElementById('expenseDate').valueAsDate = new Date();
    };

    app.deleteExpense = (expenseId) => {
        if (confirm(translations[currentLanguage].deleteConfirm)) {
            const retailerData = allRetailerData[currentUserEmail];
            retailerData.expenses = retailerData.expenses.filter(exp => exp.id !== expenseId);
            saveData();
            renderExpensesTable();
            renderDashboard();
        }
    };
    
    // --- 141918 191012 111019151218 ---
    const renderRecentSales = () => {
        const fromDateStr = document.getElementById('salesHistoryFromDate').value;
        const toDateStr = document.getElementById('salesHistoryToDate').value;
        const retailerData = allRetailerData[currentUserEmail];
        const container = document.getElementById('tabSellHistoryContainer');
        const lang = translations[currentLanguage];

        let bills = (retailerData.bills || []).slice().reverse();

        if (fromDateStr && toDateStr) {
            const fromDate = new Date(fromDateStr); fromDate.setHours(0,0,0,0);
            const toDate = new Date(toDateStr); toDate.setHours(23,59,59,999);
            bills = bills.filter(bill => {
                 const [d, m, y] = bill.date.split('-');
                 const billDate = new Date(`${y}-${m}-${d}`);
                 return billDate >= fromDate && billDate <= toDate;
            });
        }

        if (bills.length === 0) {
            container.innerHTML = `<p>${lang.noSalesHistory}</p>`;
            return;
        }

        container.innerHTML = bills.map(bill => {
            const customer = retailerData.customers.find(c => c.id === bill.customerId);
            return `
            <div class="history-item">
                 <p><strong>${lang.billNo}</strong> ${bill.billNo} | <strong>${lang.date}:</strong> ${bill.date}</p>
                 <p><strong>${lang.customer}:</strong> ${customer ? customer.name : 'N/A'} | <strong>${lang.total}:</strong> 64${bill.total.toFixed(2)}</p>
                 <div class="history-item-actions">
                    <button onclick="app.reprintBill('${bill.billNo}')" class="action-button view">${lang.viewBill}</button>
                </div>
            </div>
            `;
        }).join('');
    };

    app.addProductToBillFromList = (productId) => {
        const product = allRetailerData[currentUserEmail].inventory.find(p => p.id === productId);
        if (product) {
            document.querySelector('input[name="itemType"][value="product"]').checked = true;
            document.getElementById('product-fields').classList.remove('hidden');
            document.getElementById('service-fields').classList.add('hidden');
            showItemCalculator(product);
            window.scrollTo(0, 0); // Scroll to top to see calculator
        }
    };

    const showItemCalculator = (product) => {
        productForCalculator = product;
        const calculator = document.getElementById('item-details-calculator');
        document.getElementById('calculatorProductName').innerText = product.name;
        document.getElementById('calcQuantity').value = 1;
        document.getElementById('calcUnit').value = product.unit;
        
        const sellingPrice = product.price || 0;
        const gstPercent = product.gstPercent || 0;
        
        document.getElementById('calcGstPercent').value = gstPercent;
        document.getElementById('calcTotalPrice').value = sellingPrice.toFixed(2);
        
        calculateItemPrice('total');
        
        calculator.classList.remove('hidden');
    };
    
    const calculateItemPrice = (source) => {
        if (!productForCalculator) return;
        const qty = parseFloat(document.getElementById('calcQuantity').value) || 1;
        let basePriceEl = document.getElementById('calcBasePrice');
        let gstPercentEl = document.getElementById('calcGstPercent');
        let totalPriceEl = document.getElementById('calcTotalPrice');

        let basePrice = parseFloat(basePriceEl.value) || 0;
        let gstPercent = parseFloat(gstPercentEl.value) || 0;
        let totalPrice = parseFloat(totalPriceEl.value) || 0;

        if (source === 'base' || source === 'gst') {
            totalPrice = basePrice * (1 + (gstPercent / 100));
            totalPriceEl.value = totalPrice.toFixed(4);
        } else if (source === 'total') {
            basePrice = totalPrice / (1 + (gstPercent / 100));
            basePriceEl.value = basePrice.toFixed(4);
        }
        
        const lineTotal = qty * totalPrice;
        document.getElementById('calcLineTotal').innerText = lineTotal.toFixed(2);
    };

    const handleAddItemToBillFromCalculator = () => {
        const lang = translations[currentLanguage];
        const quantity = parseFloat(document.getElementById('calcQuantity').value);
        if (!productForCalculator || isNaN(quantity) || quantity <= 0) {
            alert(lang.fillAllFields);
            return;
        }
        if (quantity > productForCalculator.quantity) {
             alert(lang.stockUnavailable.replace('{quantity}', productForCalculator.quantity).replace('{unit}', productForCalculator.unit));
             return;
        }

        const basePrice = parseFloat(document.getElementById('calcBasePrice').value);
        const gstPercent = parseFloat(document.getElementById('calcGstPercent').value);
        const totalPricePerUnit = parseFloat(document.getElementById('calcTotalPrice').value);
        const lineTotal = parseFloat(document.getElementById('calcLineTotal').innerText);
        const gstAmountPerUnit = totalPricePerUnit - basePrice;
        
        const existingItem = currentBillItems.find(item => item.id === productForCalculator.id && item.type === 'product');
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.total = existingItem.quantity * existingItem.price;
        } else {
             currentBillItems.push({
                ...productForCalculator, type: 'product',
                quantity: quantity,
                basePrice: basePrice,
                gstPercent: gstPercent,
                gstAmount: gstAmountPerUnit,
                price: totalPricePerUnit,
                total: lineTotal
            });
        }
       
        updateCurrentBillDisplay();
        resetItemCalculator();
        document.getElementById('productSearchInput').value = '';
    };
    
    const handleAddServiceToBill = () => {
        const lang = translations[currentLanguage];
        const description = document.getElementById('serviceDescriptionInput').value.trim();
        const totalPrice = parseFloat(document.getElementById('serviceChargeInput').value);
        const gstType = document.querySelector('input[name="serviceGstType"]:checked').value;
        const gstPercent = (gstType === 'with_gst') ? parseFloat(document.getElementById('serviceGstPercent').value) || 0 : 0;

        if (!description || isNaN(totalPrice) || totalPrice <= 0) {
            alert(lang.fillAllFields);
            return;
        }

        let basePrice, gstAmount;

        if (gstPercent > 0) {
            basePrice = totalPrice / (1 + (gstPercent / 100));
            gstAmount = totalPrice - basePrice;
        } else {
            basePrice = totalPrice;
            gstAmount = 0;
        }

        currentBillItems.push({
            id: Date.now(),
            type: 'service',
            name: description,
            basePrice: basePrice,
            gstAmount: gstAmount,
            gstPercent: gstPercent,
            price: totalPrice,
            quantity: 1,
            total: totalPrice,
            unit: ''
        });

        updateCurrentBillDisplay();
        document.getElementById('serviceDescriptionInput').value = '';
        document.getElementById('serviceChargeInput').value = '';
        document.querySelector('input[name="serviceGstType"][value="without_gst"]').checked = true;
        document.getElementById('serviceGstPercent').value = 0;
        document.getElementById('service-gst-field-container').classList.add('hidden');
    };

    const resetItemCalculator = () => {
        document.getElementById('item-details-calculator').classList.add('hidden');
        productForCalculator = null;
    };
    
    // --- 191012 11151813 111019151218 ---
    const renderCashFlow = () => {
        const retailer = allRetailerData[currentUserEmail];
        if(!retailer) return;
        if (!retailer.cashFlow) retailer.cashFlow = [];
        renderCashFlowTable();
        updateCashFlowSummary();
        document.getElementById('cashFlowDate').valueAsDate = new Date();
    };

    const renderCashFlowTable = () => {
        const retailer = allRetailerData[currentUserEmail];
        const cashFlow = retailer.cashFlow || [];
        const tableBody = document.getElementById('cashFlowTableBody');
        const lang = translations[currentLanguage];
        tableBody.innerHTML = cashFlow.filter(e => !e.partyId).slice().reverse().map(entry => {
            const amountClass = entry.type === 'in' ? 'cashflow-in' : 'cashflow-out';
            const amountPrefix = entry.type === 'in' ? '+' : '-';
            
            return `<tr>
                        <td>${new Date(entry.date).toLocaleDateString()}</td>
                        <td>${entry.notes || 'N/A'}</td>
                        <td>${entry.paymentMode || 'N/A'}</td>
                        <td class="${amountClass}">${amountPrefix} 64${entry.amount.toFixed(2)}</td>
                    </tr>`;
        }).join('');
    };

    const updateCashFlowSummary = () => {
        const cashFlow = allRetailerData[currentUserEmail].cashFlow || [];
        const totalIn = cashFlow.filter(e => e.type === 'in' || e.type === 'credit_customer' || e.type === 'credit_supplier').reduce((sum, e) => sum + e.amount, 0);
        const totalOut = cashFlow.filter(e => e.type === 'out' || e.type === 'debit_customer' || e.type === 'debit_supplier').reduce((sum, e) => sum + e.amount, 0);
        const netBalance = totalIn - totalOut;

        document.getElementById('totalCashInDisplay').textContent = `64${totalIn.toFixed(2)}`;
        document.getElementById('totalCashOutDisplay').textContent = `64${totalOut.toFixed(2)}`;
        const netBalanceEl = document.getElementById('netBalanceDisplay');
        netBalanceEl.textContent = `64${netBalance.toFixed(2)}`;
        netBalanceEl.className = netBalance >= 0 ? 'cashflow-in' : 'cashflow-out';
    };

    const handleAddCashFlow = (e) => {
        e.preventDefault();
        const retailer = allRetailerData[currentUserEmail];
        const type = document.getElementById('cashFlowType').value;
        const amount = parseFloat(document.getElementById('cashFlowAmount').value);
        const partyId = document.getElementById('cashFlowPartyId').value;
        const paymentMode = document.getElementById('cashFlowPaymentMode').value;
        const date = document.getElementById('cashFlowDate').value;
        const notes = document.getElementById('cashFlowNotes').value.trim();

        if (isNaN(amount) || amount <= 0 || !date) {
            alert(translations[currentLanguage].fillAllFields);
            return;
        }

        if(!Array.isArray(retailer.cashFlow)) retailer.cashFlow = [];
        
        let entryType;
        if (partyId) {
            const [partyType, id] = partyId.split('-');
            if (partyType === 'customer') {
                entryType = type === 'in' ? 'credit_customer' : 'debit_customer';
            } else {
                entryType = type === 'in' ? 'credit_supplier' : 'debit_supplier';
            }
        } else {
            entryType = type;
        }

        retailer.cashFlow.push({ id: Date.now(), type: entryType, amount, partyId: partyId || null, date, notes, paymentMode });

        saveData();
        renderCashFlow(); 
        e.target.reset();
        document.getElementById('cashFlowPartyId').value = '';
        document.getElementById('cashFlowDate').valueAsDate = new Date();
    };

    const generatePartyCashFlowHTML = (partyType, partyId, partyName) => {
        const retailer = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        
        let balance = 0;
        let ledgerRows = [];

        // Sort by date to calculate running balance correctly
        const sortedEntries = (retailer.cashFlow || [])
                                .filter(e => e.partyId === `${partyType}-${partyId}`)
                                .sort((a, b) => new Date(a.date) - new Date(b.date));

        for (const entry of sortedEntries) {
            let debit = 0, credit = 0;
            if (partyType === 'customer') { // Customer perspective
                if (entry.type === 'debit_customer') { debit = entry.amount; balance += entry.amount; }
                if (entry.type === 'credit_customer') { credit = entry.amount; balance -= entry.amount; }
            } else { // Supplier perspective
                if (entry.type === 'credit_supplier') { credit = entry.amount; balance += entry.amount; }
                if (entry.type === 'debit_supplier') { debit = entry.amount; balance -= entry.amount; }
            }
            ledgerRows.push({ ...entry, debit, credit, balance: balance });
        }
        
        const finalBalance = balance;
        const balanceClass = finalBalance > 0 ? (partyType === 'customer' ? 'balance-due' : 'balance-payable') : '';
        const balanceText = finalBalance > 0 ? (partyType === 'customer' ? lang.receivable : lang.payable) : lang.balance;
        
        const entriesHtml = ledgerRows.length > 0
            ? `<table class="data-table" style="margin-top: 10px;">
                <thead><tr><th>${lang.dateColumn}</th><th>${lang.notes}</th><th class="debit-col">${lang.debit}</th><th class="credit-col">${lang.credit}</th><th>${lang.balance}</th><th>${lang.actionColumn}</th></tr></thead>
                <tbody>${ledgerRows.reverse().map(e => `
                    <tr>
                        <td>${new Date(e.date).toLocaleDateString()}</td>
                        <td>${e.notes || ''}</td>
                        <td class="debit-col">${e.debit > 0 ? `64${e.debit.toFixed(2)}` : ''}</td>
                        <td class="credit-col">${e.credit > 0 ? `64${e.credit.toFixed(2)}` : ''}</td>
                        <td>64${e.balance.toFixed(2)}</td>
                        <td>
                            <button class="action-button edit" onclick="app.editCashFlowEntryFromModal(${e.id}, '${partyType}', ${partyId}, '${partyName.replace(/'/g, "\\'")}')" ${e.notes.includes('Bill No:') || e.notes.includes('Purchase No:') ? 'disabled' : ''}>${lang.editBtn}</button>
                            <button class="action-button delete" onclick="app.deleteCashFlowEntry(${e.id}, '${partyType}', ${partyId}, '${partyName.replace(/'/g, "\\'")}')" ${e.notes.includes('Bill No:') || e.notes.includes('Purchase No:') ? 'disabled' : ''}>${lang.deleteBtn}</button>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>`
            : `<p style="text-align:center;font-style:italic;margin-top:10px;">No cash flow entries found.</p>`;
        
        const reminderButton = partyType === 'customer' && finalBalance > 0 
            ? `<button class="whatsapp-reminder-btn" onclick="app.sendWhatsAppReminder('${partyName.replace(/'/g, "\\'")}', '${retailer.customers.find(c=>c.id==partyId).phone}', ${finalBalance})">${lang.sendReminder}</button>` : '';

        return `
            <div style="margin-top: 25px; border-top: 2px solid var(--border-color); padding-top: 15px;">
                <h4>${lang.cashFlowLedger}</h4>
                ${entriesHtml}
                <div class="balance-display ${balanceClass}">
                    <span>${balanceText}: 64${finalBalance.toFixed(2)}</span>
                    ${reminderButton}
                </div>
                <div id="modal-cashflow-form-container" class="history-item" style="margin-top: 20px;">
                    <h5 id="modal-cashflow-form-title" style="border:none;">${lang.addPayment}</h5>
                    <form onsubmit="app.addCashFlowFromModal(event, '${partyType}', ${partyId}, '${partyName.replace(/'/g, "\\'")}')">
                        <label>${lang.notes}</label><input type="text" class="modal-cashflow-notes" required>
                        <label>${lang.amountColumn}</label><input type="number" class="modal-cashflow-amount" required min="0.01" step="0.01">
                        <button type="submit" class="action-button view modal-cashflow-submit-btn" style="width:100%">${lang.addEntry}</button>
                    </form>
                </div>
            </div>`;
    };
    
    app.sendWhatsAppReminder = (customerName, customerPhone, balance) => {
        const lang = translations[currentLanguage];
        const retailer = allRetailerData[currentUserEmail];
        const message = lang.reminderMessage
            .replace('{customerName}', customerName)
            .replace('{balance}', balance.toFixed(2))
            .replace('{shopName}', retailer.shopDetails.name);
        
        let phone = customerPhone.replace(/[^0-9]/g, '');
        if (phone.length === 10) phone = '91' + phone;

        const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    };

    app.addCashFlowFromModal = (event, partyType, partyId, partyName) => {
        event.preventDefault();
        const form = event.target;
        const retailer = allRetailerData[currentUserEmail];
        const amount = parseFloat(form.querySelector('.modal-cashflow-amount').value);
        const notes = form.querySelector('.modal-cashflow-notes').value.trim();
        const lang = translations[currentLanguage];

        if (isNaN(amount) || amount <= 0) {
            alert(lang.fillAllFields);
            return;
        }

        if (editingCashFlowId) {
            const entryToUpdate = retailer.cashFlow.find(e => e.id === editingCashFlowId);
            if (entryToUpdate) {
                Object.assign(entryToUpdate, { amount, notes });
            }
            editingCashFlowId = null;
            form.querySelector('.modal-cashflow-submit-btn').innerText = lang.addEntry;
            document.getElementById('modal-cashflow-form-title').innerText = lang.addPayment;
        } else {
            if (!Array.isArray(retailer.cashFlow)) retailer.cashFlow = [];
            const entryType = partyType === 'customer' ? 'credit_customer' : 'debit_supplier';
            retailer.cashFlow.push({ id: Date.now(), type: entryType, amount, partyId: `${partyType}-${partyId}`, date: new Date().toISOString(), notes });
        }
        
        saveData();
        form.reset();
        renderCashFlow(); 
        if (partyType === 'customer') {
            app.showSalesHistoryForCustomer(partyId);
        } else if (partyType === 'supplier') {
            app.showPurchaseHistoryForSupplier(partyId);
        }
    };
    
    app.editCashFlowEntryFromModal = (entryId, partyType, partyId, partyName) => {
        const retailer = allRetailerData[currentUserEmail];
        const entry = retailer.cashFlow.find(e => e.id === entryId);
        if (!entry) return;

        editingCashFlowId = entryId;
        const lang = translations[currentLanguage];
        const formContainer = document.getElementById('modal-cashflow-form-container');

        formContainer.querySelector('.modal-cashflow-amount').value = entry.amount;
        formContainer.querySelector('.modal-cashflow-notes').value = entry.notes || '';
        
        formContainer.querySelector('#modal-cashflow-form-title').innerText = lang.editBtn + ' ' + lang.addPayment;
        formContainer.querySelector('.modal-cashflow-submit-btn').innerText = lang.updateBtn;
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    app.deleteCashFlowEntry = (entryId, partyType, partyId, partyName) => {
         if (confirm(translations[currentLanguage].deleteConfirm)) {
            const retailer = allRetailerData[currentUserEmail];
            retailer.cashFlow = retailer.cashFlow.filter(e => e.id !== entryId);
            saveData();
            renderCashFlow(); // Refresh main cashflow tab data
            // Refresh the modal content
            if (partyType === 'customer') {
                app.showSalesHistoryForCustomer(partyId);
            } else if (partyType === 'supplier') {
                app.showPurchaseHistoryForSupplier(partyId);
            }
        }
    };


    const handleThemeToggle = (e) => {
        const isChecked = e.target.checked;
        document.body.classList.toggle('dark-mode', isChecked);
        localStorage.setItem('theme', isChecked ? 'dark' : 'light');
        document.getElementById('theme-toggle-sidebar').checked = isChecked;
    };
    
    // --- 1314151912141919 111019151218 ---
    const resetEstimateForm = () => {
        currentEstimateItems = [];
        document.getElementById('estimateCustomerDetailsForm').reset();
        document.getElementById('currentEstimateBody').innerHTML = '';
        document.getElementById('estimateGrandTotalDisplay').innerText = '0.00';
    };

    const updateEstimateDisplay = () => {
        let grandTotal = 0;
        document.getElementById('currentEstimateBody').innerHTML = currentEstimateItems.map(item => {
            const total = item.price * item.quantity;
            grandTotal += total;
            return `<tr><td>${item.name}</td><td>${item.quantity} ${item.unit}</td><td>64${item.price.toFixed(2)}</td><td>64${total.toFixed(2)}</td></tr>`;
        }).join('');
        document.getElementById('estimateGrandTotalDisplay').innerText = grandTotal.toFixed(2);
    };

    const handleAddItemToEstimate = () => {
        const lang = translations[currentLanguage];
        const product = productForCalculator;
        const quantity = parseFloat(document.getElementById('estimateCalcQuantity').value);
        const price = parseFloat(document.getElementById('estimateCalcPrice').value);

        if (!product || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
            alert(lang.fillAllFields);
            return;
        }

        currentEstimateItems.push({ ...product, quantity, price });
        updateEstimateDisplay();
        document.getElementById('estimate-item-details-calculator').classList.add('hidden');
        document.getElementById('estimateProductSearchInput').value = '';
    };

    const handleGenerateEstimate = () => {
        if (currentEstimateItems.length === 0) { alert(translations[currentLanguage].addItemsToBill); return; }
        // For now, this just opens the print preview for the estimate
        const retailer = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        const customerName = document.getElementById('estimateCustomerName').value.trim();
        const customerPhone = document.getElementById('estimateCustomerPhone').value.trim();
        const customerAddress = document.getElementById('estimateCustomerAddress').value.trim();
        
        if (!customerName || !customerPhone) { alert(translations[currentLanguage].customerInfoRequired); return; }
        
        const grandTotal = currentEstimateItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const today = new Date();
        const pad = (n) => n.toString().padStart(2, '0');
        const estimateId = `EST-${today.getFullYear()}${pad(today.getMonth() + 1)}${pad(today.getDate())}-${estimateCounter++}`;

        const estimateHTML = `
            <div style="background-color: #fff; color: #000; padding: 15px; font-family:'Courier New', monospace;">
            <div style="text-align:center;">
                <h2 style="border:none; margin-bottom: 5px;">${lang.estimateTab.toUpperCase()}</h2>
                <img src="${retailer.shopDetails.logo || ''}" style="max-height:80px; margin-bottom: 5px;">
                <h3 style="margin:5px 0; font-weight:bold;">${retailer.shopDetails.name}</h3>
                <p style="margin:2px 0; font-size: 12px;">${retailer.shopDetails.address}</p>
                 <hr style="border:1px dashed #333; margin: 8px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                    <span>${lang.estimateNo} ${estimateId}</span>
                    <span>${lang.estimateDate}: ${today.toLocaleDateString()}</span>
                </div>
            </div>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <p><strong>To:</strong> ${customerName}, ${customerPhone}</p>
            <p><strong>Address:</strong> ${customerAddress}</p>
            <hr style="border:1px dashed #333; margin: 8px 0;">
             <table style="width:100%; font-size:12px; border-collapse:collapse;">
                <thead><tr><th style="text-align:left;">${lang.productColumn}</th><th style="text-align:center;">${lang.quantityColumn}</th><th style="text-align:right;">${lang.priceColumn}</th><th style="text-align:right;">${lang.totalColumn}</th></tr></thead>
                <tbody>${currentEstimateItems.map(item => `<tr><td>${item.name}</td><td style="text-align:center;">${item.quantity} ${item.unit}</td><td style="text-align:right;">64${item.price.toFixed(2)}</td><td style="text-align:right;">64${(item.price * item.quantity).toFixed(2)}</td></tr>`).join('')}</tbody>
            </table>
            <hr style="border:1px dashed #333; margin: 8px 0;">
            <div style="text-align:right;font-size:1.2em;font-weight:bold;">${lang.grandTotal}: 64${grandTotal.toFixed(2)}</div>
            </div>
        `;
        
        const previewModal = document.getElementById('print-preview-modal');
        document.getElementById('print-preview-content').innerHTML = estimateHTML;
        document.querySelector('input[name="paper-size"][value="a4"]').checked = true;
        document.getElementById('print-preview-content').className = 'preview-a4';
        previewModal.style.display = 'block';

        localStorage.setItem('estimateCounter', estimateCounter);
        resetEstimateForm();
    };

    const attachAllEventListeners = () => {
        document.getElementById('goToLoginBtn').addEventListener('click', () => showPage('login-page'));
        document.getElementById('goToSignUpBtn').addEventListener('click', () => showPage('signup-page'));
        document.getElementById('loginBackBtn').addEventListener('click', () => showPage('welcome-page'));
        document.getElementById('signupBackBtn').addEventListener('click', () => showPage('welcome-page'));
        document.getElementById('logoutBtnSidebar').addEventListener('click', logout);
        
        document.getElementById('headerSettingsBtn').addEventListener('click', () => {
             document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
             document.querySelector('.tab-link[data-tab="profile"]').classList.add('active');
             document.getElementById('profile-sidebar').classList.add('open');
             document.getElementById('sidebar-overlay').classList.remove('hidden');
        });
        
        document.getElementById('appTabsContainer').addEventListener('click', (e) => {
            if (e.target.matches('.tab-link')) {
                const tabName = e.target.dataset.tab;
                if (tabName === 'profile') {
                    document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById('profile-sidebar').classList.add('open');
                    document.getElementById('sidebar-overlay').classList.remove('hidden');
                } else if (tabName) {
                    showTab(tabName);
                }
            }
        });

        document.getElementById('closeProfileSidebarBtn').addEventListener('click', closeProfileSidebar);
        document.getElementById('sidebar-overlay').addEventListener('click', closeProfileSidebar);
        
        document.getElementById('language-select').addEventListener('change', (e) => setLanguage(e.target.value));

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('signupForm').addEventListener('submit', handleSignup);
        
        document.getElementById('addItemToBillBtn').addEventListener('click', handleAddItemToBillFromCalculator);
        document.getElementById('addServiceToBillBtn').addEventListener('click', handleAddServiceToBill);

        document.getElementById('printStockBtn').addEventListener('click', handlePrintStock);
        document.getElementById('saveStockPdfBtn').addEventListener('click', handleSaveStockPdf);
        document.getElementById('saveProfileBtn').addEventListener('click', handleSaveProfile);
        document.getElementById('generateBillBtn').addEventListener('click', handleGenerateBill);
        document.getElementById('addExpenseForm').addEventListener('submit', handleAddExpense);
        document.getElementById('addCashFlowForm').addEventListener('submit', handleAddCashFlow);
        document.getElementById('addPurchaseItemForm').addEventListener('submit', handleAddPurchaseEntry);

        document.getElementById('createBackupBtn').addEventListener('click', handleCreateBackup);
        document.getElementById('restoreBackupBtn').addEventListener('click', () => document.getElementById('restoreFileInput').click());
        document.getElementById('restoreFileInput').addEventListener('change', handleRestoreBackup);
        
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); showPage('reset-password-page'); });
        document.getElementById('resetBackBtn').addEventListener('click', () => showPage('login-page'));
        document.getElementById('verifyEmailBtn').addEventListener('click', handleVerifyEmail);
        document.getElementById('resetPasswordForm').addEventListener('submit', handleResetPassword);

        document.getElementById('addSupplierForm').addEventListener('submit', handleAddSupplier);
        document.getElementById('addCustomerForm').addEventListener('submit', handleAddCustomer);
        
        document.getElementById('salesHistoryFromDate').addEventListener('input', renderRecentSales);
        document.getElementById('salesHistoryToDate').addEventListener('input', renderRecentSales);
        document.getElementById('purchaseHistoryFromDate').addEventListener('input', renderPurchaseHistory);
        document.getElementById('purchaseHistoryToDate').addEventListener('input', renderPurchaseHistory);

        document.querySelectorAll('input[name="gstType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const gstField = document.getElementById('gst-field-container');
                if (e.target.value === 'with_gst') {
                    gstField.classList.remove('hidden');
                } else {
                    gstField.classList.add('hidden');
                    document.getElementById('purchaseGstPercent').value = 0;
                }
                calculatePurchasePrices('gst');
            });
        });

        document.getElementById('purchaseBasePrice').addEventListener('input', () => calculatePurchasePrices('base'));
        document.getElementById('purchaseGstPercent').addEventListener('input', () => calculatePurchasePrices('base'));
        document.getElementById('purchaseTotalPrice').addEventListener('input', () => calculatePurchasePrices('total'));
        document.getElementById('purchaseProfitMarginValue').addEventListener('input', () => calculatePurchasePrices('profit'));
        document.getElementById('purchaseProfitMarginType').addEventListener('change', () => calculatePurchasePrices('profit'));


        document.querySelectorAll('input[name="serviceGstType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const gstField = document.getElementById('service-gst-field-container');
                if (e.target.value === 'with_gst') {
                    gstField.classList.remove('hidden');
                } else {
                    gstField.classList.add('hidden');
                    document.getElementById('serviceGstPercent').value = 0;
                }
            });
        });

        document.querySelectorAll('input[name="itemType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const productFields = document.getElementById('product-fields');
                const serviceFields = document.getElementById('service-fields');
                if (e.target.value === 'product') {
                    productFields.classList.remove('hidden');
                    serviceFields.classList.add('hidden');
                } else {
                    productFields.classList.add('hidden');
                    serviceFields.classList.remove('hidden');
                    resetItemCalculator();
                }
            });
        });
        
        ['calcQuantity', 'calcGstPercent'].forEach(id => document.getElementById(id).addEventListener('input', () => calculateItemPrice('gst')));
        document.getElementById('calcBasePrice').addEventListener('input', () => calculateItemPrice('base'));
        document.getElementById('calcTotalPrice').addEventListener('input', () => calculateItemPrice('total'));

        
        ['discountInput', 'discountType'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateFinalTotal);
        });


        document.getElementById('downloadSalesPdfBtn').addEventListener('click', () => generateSalesReport('pdf'));
        document.getElementById('downloadSalesCsvBtn').addEventListener('click', () => generateSalesReport('csv'));
        document.getElementById('downloadPurchasePdfBtn').addEventListener('click', () => generatePurchaseReport('pdf'));
        document.getElementById('downloadPurchaseCsvBtn').addEventListener('click', () => generatePurchaseReport('csv'));
        document.getElementById('downloadStockReportPdfBtn').addEventListener('click', generateStockReportPdf);
        document.getElementById('downloadStockReportCsvBtn').addEventListener('click', generateStockReportCsv);
        document.getElementById('downloadCustomersPdfBtn').addEventListener('click', generateCustomerReportPdf);
        document.getElementById('downloadCustomersCsvBtn').addEventListener('click', generateCustomerReportCsv);
        
        // --- 14161514 15111910191514 ---
        const customerSearchInput = document.getElementById('billingCustomerName');
        const customerSearchResultsContainer = document.getElementById('customerSearchResultsContainer');
        customerSearchInput.addEventListener('input', () => {
            const searchTerm = customerSearchInput.value.toLowerCase().trim();
            customerSearchResultsContainer.innerHTML = ''; 
            if (searchTerm.length === 0) { customerSearchResultsContainer.classList.add('hidden'); return; }
            const matches = (allRetailerData[currentUserEmail]?.customers || []).filter(c => c.name.toLowerCase().includes(searchTerm) || c.phone.includes(searchTerm));
            if (matches.length > 0) {
                matches.forEach(customer => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-item';
                    itemDiv.textContent = `${customer.name} - ${customer.phone}`;
                    itemDiv.onclick = () => { document.getElementById('billingCustomerName').value = customer.name; document.getElementById('billingCustomerPhone').value = customer.phone; document.getElementById('billingCustomerAddress').value = customer.address || ''; customerSearchResultsContainer.classList.add('hidden'); };
                    customerSearchResultsContainer.appendChild(itemDiv);
                });
                customerSearchResultsContainer.classList.remove('hidden');
            } else { customerSearchResultsContainer.classList.add('hidden'); }
        });
        const productSearchInput = document.getElementById('productSearchInput');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        productSearchInput.addEventListener('input', () => {
            if (productForCalculator) { resetItemCalculator(); }
            const searchTerm = productSearchInput.value.toLowerCase();
            searchResultsContainer.innerHTML = '';
            if (searchTerm.length === 0) { searchResultsContainer.classList.add('hidden'); return; }
            const matches = (allRetailerData[currentUserEmail]?.inventory || []).filter(p => p.name.toLowerCase().includes(searchTerm) && p.quantity > 0);
            if (matches.length > 0) {
                const stockText = translations[currentLanguage].inStock;
                matches.forEach(product => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-item';
                    itemDiv.innerHTML = `${product.name} <small>(${stockText}: ${product.quantity} ${product.unit})</small>`;
                    itemDiv.onclick = () => { productSearchInput.value = product.name; searchResultsContainer.classList.add('hidden'); showItemCalculator(product); };
                    searchResultsContainer.appendChild(itemDiv);
                });
                searchResultsContainer.classList.remove('hidden');
            } else { searchResultsContainer.classList.add('hidden'); }
        });
        const supplierSearchInput = document.getElementById('purchaseSupplierName');
        const supplierSearchResultsContainer = document.getElementById('supplierPurchaseSearchResultsContainer');
        supplierSearchInput.addEventListener('input', () => {
             const searchTerm = supplierSearchInput.value.toLowerCase().trim();
             supplierSearchResultsContainer.innerHTML = '';
             if (searchTerm.length === 0) { supplierSearchResultsContainer.classList.add('hidden'); return; }
             const matches = (allRetailerData[currentUserEmail]?.suppliers || []).filter(s => s.name.toLowerCase().includes(searchTerm) || s.phone.includes(searchTerm));
             if(matches.length > 0) {
                 matches.forEach(supplier => {
                     const itemDiv = document.createElement('div');
                     itemDiv.className = 'search-item';
                     itemDiv.textContent = `${supplier.name} - ${supplier.phone}`;
                     itemDiv.onclick = () => {
                         document.getElementById('purchaseSupplierName').value = supplier.name;
                         document.getElementById('purchaseSupplierPhone').value = supplier.phone;
                         document.getElementById('purchaseSupplierAddress').value = supplier.address || '';
                         supplierSearchResultsContainer.classList.add('hidden');
                     };
                     supplierSearchResultsContainer.appendChild(itemDiv);
                 });
                 supplierSearchResultsContainer.classList.remove('hidden');
             } else {
                 supplierSearchResultsContainer.classList.add('hidden');
             }
        });
        const cashFlowSearchInput = document.getElementById('cashFlowPartySearch');
        const cashFlowSearchResults = document.getElementById('cashFlowSearchResultsContainer');
        const cashFlowPartyIdInput = document.getElementById('cashFlowPartyId');
        cashFlowSearchInput.addEventListener('input', () => {
            const searchTerm = cashFlowSearchInput.value.toLowerCase().trim();
            cashFlowSearchResults.innerHTML = '';
            cashFlowPartyIdInput.value = '';
            if (searchTerm.length === 0) { cashFlowSearchResults.classList.add('hidden'); return; }
            const retailer = allRetailerData[currentUserEmail];
            const customers = (retailer.customers || []).filter(c => c.name.toLowerCase().includes(searchTerm) || c.phone.includes(searchTerm));
            const suppliers = (retailer.suppliers || []).filter(s => s.name.toLowerCase().includes(searchTerm) || s.phone.includes(searchTerm));
            if (customers.length > 0 || suppliers.length > 0) {
                customers.forEach(c => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'search-item'; itemDiv.textContent = `[C] ${c.name} - ${c.phone}`;
                    itemDiv.onclick = () => { cashFlowSearchInput.value = c.name; cashFlowPartyIdInput.value = `customer-${c.id}`; cashFlowSearchResults.classList.add('hidden'); };
                    cashFlowSearchResults.appendChild(itemDiv);
                });
                suppliers.forEach(s => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'search-item'; itemDiv.textContent = `[S] ${s.name} - ${s.phone}`;
                    itemDiv.onclick = () => { cashFlowSearchInput.value = s.name; cashFlowPartyIdInput.value = `supplier-${s.id}`; cashFlowSearchResults.classList.add('hidden'); };
                    cashFlowSearchResults.appendChild(itemDiv);
                });
                cashFlowSearchResults.classList.remove('hidden');
            } else { cashFlowSearchResults.classList.add('hidden'); }
        });
        const estimateProductSearchInput = document.getElementById('estimateProductSearchInput');
        const estimateSearchResultsContainer = document.getElementById('estimateSearchResultsContainer');
        estimateProductSearchInput.addEventListener('input', () => {
            const searchTerm = estimateProductSearchInput.value.toLowerCase();
            estimateSearchResultsContainer.innerHTML = '';
            if (searchTerm.length === 0) { estimateSearchResultsContainer.classList.add('hidden'); return; }
            const matches = (allRetailerData[currentUserEmail]?.inventory || []);
            const lang = translations[currentLanguage];
            if (matches.length > 0) {
                matches.filter(p => p.name.toLowerCase().includes(searchTerm)).forEach(product => {
                    const itemDiv = document.createElement('div'); itemDiv.className = 'search-item';
                    itemDiv.textContent = product.name;
                    itemDiv.onclick = () => {
                        productForCalculator = product;
                        estimateSearchResultsContainer.classList.add('hidden');
                        document.getElementById('estimate-item-details-calculator').classList.remove('hidden');
                        document.getElementById('estimateCalculatorProductName').innerText = product.name;
                        document.getElementById('estimateCalcUnit').value = product.unit;
                        document.getElementById('estimateCalcPrice').value = product.price.toFixed(2);
                        document.getElementById('estimateCalcLineTotal').innerText = product.price.toFixed(2);
                    };
                    estimateSearchResultsContainer.appendChild(itemDiv);
                });
                estimateSearchResultsContainer.classList.remove('hidden');
            } else { estimateSearchResultsContainer.classList.add('hidden'); }
        });
        document.getElementById('estimateCalcQuantity').addEventListener('input', () => {
            const price = parseFloat(document.getElementById('estimateCalcPrice').value) || 0;
            const qty = parseFloat(document.getElementById('estimateCalcQuantity').value) || 1;
            document.getElementById('estimateCalcLineTotal').innerText = (price * qty).toFixed(2);
        });
        document.getElementById('estimateCalcPrice').addEventListener('input', () => {
            const price = parseFloat(document.getElementById('estimateCalcPrice').value) || 0;
            const qty = parseFloat(document.getElementById('estimateCalcQuantity').value) || 1;
            document.getElementById('estimateCalcLineTotal').innerText = (price * qty).toFixed(2);
        });

        document.getElementById('addItemToEstimateBtn').addEventListener('click', handleAddItemToEstimate);
        document.getElementById('generateEstimateBtn').addEventListener('click', handleGenerateEstimate);
        
        // Inventory Filter Listeners
        document.getElementById('inventorySearchInput').addEventListener('input', renderInventoryTable);
        document.getElementById('inventoryFromDate').addEventListener('change', renderInventoryTable);
        document.getElementById('inventoryToDate').addEventListener('change', renderInventoryTable);
        document.querySelectorAll('.column-toggle').forEach(toggle => {
            toggle.addEventListener('change', renderInventoryTable);
        });

        document.addEventListener('click', (e) => { 
            if (!e.target.closest('.search-container')) { 
                document.querySelectorAll('.search-results').forEach(el => el.classList.add('hidden'));
            } 
        });
        
        document.getElementById('closeBillModalBtn').addEventListener('click', (e) => {
            document.getElementById('bill-modal').style.display = 'none';
            if (e.target.dataset.isReprint !== "true") {
                localStorage.setItem('billCounter', billCounter);
                resetBillForm();
            }
            e.target.dataset.isReprint = "false";
            currentBillForModal = null;
        });
        
        document.getElementById('closeHistoryModalBtn').addEventListener('click', () => { document.getElementById('history-modal').style.display = 'none'; });

        document.getElementById('sendWhatsAppBtn').addEventListener('click', () => {
            const lang = translations[currentLanguage];
            if (!currentBillForModal) { alert(lang.noBillToShare); return; }
            const bill = currentBillForModal;
            const retailer = allRetailerData[currentUserEmail];
            const customer = retailer.customers.find(c => c.id == bill.customerId);
            if (!retailer || !customer) { alert(lang.noBillToShare); return; }
            
            const message = `*${retailer.shopDetails.name}*\n\n*${lang.customer}:* ${customer.name}\n*${lang.mobile}:* ${customer.phone}\n\n*${lang.billNo}:* ${bill.billNo}\n*${lang.date}:* ${bill.date} ${bill.time}\n----------------------------------\n${bill.items.map(item => `${item.name} (${item.type === 'product' ? item.quantity + ' ' + item.unit : ''}) - 64${item.total.toFixed(2)}`).join('\n')}\n----------------------------------\n${lang.subTotalBill} 64${bill.subTotal.toFixed(2)}\n${lang.totalGst}: +64${bill.totalGst.toFixed(2)}\n${lang.discountBill} -64${bill.discountAmount.toFixed(2)}\n\n*${lang.grandTotalBill}* *64${bill.total.toFixed(2)}*\n\n${lang.visitAgain} ${lang.thanksForShopping}\n\nPowered by My Billing App:\n${appLink}`;
            
            let customerPhone = customer.phone.replace(/[^0-9]/g, '');
            if (customerPhone.length === 10) customerPhone = '91' + customerPhone;

            const whatsappUrl = `https://wa.me/${customerPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });

        document.getElementById('shareBillImageBtn').addEventListener('click', () => {
            const billElement = document.getElementById('bill-to-print');
            const lang = translations[currentLanguage];
            if (!billElement) { alert(lang.noBillToShare); return; }
            const button = document.getElementById('shareBillImageBtn');
            const originalText = button.innerText;
            button.innerText = lang.preparing; button.disabled = true;
            html2canvas(billElement, { scale: 2.5, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                canvas.toBlob(function(blob) {
                    const file = new File([blob], 'bill.png', { type: 'image/png' });
                    const shareText = `${lang.thanksForShopping}\n\nDownload our app:\n${appLink}`;
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({ files: [file], title: lang.currentBill, text: shareText }).finally(() => { button.innerText = originalText; button.disabled = false; });
                    } else {
                        const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'bill.png';
                        document.body.appendChild(link); link.click(); document.body.removeChild(link);
                        alert(lang.imageDownloaded);
                        button.innerText = originalText; button.disabled = false;
                    }
                }, 'image/png');
            }).catch(err => { console.error("Image creation failed!", err); alert(lang.imageCreationFailed); button.innerText = originalText; button.disabled = false; });
        });

        // 101516111019 1015161211151514 15111910191514
        document.getElementById('printBillBtn').addEventListener('click', () => {
            const printPreviewModal = document.getElementById('print-preview-modal');
            const previewContent = document.getElementById('print-preview-content');
            const billHTML = document.getElementById('bill-to-print-container').innerHTML;
            previewContent.innerHTML = billHTML;
            document.querySelector('input[name="paper-size"][value="a4"]').checked = true; // Default to A4
            previewContent.className = 'preview-a4';
            printPreviewModal.style.display = 'block';
        });

        document.getElementById('close-print-preview-btn').addEventListener('click', () => {
            document.getElementById('print-preview-modal').style.display = 'none';
        });
        
        document.querySelectorAll('input[name="paper-size"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const size = e.target.value;
                const previewContent = document.getElementById('print-preview-content');
                previewContent.className = `preview-${size}`;
            });
        });

        document.getElementById('execute-print-btn').addEventListener('click', () => {
            const paperSize = document.querySelector('input[name="paper-size"]:checked').value;
            const billContentHTML = document.getElementById('print-preview-content').innerHTML;
            const printArea = document.querySelector('.printable-area-for-print');
            let styleText = '';

            switch (paperSize) {
                case '58mm':
                    styleText = `@page { size: 58mm auto; margin: 1.5mm; } body { margin: 0; } .printable-area-for-print { width: 55mm; font-size: 8pt !important; } .printable-area-for-print * { font-size: 8pt !important; }`;
                    break;
                case '80mm':
                    styleText = `@page { size: 80mm auto; margin: 2mm; } body { margin: 0; } .printable-area-for-print { width: 76mm; font-size: 10pt !important; } .printable-area-for-print * { font-size: 10pt !important; }`;
                    break;
                case 'a4':
                default:
                    styleText = `@page { size: A4; margin: 20mm; } body { margin: 0; }`;
                    break;
            }
            
            document.getElementById('dynamic-print-style').innerHTML = styleText;
            printArea.innerHTML = billContentHTML;
            
            window.print();
            
            printArea.innerHTML = ''; // Clean up after print
            document.getElementById('dynamic-print-style').innerHTML = '';
        });

        document.getElementById('theme-toggle-sidebar').addEventListener('change', handleThemeToggle);
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle-sidebar').checked = true;
        }
        
        const cropperModal = document.getElementById('cropper-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        
        document.querySelectorAll('.image-upload-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    currentCropTarget = e.target.dataset.target; // 'logo', 'signature', 'stamp'
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imageToCrop.src = event.target.result;
                        cropperModal.style.display = 'block';
                        if(cropper) cropper.destroy();
                        const aspectRatio = (currentCropTarget === 'logo') ? 1 : NaN; // Square for logo, free for others
                        cropper = new Cropper(imageToCrop, { aspectRatio: aspectRatio, viewMode: 1, background: false });
                    };
                    reader.readAsDataURL(files[0]);
                }
            });
        });

        document.getElementById('crop-and-save-btn').addEventListener('click', () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({ width: 250, height: 250 });
                const previewElId = `${currentCropTarget}Preview`;
                document.getElementById(previewElId).src = canvas.toDataURL('image/png');
                cropper.destroy();
                cropperModal.style.display = 'none';
                document.getElementById(`${currentCropTarget}Upload`).value = '';
            }
        });

        document.getElementById('close-cropper-modal-btn').addEventListener('click', () => {
            if(cropper) cropper.destroy();
            cropperModal.style.display = 'none';
            if(currentCropTarget) document.getElementById(`${currentCropTarget}Upload`).value = '';
        });
    };
    
    const generateSalesReport = (format) => {
        const retailer = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        let fromDate = document.getElementById('salesReportFromDate').value;
        let toDate = document.getElementById('salesReportToDate').value;
        if (!fromDate || !toDate) { alert(lang.fillAllFields); return; }
        fromDate = new Date(fromDate); fromDate.setHours(0, 0, 0, 0);
        toDate = new Date(toDate); toDate.setHours(23, 59, 59, 999);
        const filteredBills = (retailer.bills || []).filter(bill => { const [d, m, y] = bill.date.split('-'); return new Date(`${y}-${m}-${d}`) >= fromDate && new Date(`${y}-${m}-${d}`) <= toDate; });
        if (filteredBills.length === 0) { alert(lang.noDataFound); return; }
        const headers = [lang.billNo, lang.billDate, lang.customerName, lang.total];
        const data = filteredBills.map(bill => [bill.billNo, bill.date, (retailer.customers.find(c => c.id === bill.customerId) || {}).name || 'N/A', bill.total.toFixed(2)]);
        const reportTitle = `${lang.salesReportTitle} (${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()})`;
        if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(reportTitle, 14, 15);
            doc.autoTable({ head: [headers], body: data, startY: 20 });
            doc.save(`Sales-Report-${Date.now()}.pdf`);
        } else if (format === 'csv') {
            downloadCsv(`Sales-Report-${Date.now()}.csv`, headers, data.map(row => [row[0], row[1], row[2], row[3]]));
        }
    };
    
    const generatePurchaseReport = (format) => {
        const retailer = allRetailerData[currentUserEmail];
        const lang = translations[currentLanguage];
        let fromDate = document.getElementById('purchaseReportFromDate').value;
        let toDate = document.getElementById('purchaseReportToDate').value;
        if (!fromDate || !toDate) { alert(lang.fillAllFields); return; }
        fromDate = new Date(fromDate); fromDate.setHours(0, 0, 0, 0);
        toDate = new Date(toDate); toDate.setHours(23, 59, 59, 999);
        const filteredPurchases = (retailer.purchaseEntries || []).filter(entry => new Date(entry.date) >= fromDate && new Date(entry.date) <= toDate);
        if (filteredPurchases.length === 0) { alert(lang.noDataFound); return; }
        const headers = [lang.purchaseId, lang.date, lang.supplierName, lang.productName, lang.quantity, lang.totalColumn];
        const data = filteredPurchases.map(entry => {
            const supplier = (retailer.suppliers.find(s => s.id === entry.supplierId) || {}).name || 'N/A';
            const totalCost = ((entry.item.totalPrice || 0) * (entry.item.quantity || 0)).toFixed(2);
            return [entry.id, new Date(entry.date).toLocaleDateString(), supplier, entry.item.name, `${entry.item.quantity} ${entry.item.unit}`, totalCost];
        });
        const reportTitle = `${lang.purchaseReportTitle} (${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()})`;
        if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(reportTitle, 14, 15);
            doc.autoTable({ head: [headers], body: data, startY: 20 });
            doc.save(`Purchase-Report-${Date.now()}.pdf`);
        } else if (format === 'csv') {
            downloadCsv(`Purchase-Report-${Date.now()}.csv`, headers, data);
        }
    };

    const generateStockReportPdf = () => {
        const { jsPDF } = window.jspdf;
        const lang = translations[currentLanguage];
        const doc = new jsPDF();
        doc.text(lang.stockReport, 14, 15);
        const tableData = (allRetailerData[currentUserEmail].inventory || []).map(p => [p.name, p.price.toFixed(2), p.quantity, p.unit]);
        doc.autoTable({ head: [[lang.productColumn, lang.priceColumn, lang.quantityColumn, lang.unitLabel]], body: tableData, startY: 20 });
        doc.save(`${lang.stockReport}-${Date.now()}.pdf`);
    };

    const generateStockReportCsv = () => {
        const lang = translations[currentLanguage];
        const headers = [lang.productColumn, lang.priceColumn, lang.quantityColumn, lang.unitLabel];
        const data = (allRetailerData[currentUserEmail].inventory || []).map(p => [p.name, p.price.toFixed(2), p.quantity, p.unit]);
        downloadCsv(`Stock-Report-${Date.now()}.csv`, headers, data);
    };

    const generateCustomerReportPdf = () => {
        const { jsPDF } = window.jspdf;
        const lang = translations[currentLanguage];
        const doc = new jsPDF();
        doc.text(lang.customerList, 14, 15);
        const tableData = (allRetailerData[currentUserEmail].customers || []).map(c => [c.name, c.phone, c.address || '']);
        doc.autoTable({ head: [[lang.nameColumn, lang.phoneColumn, lang.customerAddress]], body: tableData, startY: 20 });
        doc.save(`Customer-List-${Date.now()}.pdf`);
    };
    
    const generateCustomerReportCsv = () => {
        const lang = translations[currentLanguage];
        const headers = [lang.nameColumn, lang.phoneColumn, lang.customerAddress];
        const data = (allRetailerData[currentUserEmail].customers || []).map(c => [c.name, c.phone, c.address || '']);
        downloadCsv(`Customer-List-${Date.now()}.csv`, headers, data);
    };

    // --- 1410 12131614 19161910 ---
    attachAllEventListeners();
    initializeApp();
});
</script>

</body>
</html>